<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Evaluation Hub - Complete Workflow</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .workflow-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .workflow-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            position: relative;
        }
        
        .workflow-steps::before {
            content: '';
            position: absolute;
            top: 30px;
            left: 10%;
            right: 10%;
            height: 2px;
            background: #e0e0e0;
            z-index: 0;
        }
        
        .step {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 1;
        }
        
        .step-number {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 24px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .step.active .step-number {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.1);
        }
        
        .step.completed .step-number {
            background: #4caf50;
            color: white;
        }
        
        .step-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .step-desc {
            font-size: 13px;
            color: #666;
        }
        
        .stage-content {
            display: none;
            animation: fadeIn 0.5s;
        }
        
        .stage-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-group textarea {
            min-height: 150px;
            resize: vertical;
        }
        
        .form-group small {
            display: block;
            margin-top: 5px;
            color: #666;
            font-size: 13px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .btn {
            padding: 14px 32px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        .workflow-choice {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }
        
        .choice-card {
            padding: 30px;
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .choice-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
        }
        
        .choice-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }
        
        .choice-card h3 {
            font-size: 24px;
            margin-bottom: 15px;
            color: #333;
        }
        
        .choice-card p {
            color: #666;
            line-height: 1.6;
        }
        
        .result-box {
            background: #f9f9f9;
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
        }
        
        .result-box h3 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .result-box pre {
            background: white;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 13px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .alert-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        
        .stage-intro {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
        }
        
        .stage-intro h2 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .stage-intro p {
            color: #666;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ LLM Evaluation Hub</h1>
            <p>å®Œæ•´çš„ RAG & Agent è©•ä¼°å·¥ä½œæµç¨‹</p>
        </div>
        
        <div class="workflow-container">
            <!-- Workflow Steps Indicator -->
            <div class="workflow-steps">
                <div class="step active" data-step="0">
                    <div class="step-number">1</div>
                    <div class="step-title">è§’è‰²&æ–‡ä»¶ç”Ÿæˆ</div>
                    <div class="step-desc">ç”Ÿæˆç”¨æˆ¶èˆ‡çŸ¥è­˜åº«</div>
                </div>
                <div class="step" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-title">é¸æ“‡æ¨¡å¼</div>
                    <div class="step-desc">RAG æˆ– Agent</div>
                </div>
                <div class="step" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-title">ç”Ÿæˆæ¸¬è©¦é›†</div>
                    <div class="step-desc">QA Pairs / Tasks</div>
                </div>
                <div class="step" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-title">è©•ä¼°</div>
                    <div class="step-desc">åŸ·è¡Œè©•ä¼°</div>
                </div>
            </div>
            
            <!-- Stage 0: Generate Personas and Documents -->
            <div class="stage-content active" id="stage-0">
                <div class="stage-intro">
                    <h2>éšæ®µ 1: ç”Ÿæˆç”¨æˆ¶è§’è‰²å’Œæƒ…å¢ƒæ–‡ä»¶</h2>
                    <p>æ ¹æ“šæ‚¨çš„ä½¿ç”¨æƒ…å¢ƒï¼Œç³»çµ±å°‡ä¸€æ¬¡æ€§ç”Ÿæˆç”¨æˆ¶è§’è‰²å’Œæƒ…å¢ƒæ–‡ä»¶ï¼Œç¢ºä¿å…§å®¹ä¸€è‡´æ€§å’Œå®Œæ•´æ€§ã€‚</p>
                </div>
                
                <form id="personas-form">
                    <div class="form-group">
                        <label for="scenario-description">ä½¿ç”¨æƒ…å¢ƒæè¿° *</label>
                        <textarea id="scenario-description" required 
                            placeholder="ä¾‹å¦‚ï¼šä¸€å€‹æˆ¿åœ°ç”¢åª’åˆå¹³å°ï¼Œé€£æ¥è³¼å±‹è€…å’Œè³£å±‹è€…ã€‚è³¼å±‹è€…å¯ä»¥æœå°‹ç¬¦åˆéœ€æ±‚çš„æˆ¿å±‹ï¼Œè³£å±‹è€…å¯ä»¥ä¸Šæ¶æˆ¿å±‹è³‡è¨Š..."></textarea>
                        <small>è«‹è©³ç´°æè¿°æ‚¨çš„ä½¿ç”¨æƒ…å¢ƒï¼ŒåŒ…æ‹¬ç›®æ¨™ç”¨æˆ¶ã€ä¸»è¦åŠŸèƒ½ã€ä½¿ç”¨å ´æ™¯ç­‰ã€‚</small>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="output-folder">è¼¸å‡ºè³‡æ–™å¤¾ *</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="text" id="output-folder" required 
                                    placeholder="/app/outputs/my_scenario" 
                                    value="/app/outputs/scenario_test"
                                    onblur="normalizeOutputFolderPath()"
                                    style="flex: 1;">
                                <button type="button" class="btn btn-secondary" onclick="checkExistingPersonas()" style="white-space: nowrap;">
                                    æª¢æŸ¥å·²æœ‰è³‡æ–™
                                </button>
                            </div>
                            <small>å¯ä»¥è¼¸å…¥å®¹å™¨è·¯å¾‘ï¼ˆå¦‚ <code>/app/outputs/scenario_test</code>ï¼‰ã€‚<br>
                            é»æ“Šã€Œæª¢æŸ¥å·²æœ‰è³‡æ–™ã€ä¾†è¼‰å…¥å·²å­˜åœ¨çš„è³‡æ–™ã€‚</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="scenario-name">æƒ…å¢ƒåç¨±ï¼ˆé¸å¡«ï¼‰</label>
                            <input type="text" id="scenario-name" 
                                placeholder="ä¾‹å¦‚ï¼šreal_estate_platform">
                            <small>ç•™ç©ºå‰‡è‡ªå‹•ç”Ÿæˆæ™‚é–“æˆ³è¨˜åç¨±ã€‚</small>
                        </div>
                    </div>
                    
                    <div id="existing-data-info" class="alert alert-info" style="display: none; margin-top: 20px;">
                        <!-- å·²å­˜åœ¨è³‡æ–™çš„ä¿¡æ¯å°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="num-personas">è§’è‰²æ•¸é‡</label>
                            <input type="number" id="num-personas" min="3" max="5" value="3">
                            <small>å»ºè­°ç”Ÿæˆ 3-5 å€‹è§’è‰²ä»¥ç²å¾—æ›´å¥½çš„å¤šæ¨£æ€§</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="num-documents">æ–‡ä»¶æ•¸é‡</label>
                            <input type="number" id="num-documents" min="1" max="20" value="1">
                            <small>å»ºè­° 1-5 ä»½æ ¸å¿ƒæ–‡ä»¶ï¼Œå°ˆæ³¨æ–¼ä½¿ç”¨è€…ä¸»è¦ä½¿ç”¨æƒ…å¢ƒã€‚</small>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="persona-model-provider">LLM æä¾›å•†</label>
                            <select id="persona-model-provider" onchange="onPersonaProviderChange()">
                                <option value="openai">OpenAI</option>
                                <option value="gemini">Google Gemini</option>
                                <option value="ollama">Ollama (æœ¬åœ°)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="persona-model-name">æ¨¡å‹åç¨±</label>
                            <select id="persona-model-name">
                                <option value="gpt-4o-mini">gpt-4o-mini</option>
                            </select>
                            <small id="persona-model-hint">å»ºè­°ä½¿ç”¨ GPT-4o-mini ä»¥ç²å¾—æ›´é«˜è³ªé‡çš„å…§å®¹ã€‚</small>
                        </div>
                    </div>
                    
                    <!-- API Key é…ç½® -->
                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-top: 15px; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #e65100;">ğŸ”‘ API Key é…ç½®ï¼ˆå¯é¸ï¼‰</h4>
                        <p style="margin: 0 0 15px 0; color: #666; font-size: 14px;">å¦‚æœæ‚¨æƒ³ä½¿ç”¨è‡ªå·±çš„ API Keyï¼Œè«‹åœ¨ä¸‹æ–¹è¼¸å…¥ã€‚ç•™ç©ºå‰‡ä½¿ç”¨ç³»çµ±é è¨­çš„ .env é…ç½®ã€‚</p>
                        
                        <div class="form-group" id="persona-openai-key-group" style="display: none;">
                            <label for="persona-openai-api-key">OpenAI API Key</label>
                            <input type="password" id="persona-openai-api-key" placeholder="sk-...ï¼ˆç•™ç©ºä½¿ç”¨ .env é…ç½®ï¼‰">
                            <small>ç”¨æ–¼ OpenAI æ¨¡å‹çš„è§’è‰²ç”Ÿæˆã€‚</small>
                        </div>
                        
                        <div class="form-group" id="persona-gemini-key-group" style="display: none;">
                            <label for="persona-gemini-api-key">Gemini API Key</label>
                            <input type="password" id="persona-gemini-api-key" placeholder="AI...ï¼ˆç•™ç©ºä½¿ç”¨ .env é…ç½®ï¼‰">
                            <small>ç”¨æ–¼ Gemini æ¨¡å‹çš„è§’è‰²ç”Ÿæˆã€‚</small>
                        </div>
                        
                        <div class="form-group" id="persona-ollama-url-group" style="display: none;">
                            <label for="persona-ollama-base-url">Ollama Base URL</label>
                            <input type="text" id="persona-ollama-base-url" placeholder="http://localhost:11434ï¼ˆç•™ç©ºä½¿ç”¨ .env é…ç½®ï¼‰">
                            <small>ç”¨æ–¼ Ollama æ¨¡å‹çš„è§’è‰²ç”Ÿæˆã€‚</small>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button type="submit" class="btn btn-primary" id="generate-personas-btn">
                            é–‹å§‹ç”Ÿæˆè§’è‰²å’Œæ–‡ä»¶
                        </button>
                    </div>
                </form>
                
                <div id="personas-result" class="result-box" style="display: none;"></div>
            </div>
            
            <!-- Stage 1: Generate Documents (Hidden - now merged with Stage 0) -->
            <div class="stage-content" id="stage-1" style="display: none !important;">
                <div class="stage-intro">
                    <h2>éšæ®µ 2: ç”Ÿæˆæƒ…å¢ƒæ–‡ä»¶</h2>
                    <p>æ ¹æ“šæ‚¨çš„ä½¿ç”¨æƒ…å¢ƒï¼Œç³»çµ±å°‡ç”Ÿæˆä»¥ä½¿ç”¨è€…ç‚ºæ ¸å¿ƒçš„çŸ¥è­˜æ–‡ä»¶ï¼Œå°ˆæ³¨æ–¼ä½¿ç”¨è€…æœƒç”¨åˆ°çš„ä¸»è¦æƒ…å¢ƒå’ŒåŠŸèƒ½ã€‚</p>
                </div>
                
                <form id="documents-form">
                    <div class="form-group">
                        <label>ç•¶å‰æƒ…å¢ƒ</label>
                        <textarea id="scenario-display" readonly style="background: #f9f9f9;"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="num-documents">æ–‡ä»¶æ•¸é‡</label>
                            <input type="number" id="num-documents" min="1" max="20" value="1">
                            <small>å»ºè­° 1-5 ä»½æ ¸å¿ƒæ–‡ä»¶ï¼Œå°ˆæ³¨æ–¼ä½¿ç”¨è€…ä¸»è¦ä½¿ç”¨æƒ…å¢ƒã€‚</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="doc-model-provider">LLM æä¾›å•†</label>
                            <select id="doc-model-provider">
                                <option value="openai">OpenAI</option>
                                <option value="gemini">Google Gemini</option>
                                <option value="ollama">Ollama (æœ¬åœ°)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="doc-model-name">æ¨¡å‹åç¨±</label>
                            <input type="text" id="doc-model-name" value="gpt-4">
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button type="button" class="btn btn-secondary" onclick="goToStage(0)">
                            ä¸Šä¸€æ­¥
                        </button>
                        <button type="submit" class="btn btn-primary" id="generate-documents-btn">
                            ç”Ÿæˆæ–‡ä»¶
                        </button>
                    </div>
                </form>
                
                <div id="documents-result" class="result-box" style="display: none;"></div>
            </div>
            
            <!-- Stage 2: Choose Workflow -->
            <div class="stage-content" id="stage-2">
                <div class="stage-intro">
                    <h2>éšæ®µ 3: é¸æ“‡è©•ä¼°æ¨¡å¼</h2>
                    <p>è«‹é¸æ“‡æ‚¨è¦è©•ä¼°çš„ç³»çµ±é¡å‹ã€‚å…©ç¨®æ¨¡å¼ä½¿ç”¨ç›¸åŒçš„è§’è‰²å’Œæ–‡ä»¶ï¼Œä½†ç”Ÿæˆä¸åŒé¡å‹çš„æ¸¬è©¦é›†ã€‚</p>
                </div>
                
                <div class="workflow-choice">
                    <div class="choice-card" onclick="selectWorkflow('rag')">
                        <h3>ğŸ” RAG æ¨¡å¼</h3>
                        <p>
                            ç”Ÿæˆå•ç­”å° (QA Pairs)ï¼Œæ¯å€‹å•é¡Œéƒ½å°æ‡‰ä¸€å€‹æœŸæœ›çš„è¼¸å‡ºã€‚
                            é©åˆè©•ä¼°æª¢ç´¢å¢å¼·ç”Ÿæˆç³»çµ±ï¼Œæ¸¬è©¦ç³»çµ±å°å–®æ¬¡å•é¡Œçš„å›ç­”è³ªé‡ã€‚
                        </p>
                        <p style="margin-top: 15px; font-weight: 600;">
                            è©•ä¼°æŒ‡æ¨™ï¼šæº–ç¢ºåº¦ã€ç›¸é—œæ€§ã€å¿ å¯¦åº¦ã€RAGAS æŒ‡æ¨™ç­‰
                        </p>
                    </div>
                    
                    <div class="choice-card" onclick="selectWorkflow('agent')">
                        <h3>ğŸ¤– Agent æ¨¡å¼</h3>
                        <p>
                            ç”Ÿæˆä»»å‹™å ´æ™¯ï¼Œå®šç¾©è§’è‰²çš„æœ€çµ‚ç›®æ¨™ã€‚
                            é©åˆè©•ä¼° Agent ç³»çµ±ï¼Œæ¸¬è©¦ç³»çµ±åœ¨å¤šè¼ªå°è©±ä¸­é”æˆç›®æ¨™çš„èƒ½åŠ›ã€‚
                        </p>
                        <p style="margin-top: 15px; font-weight: 600;">
                            è©•ä¼°æŒ‡æ¨™ï¼šç›®æ¨™é”æˆç‡ã€å°è©±è¼ªæ•¸ã€ä»»å‹™å®Œæˆåº¦ç­‰
                        </p>
                    </div>
                </div>
                
                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="goToStage(1)">
                        ä¸Šä¸€æ­¥
                    </button>
                </div>
            </div>
            
            <!-- Stage 3: Generate Testset (RAG/Agent) -->
            <div class="stage-content" id="stage-3">
                <!-- Will be populated dynamically based on workflow choice -->
            </div>
            
            <!-- Stage 4: Evaluation -->
            <div class="stage-content" id="stage-4">
                <div class="stage-intro">
                    <h2>éšæ®µ 4: åŸ·è¡Œè©•ä¼°</h2>
                    <p>é…ç½®æ‚¨è¦è©•ä¼°çš„ç³»çµ± APIï¼Œä½¿ç”¨ RAGAS æ¡†æ¶é€²è¡Œè‡ªå‹•åŒ–è©•ä¼°ã€‚</p>
                </div>
                
                <form id="evaluation-form">
                    <!-- æ¸¬è©¦é›†é¸æ“‡ -->
                    <div class="form-group">
                        <label for="testset-source">æ¸¬è©¦é›†ä¾†æº</label>
                        <select id="testset-source" onchange="toggleTestsetInput()">
                            <option value="workflow">ä½¿ç”¨å·¥ä½œæµç¨‹ç”Ÿæˆçš„æ¸¬è©¦é›†</option>
                            <option value="custom">é¸æ“‡è‡ªå®šç¾©æ¸¬è©¦é›† Excel</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="custom-testset-input" style="display: none;">
                        <label for="custom-testset-path">æ¸¬è©¦é›† Excel æª”æ¡ˆè·¯å¾‘</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="custom-testset-path" placeholder="è¼¸å…¥æ¸¬è©¦é›†æª”æ¡ˆè·¯å¾‘" style="flex: 1;" onblur="normalizeTestsetPath()">
                            <input type="file" id="testset-file-picker" accept=".xlsx,.xls" style="display: none;" onchange="handleTestsetFileSelect(event)">
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('testset-file-picker').click()" style="white-space: nowrap;">
                                ğŸ“ é¸æ“‡æª”æ¡ˆ
                            </button>
                        </div>
                        <small>é¸æ“‡åŒ…å«æ¸¬è©¦é›†çš„ Excel æª”æ¡ˆï¼ˆMac è·¯å¾‘æœƒè‡ªå‹•è½‰æ›ï¼‰ã€‚</small>
                    </div>
                    
                    <div id="testset-info" class="alert alert-info" style="display: none; margin-top: 15px;">
                        <!-- æ¸¬è©¦é›†è³‡è¨Šå°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
                    </div>
                    
                    <!-- å¾…è©•ä¼° API é…ç½® -->
                    <h3 style="margin-top: 30px; margin-bottom: 15px;">å¾…è©•ä¼°çš„ API é…ç½®</h3>
                    
                    <div class="form-group">
                        <label for="target-api-url">API ç«¯é» *</label>
                        <input type="text" id="target-api-url" required 
                            placeholder="https://your-api.com/chat">
                        <small>è¼¸å…¥æ‚¨è¦è©•ä¼°çš„ RAG/Agent ç³»çµ± API ç«¯é»ã€‚</small>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="target-api-method">HTTP æ–¹æ³•</label>
                            <select id="target-api-method">
                                <option value="POST">POST</option>
                                <option value="GET">GET</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="target-api-key-header">API Key Headerï¼ˆé¸å¡«ï¼‰</label>
                            <input type="text" id="target-api-key-header" placeholder="ä¾‹å¦‚: Authorization">
                            <small>å¦‚æœ API éœ€è¦é©—è­‰ï¼Œè¼¸å…¥ Header åç¨±ã€‚</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="target-api-key-value">API Key Valueï¼ˆé¸å¡«ï¼‰</label>
                            <input type="password" id="target-api-key-value" placeholder="ä¾‹å¦‚: Bearer your-token">
                            <small>API Key çš„å€¼ã€‚</small>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="target-api-question-field">å•é¡Œæ¬„ä½åç¨±</label>
                        <input type="text" id="target-api-question-field" value="question" placeholder="question">
                        <small>API è«‹æ±‚ body ä¸­å•é¡Œçš„æ¬„ä½åç¨±ï¼ˆä¾‹å¦‚ï¼šquestion, query, messageï¼‰ã€‚</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="target-api-response-field">å›ç­”æ¬„ä½è·¯å¾‘</label>
                        <input type="text" id="target-api-response-field" value="response" placeholder="response">
                        <small>API å›æ‡‰ä¸­ç­”æ¡ˆçš„æ¬„ä½è·¯å¾‘ï¼ˆä¾‹å¦‚ï¼šresponse, answer, data.messageï¼‰ã€‚</small>
                    </div>
                    
                    <!-- Judge LLM é…ç½® -->
                    <h3 style="margin-top: 30px; margin-bottom: 15px;">è©•ä¼°æ¨¡å‹é…ç½®ï¼ˆJudge LLMï¼‰</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="judge-model-provider">Judge LLM æä¾›å•†</label>
                            <select id="judge-model-provider" onchange="onJudgeProviderChange()">
                                <option value="openai">OpenAI</option>
                                <option value="gemini">Google Gemini</option>
                                <option value="ollama">Ollama (æœ¬åœ°)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="judge-model-name">Judge æ¨¡å‹åç¨±</label>
                            <select id="judge-model-name" style="width: 100%;">
                                <option value="gpt-4o-mini">gpt-4o-mini</option>
                            </select>
                            <small id="judge-model-hint">å»ºè­°ä½¿ç”¨ GPT-4o-miniã€‚</small>
                        </div>
                    </div>
                    
                    <!-- API Key é…ç½® -->
                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-top: 15px; margin-bottom: 15px;">
                        <h4 style="margin-bottom: 10px; color: #f57c00;">ğŸ”‘ API Key é…ç½®ï¼ˆå¯é¸ï¼‰</h4>
                        <p style="margin-bottom: 15px; font-size: 14px; color: #666;">
                            å¦‚æœæ‚¨æƒ³ä½¿ç”¨è‡ªå·±çš„ API Keyï¼Œè«‹åœ¨ä¸‹æ–¹è¼¸å…¥ã€‚ç•™ç©ºå‰‡ä½¿ç”¨ç³»çµ±é è¨­çš„ .env é…ç½®ã€‚
                        </p>
                        
                        <div class="form-group" id="judge-openai-key-group">
                            <label for="judge-openai-api-key">OpenAI API Key</label>
                            <input type="password" id="judge-openai-api-key" placeholder="sk-...ï¼ˆç•™ç©ºä½¿ç”¨ .env é…ç½®ï¼‰">
                            <small>ç”¨æ–¼ GPT-4 ç­‰ OpenAI æ¨¡å‹çš„è©•ä¼°ã€‚</small>
                        </div>
                        
                        <div class="form-group" id="judge-gemini-key-group" style="display: none;">
                            <label for="judge-gemini-api-key">Gemini API Key</label>
                            <input type="password" id="judge-gemini-api-key" placeholder="AI...ï¼ˆç•™ç©ºä½¿ç”¨ .env é…ç½®ï¼‰">
                            <small>ç”¨æ–¼ Gemini æ¨¡å‹çš„è©•ä¼°ã€‚</small>
                        </div>
                        
                        <div class="form-group" id="judge-ollama-url-group" style="display: none;">
                            <label for="judge-ollama-base-url">Ollama Base URL</label>
                            <input type="text" id="judge-ollama-base-url" placeholder="http://localhost:11434ï¼ˆç•™ç©ºä½¿ç”¨ .env é…ç½®ï¼‰">
                            <small>Ollama æœå‹™çš„ URLã€‚</small>
                        </div>
                    </div>
                    
                    <!-- è©•ä¼°æŒ‡æ¨™é¸æ“‡ -->
                    <h3 style="margin-top: 30px; margin-bottom: 20px;">ğŸ“Š è©•ä¼°æŒ‡æ¨™</h3>
                    
                    <!-- æ ¸å¿ƒæŒ‡æ¨™ -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                        <h4 style="margin: 0 0 15px 0; font-size: 18px;">ğŸ¯ æ ¸å¿ƒæŒ‡æ¨™ï¼ˆæ¨è–¦ï¼‰</h4>
                        
                        <div class="metric-item" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 12px; backdrop-filter: blur(10px);">
                            <label style="display: flex; align-items: center; cursor: pointer; margin: 0;">
                                <input type="checkbox" id="metric-answer-accuracy" checked style="margin-right: 12px; transform: scale(1.2);">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">Answer Accuracy</div>
                                    <div style="font-size: 14px; opacity: 0.9;">è©•ä¼°ç­”æ¡ˆçš„æº–ç¢ºæ€§</div>
                                </div>
                                <button type="button" onclick="toggleMetricDetails('answer-accuracy')" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">è©³æƒ…</button>
                            </label>
                            <div id="answer-accuracy-details" class="metric-details" style="display: none; margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 6px; font-size: 13px;">
                                <div><strong>è©³ç´°èªªæ˜ï¼š</strong>æª¢æŸ¥æ¨¡å‹æ˜¯å¦èƒ½æ­£ç¢ºå›ç­”å•é¡Œï¼ŒåŸºæ–¼æ¨™æº–ç­”æ¡ˆé€²è¡Œæ¯”è¼ƒã€‚</div>
                                <div style="margin-top: 8px;"><strong>åˆ†æ•¸ä½æ™‚å¯èª¿æ•´ï¼š</strong>System Promptã€LLM Temperatureã€æ¨¡å‹é¸æ“‡</div>
                            </div>
                        </div>
                        
                        <div class="metric-item" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 12px; backdrop-filter: blur(10px);">
                            <label style="display: flex; align-items: center; cursor: pointer; margin: 0;">
                                <input type="checkbox" id="metric-factual-correctness" checked style="margin-right: 12px; transform: scale(1.2);">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">Factual Correctness</div>
                                    <div style="font-size: 14px; opacity: 0.9;">æª¢æŸ¥å›æ‡‰æ˜¯å¦èˆ‡æ–‡ä»¶ä¸€è‡´</div>
                                </div>
                                <button type="button" onclick="toggleMetricDetails('factual-correctness')" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">è©³æƒ…</button>
                            </label>
                            <div id="factual-correctness-details" class="metric-details" style="display: none; margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 6px; font-size: 13px;">
                                <div><strong>è©³ç´°èªªæ˜ï¼š</strong>è©•ä¼°ç”Ÿæˆçš„å›æ‡‰æ˜¯å¦èˆ‡æä¾›çš„æ–‡ä»¶å…§å®¹ä¸€è‡´ï¼Œç„¡è‡†é€ è³‡è¨Šã€‚</div>
                                <div style="margin-top: 8px;"><strong>åˆ†æ•¸ä½æ™‚å¯èª¿æ•´ï¼š</strong>System Promptã€æ–‡ä»¶å“è³ªã€æª¢ç´¢ç­–ç•¥</div>
                            </div>
                        </div>
                        
                        <div class="metric-item" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 12px; backdrop-filter: blur(10px);">
                            <label style="display: flex; align-items: center; cursor: pointer; margin: 0;">
                                <input type="checkbox" id="metric-context-precision" checked style="margin-right: 12px; transform: scale(1.2);">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">Context Precision</div>
                                    <div style="font-size: 14px; opacity: 0.9;">æª¢ç´¢è³‡è¨Šçš„ç²¾ç¢ºåº¦</div>
                                </div>
                                <button type="button" onclick="toggleMetricDetails('context-precision')" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">è©³æƒ…</button>
                            </label>
                            <div id="context-precision-details" class="metric-details" style="display: none; margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 6px; font-size: 13px;">
                                <div><strong>è©³ç´°èªªæ˜ï¼š</strong>è©•ä¼°æª¢ç´¢åˆ°çš„è³‡è¨Šä¸­æœ‰å¤šå°‘æ¯”ä¾‹æ˜¯ç›¸é—œä¸”æ­£ç¢ºçš„ã€‚</div>
                                <div style="margin-top: 8px;"><strong>åˆ†æ•¸ä½æ™‚å¯èª¿æ•´ï¼š</strong>Chunk Sizeã€Overlapã€æª¢ç´¢ç®—æ³•ã€Embeddingæ¨¡å‹</div>
                            </div>
                        </div>
                        
                        <div class="metric-item" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 12px; backdrop-filter: blur(10px);">
                            <label style="display: flex; align-items: center; cursor: pointer; margin: 0;">
                                <input type="checkbox" id="metric-context-recall" checked style="margin-right: 12px; transform: scale(1.2);">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">Context Recall</div>
                                    <div style="font-size: 14px; opacity: 0.9;">æª¢ç´¢è³‡è¨Šçš„å®Œæ•´æ€§</div>
                                </div>
                                <button type="button" onclick="toggleMetricDetails('context-recall')" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">è©³æƒ…</button>
                            </label>
                            <div id="context-recall-details" class="metric-details" style="display: none; margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 6px; font-size: 13px;">
                                <div><strong>è©³ç´°èªªæ˜ï¼š</strong>è©•ä¼°æ¨™æº–ç­”æ¡ˆä¸­çš„è³‡è¨Šæœ‰å¤šå°‘è¢«æ­£ç¢ºæª¢ç´¢å’Œæ¶µè“‹ã€‚</div>
                                <div style="margin-top: 8px;"><strong>åˆ†æ•¸ä½æ™‚å¯èª¿æ•´ï¼š</strong>Chunk Sizeã€Overlapã€æª¢ç´¢æ•¸é‡ã€æ–‡ä»¶ç›¸ä¼¼åº¦é–€æª»</div>
                            </div>
                        </div>
                        
                        <div class="metric-item" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 0; backdrop-filter: blur(10px);">
                            <label style="display: flex; align-items: center; cursor: pointer; margin: 0;">
                                <input type="checkbox" id="metric-answer-correctness" checked style="margin-right: 12px; transform: scale(1.2);">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">Answer Correctness</div>
                                    <div style="font-size: 14px; opacity: 0.9;">ç¶œåˆæ­£ç¢ºæ€§ï¼ˆå«F1åˆ†æ•¸ï¼‰</div>
                                </div>
                                <button type="button" onclick="toggleMetricDetails('answer-correctness')" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">è©³æƒ…</button>
                            </label>
                            <div id="answer-correctness-details" class="metric-details" style="display: none; margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 6px; font-size: 13px;">
                                <div><strong>è©³ç´°èªªæ˜ï¼š</strong>Precisionèˆ‡Recallçš„ç¶œåˆå¹³è¡¡æŒ‡æ¨™ï¼Œæä¾›F1åˆ†æ•¸ã€‚</div>
                                <div style="margin-top: 8px;"><strong>åˆ†æ•¸ä½æ™‚å¯èª¿æ•´ï¼š</strong>æ•´é«”ç³»çµ±å„ªåŒ–ã€æ¨¡å‹å¾®èª¿ã€æª¢ç´¢ç­–ç•¥èª¿æ•´</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- é€²éšæŒ‡æ¨™ -->
                    <div style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); color: #333; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(255, 154, 158, 0.3);">
                        <h4 style="margin: 0 0 15px 0; font-size: 18px;">ğŸ” é€²éšæŒ‡æ¨™</h4>
                        
                        <div class="metric-item" style="background: rgba(255,255,255,0.3); padding: 15px; border-radius: 8px; margin-bottom: 12px; backdrop-filter: blur(10px);">
                            <label style="display: flex; align-items: center; cursor: pointer; margin: 0;">
                                <input type="checkbox" id="metric-faithfulness" style="margin-right: 12px; transform: scale(1.2);">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">Faithfulness</div>
                                    <div style="font-size: 14px; opacity: 0.8;">å›æ‡‰çš„å¿ å¯¦åº¦</div>
                        </div>
                                <button type="button" onclick="toggleMetricDetails('faithfulness')" style="background: rgba(255,255,255,0.4); border: none; color: #333; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">è©³æƒ…</button>
                            </label>
                            <div id="faithfulness-details" class="metric-details" style="display: none; margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.3); border-radius: 6px; font-size: 13px;">
                                <div><strong>è©³ç´°èªªæ˜ï¼š</strong>è©•ä¼°å›æ‡‰æ˜¯å¦å¿ å¯¦æ–¼æª¢ç´¢åˆ°çš„æ–‡ä»¶å…§å®¹ï¼Œé¿å…å¹»è¦ºã€‚</div>
                                <div style="margin-top: 8px;"><strong>åˆ†æ•¸ä½æ™‚å¯èª¿æ•´ï¼š</strong>System Promptã€æ¨¡å‹é¸æ“‡ã€æª¢ç´¢å“è³ª</div>
                        </div>
                        </div>
                        
                        <div class="metric-item" style="background: rgba(255,255,255,0.3); padding: 15px; border-radius: 8px; margin-bottom: 12px; backdrop-filter: blur(10px);">
                            <label style="display: flex; align-items: center; cursor: pointer; margin: 0;">
                                <input type="checkbox" id="metric-answer-relevancy" style="margin-right: 12px; transform: scale(1.2);">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">Answer Relevancy</div>
                                    <div style="font-size: 14px; opacity: 0.8;">å›æ‡‰çš„ç›¸é—œæ€§</div>
                                </div>
                                <button type="button" onclick="toggleMetricDetails('answer-relevancy')" style="background: rgba(255,255,255,0.4); border: none; color: #333; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">è©³æƒ…</button>
                            </label>
                            <div id="answer-relevancy-details" class="metric-details" style="display: none; margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.3); border-radius: 6px; font-size: 13px;">
                                <div><strong>è©³ç´°èªªæ˜ï¼š</strong>è©•ä¼°å›æ‡‰æ˜¯å¦èˆ‡å•é¡Œç›¸é—œï¼Œæ˜¯å¦å›ç­”äº†ç”¨æˆ¶çš„å•é¡Œã€‚</div>
                                <div style="margin-top: 8px;"><strong>åˆ†æ•¸ä½æ™‚å¯èª¿æ•´ï¼š</strong>System Promptã€å•é¡Œç†è§£ã€å›æ‡‰ç”Ÿæˆç­–ç•¥</div>
                            </div>
                        </div>
                        
                        <div class="metric-item" style="background: rgba(255,255,255,0.3); padding: 15px; border-radius: 8px; margin-bottom: 0; backdrop-filter: blur(10px);">
                            <label style="display: flex; align-items: center; cursor: pointer; margin: 0;">
                                <input type="checkbox" id="metric-response-relevancy" style="margin-right: 12px; transform: scale(1.2);">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">Response Relevancy</div>
                                    <div style="font-size: 14px; opacity: 0.8;">å›æ‡‰çš„æ•´é«”ç›¸é—œæ€§</div>
                                </div>
                                <button type="button" onclick="toggleMetricDetails('response-relevancy')" style="background: rgba(255,255,255,0.4); border: none; color: #333; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">è©³æƒ…</button>
                            </label>
                            <div id="response-relevancy-details" class="metric-details" style="display: none; margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.3); border-radius: 6px; font-size: 13px;">
                                <div><strong>è©³ç´°èªªæ˜ï¼š</strong>è©•ä¼°å›æ‡‰çš„æ•´é«”ç›¸é—œæ€§å’Œæœ‰ç”¨æ€§ã€‚</div>
                                <div style="margin-top: 8px;"><strong>åˆ†æ•¸ä½æ™‚å¯èª¿æ•´ï¼š</strong>æ¨¡å‹é¸æ“‡ã€Promptå·¥ç¨‹ã€å›æ‡‰é•·åº¦æ§åˆ¶</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="button-group" style="margin-top: 30px;">
                        <button type="button" class="btn btn-secondary" onclick="goToStage(3)">
                            ä¸Šä¸€æ­¥
                        </button>
                        <button type="submit" class="btn btn-primary" id="start-evaluation-btn">
                            é–‹å§‹è©•ä¼°
                        </button>
                    </div>
                </form>
                
                <div id="evaluation-result" class="result-box" style="display: none;"></div>
                <div id="evaluation-progress" class="result-box" style="display: none;">
                    <h3>è©•ä¼°é€²åº¦</h3>
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <strong>è©•ä¼°é€²åº¦</strong>
                            <span id="eval-progress-percent">0%</span>
                        </div>
                        <div style="width: 100%; height: 30px; background: #e0e0e0; border-radius: 15px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
                            <div id="eval-progress-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #4caf50, #8bc34a); transition: width 0.5s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;"></div>
                        </div>
                    </div>
                    <div id="progress-log" style="max-height: 400px; overflow-y: auto; background: #f5f5f5; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 14px;">
                        <!-- é€²åº¦æ—¥èªŒå°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let workflowState = {
            currentStage: 0,
            scenario_description: '',
            output_folder: '',
            scenario_name: '',
            personas_json_path: '',
            documents_folder: '',
            workflow_type: '' // 'rag' or 'agent'
        };
        
        // Function to convert Mac local path to container path
        function convertToContainerPath(path) {
            if (!path) return path;
            
            // Remove trailing slashes
            path = path.replace(/\/+$/, '');
            
            // If already a container path, return as is
            if (path.startsWith('/app/')) {
                return path;
            }
            
            // Common patterns to detect and convert
            const patterns = [
                // Match full project path
                {
                    regex: /^\/Users\/[^\/]+\/.*?\/llm-eval-hub\//,
                    replacement: '/app/'
                },
                // Match if path contains llm-eval-hub
                {
                    regex: /.*\/llm-eval-hub\//,
                    replacement: '/app/'
                },
                // Match relative paths
                {
                    regex: /^\.?\/?outputs\//,
                    replacement: '/app/outputs/'
                }
            ];
            
            for (const pattern of patterns) {
                if (pattern.regex.test(path)) {
                    const converted = path.replace(pattern.regex, pattern.replacement);
                    console.log(`è·¯å¾‘è½‰æ›: ${path} -> ${converted}`);
                    return converted;
                }
            }
            
            // If no pattern matched but looks like an absolute Mac path, try to extract relevant part
            if (path.startsWith('/Users/') && path.includes('/outputs/')) {
                const outputsIndex = path.indexOf('/outputs/');
                const converted = '/app' + path.substring(outputsIndex);
                console.log(`è·¯å¾‘è½‰æ›: ${path} -> ${converted}`);
                return converted;
            }
            
            return path;
        }
        
        // Normalize output folder path when user finishes editing
        function normalizeOutputFolderPath() {
            const input = document.getElementById('output-folder');
            const originalPath = input.value;
            const convertedPath = convertToContainerPath(originalPath);
            
            if (originalPath !== convertedPath) {
                input.value = convertedPath;
                // Show notification
                const notification = document.createElement('div');
                notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #4caf50; color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000; animation: slideIn 0.3s ease-out;';
                notification.innerHTML = `âœ… è·¯å¾‘å·²è‡ªå‹•è½‰æ›ï¼š<br><small>${originalPath}</small><br>â†’<br><small>${convertedPath}</small>`;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease-in';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
        }

        // Stage navigation
        function goToStage(stageNum) {
            // Update steps indicator
            document.querySelectorAll('.step').forEach((step, index) => {
                step.classList.remove('active');
                if (index < stageNum) {
                    step.classList.add('completed');
                } else if (index === stageNum) {
                    step.classList.add('active');
                } else {
                    step.classList.remove('completed');
                }
            });
            
            // Update content
            document.querySelectorAll('.stage-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`stage-${stageNum}`).classList.add('active');
            
            workflowState.currentStage = stageNum;
            
            // Update scenario display if moving to stage 1
            if (stageNum === 1) {
                document.getElementById('scenario-display').value = workflowState.scenario_description;
            }
        }

        // Handle personas form submission
        document.getElementById('personas-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const btn = document.getElementById('generate-personas-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> ç”Ÿæˆä¸­...';
            
            // Show progress area with progress bar
            const resultBox = document.getElementById('personas-result');
            resultBox.style.display = 'block';
            resultBox.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <strong>ç”Ÿæˆé€²åº¦</strong>
                        <span id="persona-progress-percent">0%</span>
                    </div>
                    <div style="width: 100%; height: 25px; background: #e0e0e0; border-radius: 12px; overflow: hidden;">
                        <div id="persona-progress-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;"></div>
                    </div>
                </div>
                <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 14px; max-height: 300px; overflow-y: auto;" id="persona-progress-log">
                    <div style="color: #1976d2; margin-bottom: 5px;">[${new Date().toLocaleTimeString('zh-TW')}] ğŸš€ é–‹å§‹ç”Ÿæˆç”¨æˆ¶è§’è‰²...</div>
                </div>
            `;
            
            const formData = {
                scenario_description: document.getElementById('scenario-description').value,
                num_personas: parseInt(document.getElementById('num-personas').value),
                output_folder: document.getElementById('output-folder').value,
                scenario_name: document.getElementById('scenario-name').value || null,
                model_provider: document.getElementById('persona-model-provider').value,
                model_name: document.getElementById('persona-model-name').value,
                language: 'ç¹é«”ä¸­æ–‡'
            };
            
            // Store in state
            workflowState.scenario_description = formData.scenario_description;
            workflowState.output_folder = formData.output_folder;
            workflowState.scenario_name = formData.scenario_name;
            
            // Helper to add log
            function addPersonaLog(message, type = 'info') {
                const log = document.getElementById('persona-progress-log');
                if (log) {
                    const color = type === 'error' ? '#d32f2f' : type === 'success' ? '#388e3c' : '#1976d2';
                    log.innerHTML += `<div style="color: ${color}; margin-bottom: 5px;">[${new Date().toLocaleTimeString('zh-TW')}] ${message}</div>`;
                    log.scrollTop = log.scrollHeight;
                }
            }
            
            // Progress update helper
            function updateProgress(percent, text = '') {
                const bar = document.getElementById('persona-progress-bar');
                const percentText = document.getElementById('persona-progress-percent');
                if (bar && percentText) {
                    bar.style.width = percent + '%';
                    bar.textContent = text || (percent + '%');
                    percentText.textContent = percent + '%';
                }
            }
            
            try {
                updateProgress(10, 'åˆå§‹åŒ–...');
                addPersonaLog(`ğŸ“ æº–å‚™ç”Ÿæˆ ${formData.num_personas} å€‹è§’è‰²...`);
                addPersonaLog(`ğŸ¤– ä½¿ç”¨æ¨¡å‹: ${formData.model_provider}/${formData.model_name}`);
                
                updateProgress(20, 'é€£æ¥ API...');
                
                // Simulate progress during API call
                const progressInterval = setInterval(() => {
                    const currentBar = document.getElementById('persona-progress-bar');
                    if (currentBar) {
                        const currentWidth = parseFloat(currentBar.style.width) || 20;
                        if (currentWidth < 80) {
                            updateProgress(currentWidth + 5, 'ç”Ÿæˆä¸­...');
                        }
                    }
                }, 2000);  // Update every 2 seconds
                
                const response = await fetch('/api/v1/testset/workflow/generate-personas', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                clearInterval(progressInterval);
                updateProgress(90, 'è™•ç†çµæœ...');
                
                const result = await response.json();
                
                addPersonaLog('â³ è™•ç† API å›æ‡‰...');
                
                if (result.success) {
                    updateProgress(100, 'âœ… å®Œæˆ');
                    addPersonaLog(`âœ… æˆåŠŸç”Ÿæˆ ${result.total_personas} å€‹è§’è‰²ï¼`, 'success');
                    addPersonaLog(`ğŸ’¾ ä¿å­˜è‡³: ${result.personas_folder}`);
                    
                    // Store paths
                    workflowState.personas_json_path = result.json_file;
                    workflowState.scenario_name = result.scenario_name;
                    
                    // Wait a bit for visual effect
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // Show result with improved persona preview
                    const resultBox = document.getElementById('personas-result');
                    resultBox.style.display = 'block';
                    
                    // Generate persona cards
                    let personaCards = '';
                    const personasToShow = result.personas_preview.slice(0, 3);
                    
                    personasToShow.forEach((persona, index) => {
                        personaCards += `
                            <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #f9f9f9;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <h4 style="margin: 0; color: #667eea;">
                                        ${persona.persona_name || persona.persona_id}
                                    </h4>
                                    <button type="button" class="btn btn-secondary" style="font-size: 12px; padding: 5px 10px;" 
                                        onclick="togglePersonaDetails('persona-${index}')">
                                        é¡¯ç¤ºæ›´å¤š
                                    </button>
                                </div>
                                
                                <!-- åŸºæœ¬æ‘˜è¦ -->
                                <div style="margin-bottom: 10px;">
                                    ${persona.basic_info ? `
                                        <p style="margin: 5px 0;"><strong>å¹´é½¡ï¼š</strong>${persona.basic_info.age || 'N/A'}</p>
                                        <p style="margin: 5px 0;"><strong>è·æ¥­ï¼š</strong>${persona.basic_info.occupation || 'N/A'}</p>
                                        <p style="margin: 5px 0;"><strong>å±…ä½åœ°ï¼š</strong>${persona.basic_info.location || 'N/A'}</p>
                                    ` : ''}
                                </div>
                                
                                <!-- è©³ç´°å…§å®¹ï¼ˆé è¨­æŠ˜ç–Šï¼‰ -->
                                <div id="persona-${index}" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                                    <pre style="background: white; padding: 10px; border-radius: 4px; font-size: 12px; max-height: 400px; overflow-y: auto;">${JSON.stringify(persona, null, 2)}</pre>
                                </div>
                            </div>
                        `;
                    });
                    
                    resultBox.innerHTML = `
                        <div class="alert alert-success">
                            âœ… æˆåŠŸç”Ÿæˆ ${result.total_personas} å€‹ç”¨æˆ¶è§’è‰²ï¼
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                            <div>
                                <h3>ç”Ÿæˆçµæœ</h3>
                                <p><strong>æƒ…å¢ƒåç¨±ï¼š</strong>${result.scenario_name}</p>
                                <p><strong>è§’è‰²æª”æ¡ˆä½ç½®ï¼š</strong>${result.personas_folder}</p>
                                <p><strong>Excel æ‘˜è¦ï¼š</strong>${result.excel_file}</p>
                                <p><strong>JSON å®Œæ•´æª”ï¼š</strong>${result.json_file}</p>
                            </div>
                        </div>
                        
                        <h4 style="margin-top: 20px; margin-bottom: 15px;">è§’è‰²é è¦½ï¼ˆå‰3å€‹ï¼‰ï¼š</h4>
                        ${personaCards}
                        
                        <div id="doc-generation-status" style="margin-top: 20px; padding: 15px; background: #f0f8ff; border-radius: 8px;">
                            <p>â³ æ­£åœ¨è‡ªå‹•ç”Ÿæˆæ–‡ä»¶...</p>
                        </div>
                    `;
                    
                    // Auto-generate documents after personas
                    setTimeout(() => generateDocumentsAfterPersonas(result.scenario_name), 1000);
                } else {
                    throw new Error(result.error || 'ç”Ÿæˆå¤±æ•—');
                }
            } catch (error) {
                const resultBox = document.getElementById('personas-result');
                resultBox.style.display = 'block';
                resultBox.innerHTML = `
                    <div class="alert alert-error">
                        âŒ éŒ¯èª¤ï¼š${error.message}
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.textContent = 'é–‹å§‹ç”Ÿæˆè§’è‰²';
            }
        });

        // Handle documents form submission
        document.getElementById('documents-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const btn = document.getElementById('generate-documents-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> ç”Ÿæˆä¸­...';
            
            const formData = {
                scenario_description: workflowState.scenario_description,
                num_documents: parseInt(document.getElementById('num-documents').value),
                output_folder: workflowState.output_folder,
                scenario_name: workflowState.scenario_name,
                model_provider: document.getElementById('doc-model-provider').value,
                model_name: document.getElementById('doc-model-name').value,
                language: 'ç¹é«”ä¸­æ–‡'
            };
            
            try {
                const response = await fetch('/api/v1/testset/workflow/generate-documents', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Store paths
                    workflowState.documents_folder = result.documents_folder;
                    
                    // Show result
                    const resultBox = document.getElementById('documents-result');
                    resultBox.style.display = 'block';
                    resultBox.innerHTML = `
                        <div class="alert alert-success">
                            âœ… æˆåŠŸç”Ÿæˆ ${result.total_documents} ä»½æ–‡ä»¶ï¼
                        </div>
                        <h3>ç”Ÿæˆçµæœ</h3>
                        <p><strong>æ–‡ä»¶è³‡æ–™å¤¾ï¼š</strong>${result.documents_folder}</p>
                        <p><strong>å…ƒæ•¸æ“šæª”æ¡ˆï¼š</strong>${result.metadata_file}</p>
                        <h4 style="margin-top: 20px;">æ–‡ä»¶é è¦½ï¼š</h4>
                        <pre>${JSON.stringify(result.documents_preview, null, 2)}</pre>
                        <div class="button-group" style="margin-top: 20px;">
                            <button type="button" class="btn btn-primary" onclick="goToStage(2)">
                                ä¸‹ä¸€æ­¥ï¼šé¸æ“‡å·¥ä½œæµç¨‹
                            </button>
                        </div>
                    `;
                } else {
                    throw new Error(result.error || 'ç”Ÿæˆå¤±æ•—');
                }
            } catch (error) {
                const resultBox = document.getElementById('documents-result');
                resultBox.style.display = 'block';
                resultBox.innerHTML = `
                    <div class="alert alert-error">
                        âŒ éŒ¯èª¤ï¼š${error.message}
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.textContent = 'ç”Ÿæˆæ–‡ä»¶';
            }
        });

        // Workflow selection
        function selectWorkflow(type) {
            workflowState.workflow_type = type;
            
            // Update visual selection
            document.querySelectorAll('.choice-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Populate stage 3 based on workflow type
            const stage3 = document.getElementById('stage-3');
            
            if (type === 'rag') {
                stage3.innerHTML = `
                    <div class="stage-intro">
                        <h2>éšæ®µ 4: ç”Ÿæˆ RAG æ¸¬è©¦é›†</h2>
                        <p>ä½¿ç”¨ç”Ÿæˆçš„è§’è‰²å’Œæ–‡ä»¶ï¼Œå‰µå»ºå•ç­”å°æ¸¬è©¦é›†ã€‚æ¯å€‹å•é¡Œéƒ½å°æ‡‰ä¸€å€‹ç‰¹å®šçš„è§’è‰²ã€‚</p>
                        <div style="margin-top: 15px;">
                            <button type="button" class="btn btn-secondary" onclick="checkExistingRAGTestset()" style="margin-right: 10px;">
                                ğŸ” æª¢æŸ¥å·²æœ‰æ¸¬è©¦é›†
                            </button>
                        </div>
                        <div id="rag-existing-testset-info" class="alert alert-info" style="display: none; margin-top: 15px;">
                            <!-- å·²å­˜åœ¨æ¸¬è©¦é›†çš„ä¿¡æ¯å°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
                        </div>
                    </div>
                    
                    <form id="rag-testset-form">
                        <div class="form-group">
                            <label for="rag-use-custom-docs">æ–‡ä»¶ä¾†æº</label>
                            <select id="rag-use-custom-docs" onchange="toggleRAGCustomDocsInput()">
                                <option value="workflow">ä½¿ç”¨å·¥ä½œæµç¨‹ç”Ÿæˆçš„æ–‡ä»¶ (${workflowState.documents_folder || 'æœªç”Ÿæˆ'})</option>
                                <option value="custom">ä½¿ç”¨è‡ªå®šç¾©è³‡æ–™å¤¾</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="rag-custom-docs-input" style="display: none;">
                            <label for="rag-custom-docs-folder">è‡ªå®šç¾©æ–‡ä»¶è³‡æ–™å¤¾è·¯å¾‘</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="text" id="rag-custom-docs-folder" placeholder="è¼¸å…¥æ–‡ä»¶è³‡æ–™å¤¾è·¯å¾‘" style="flex: 1;" onblur="normalizeRAGCustomDocsPath()">
                                <input type="file" id="rag-folder-picker" webkitdirectory directory multiple style="display: none;" onchange="handleRAGFolderSelect(event)">
                                <button type="button" class="btn btn-secondary" onclick="document.getElementById('rag-folder-picker').click()" style="white-space: nowrap;">
                                    ğŸ“ é¸æ“‡è³‡æ–™å¤¾
                                </button>
                            </div>
                            <div id="rag-folder-info" class="alert alert-info" style="display: none; margin-top: 10px;">
                                <!-- æ–‡ä»¶å¤¾é¸æ“‡ä¿¡æ¯å°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
                            </div>
                            <small>è¼¸å…¥åŒ…å«æ–‡å­—æª”æ¡ˆçš„è³‡æ–™å¤¾è·¯å¾‘ï¼Œæˆ–é»æ“ŠæŒ‰éˆ•é¸æ“‡æœ¬åœ°è³‡æ–™å¤¾ã€‚ç³»çµ±æœƒè®€å–æ‰€æœ‰ .txt, .md, .pdf ç­‰æ–‡ä»¶ã€‚</small>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="rag-chunk-size">æ–‡ä»¶åˆ†å¡Šå¤§å°</label>
                                <input type="number" id="rag-chunk-size" value="5000" min="100" max="20000">
                            </div>
                            
                            <div class="form-group">
                                <label for="rag-chunk-overlap">åˆ†å¡Šé‡ç–Š</label>
                                <input type="number" id="rag-chunk-overlap" value="200" min="0" max="1000">
                            </div>
                            
                            <div class="form-group">
                                <label for="rag-qa-per-chunk">æ¯å€‹åˆ†å¡Šçš„ QA æ•¸é‡</label>
                                <input type="number" id="rag-qa-per-chunk" value="3" min="1" max="10">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="rag-model-provider">LLM æä¾›å•†</label>
                                <select id="rag-model-provider" onchange="onRAGProviderChange()">
                                    <option value="openai">OpenAI</option>
                                    <option value="gemini">Google Gemini</option>
                                    <option value="ollama">Ollama (æœ¬åœ°)</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="rag-model-name">æ¨¡å‹åç¨±</label>
                            <select id="rag-model-name">
                                <option value="gpt-4o-mini">gpt-4o-mini</option>
                            </select>
                            <small id="rag-model-hint">å»ºè­°ä½¿ç”¨ GPT-4o-miniã€‚</small>
                            </div>
                        </div>
                        
                        <!-- API Key é…ç½® -->
                        <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-top: 15px; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0; color: #e65100;">ğŸ”‘ API Key é…ç½®ï¼ˆå¯é¸ï¼‰</h4>
                            <p style="margin: 0 0 15px 0; color: #666; font-size: 14px;">å¦‚æœæ‚¨æƒ³ä½¿ç”¨è‡ªå·±çš„ API Keyï¼Œè«‹åœ¨ä¸‹æ–¹è¼¸å…¥ã€‚ç•™ç©ºå‰‡ä½¿ç”¨ç³»çµ±é è¨­çš„ .env é…ç½®ã€‚</p>
                            
                            <div class="form-group" id="rag-openai-key-group" style="display: none;">
                                <label for="rag-openai-api-key">OpenAI API Key</label>
                                <input type="password" id="rag-openai-api-key" placeholder="sk-...ï¼ˆç•™ç©ºä½¿ç”¨ .env é…ç½®ï¼‰">
                                <small>ç”¨æ–¼ OpenAI æ¨¡å‹çš„æ¸¬è©¦é›†ç”Ÿæˆã€‚</small>
                            </div>
                            
                            <div class="form-group" id="rag-gemini-key-group" style="display: none;">
                                <label for="rag-gemini-api-key">Gemini API Key</label>
                                <input type="password" id="rag-gemini-api-key" placeholder="AI...ï¼ˆç•™ç©ºä½¿ç”¨ .env é…ç½®ï¼‰">
                                <small>ç”¨æ–¼ Gemini æ¨¡å‹çš„æ¸¬è©¦é›†ç”Ÿæˆã€‚</small>
                            </div>
                            
                            <div class="form-group" id="rag-ollama-url-group" style="display: none;">
                                <label for="rag-ollama-base-url">Ollama Base URL</label>
                                <input type="text" id="rag-ollama-base-url" placeholder="http://localhost:11434ï¼ˆç•™ç©ºä½¿ç”¨ .env é…ç½®ï¼‰">
                                <small>ç”¨æ–¼ Ollama æ¨¡å‹çš„æ¸¬è©¦é›†ç”Ÿæˆã€‚</small>
                            </div>
                        </div>
                        
                        <div class="button-group">
                            <button type="button" class="btn btn-secondary" onclick="goToStage(2)">
                                ä¸Šä¸€æ­¥
                            </button>
                            <button type="submit" class="btn btn-primary" id="generate-rag-testset-btn">
                                ç”Ÿæˆ RAG æ¸¬è©¦é›†
                            </button>
                        </div>
                    </form>
                    
                    <div id="rag-testset-result" class="result-box" style="display: none;"></div>
                `;
                
                // Add event listener for RAG testset form
                document.getElementById('rag-testset-form').addEventListener('submit', handleRAGTestsetSubmit);
            } else {
                stage3.innerHTML = `
                    <div class="stage-intro">
                        <h2>éšæ®µ 4: ç”Ÿæˆ Agent æ¸¬è©¦é›†</h2>
                        <p>ä½¿ç”¨ç”Ÿæˆçš„è§’è‰²å’Œæ–‡ä»¶ï¼Œå‰µå»ºä»»å‹™å ´æ™¯æ¸¬è©¦é›†ã€‚æ¯å€‹ä»»å‹™å°æ‡‰ä¸€å€‹è§’è‰²çš„ç›®æ¨™ã€‚</p>
                    </div>
                    
                    <form id="agent-testset-form">
                        <div class="form-group">
                            <label for="agent-use-custom-docs">æ–‡ä»¶ä¾†æº</label>
                            <select id="agent-use-custom-docs" onchange="toggleAgentCustomDocsInput()">
                                <option value="workflow">ä½¿ç”¨å·¥ä½œæµç¨‹ç”Ÿæˆçš„æ–‡ä»¶ (${workflowState.documents_folder || 'æœªç”Ÿæˆ'})</option>
                                <option value="custom">ä½¿ç”¨è‡ªå®šç¾©è³‡æ–™å¤¾</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="agent-custom-docs-input" style="display: none;">
                            <label for="agent-custom-docs-folder">è‡ªå®šç¾©æ–‡ä»¶è³‡æ–™å¤¾è·¯å¾‘</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="text" id="agent-custom-docs-folder" placeholder="è¼¸å…¥æ–‡ä»¶è³‡æ–™å¤¾è·¯å¾‘" style="flex: 1;" onblur="normalizeAgentCustomDocsPath()">
                                <input type="file" id="agent-folder-picker" webkitdirectory directory multiple style="display: none;" onchange="handleAgentFolderSelect(event)">
                                <button type="button" class="btn btn-secondary" onclick="document.getElementById('agent-folder-picker').click()" style="white-space: nowrap;">
                                    ğŸ“ é¸æ“‡è³‡æ–™å¤¾
                                </button>
                            </div>
                            <small>è¼¸å…¥åŒ…å«æ–‡å­—æª”æ¡ˆçš„è³‡æ–™å¤¾è·¯å¾‘ï¼Œæˆ–é»æ“ŠæŒ‰éˆ•é¸æ“‡æœ¬åœ°è³‡æ–™å¤¾ã€‚ç³»çµ±æœƒè®€å–æ‰€æœ‰ .txt, .md, .pdf ç­‰æ–‡ä»¶ã€‚</small>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="agent-chunk-size">æ–‡ä»¶åˆ†å¡Šå¤§å°</label>
                                <input type="number" id="agent-chunk-size" value="5000" min="100" max="20000">
                            </div>
                            
                            <div class="form-group">
                                <label for="agent-chunk-overlap">åˆ†å¡Šé‡ç–Š</label>
                                <input type="number" id="agent-chunk-overlap" value="200" min="0" max="1000">
                            </div>
                            
                            <div class="form-group">
                                <label for="agent-tasks-per-chunk">æ¯å€‹åˆ†å¡Šçš„ä»»å‹™æ•¸é‡</label>
                                <input type="number" id="agent-tasks-per-chunk" value="3" min="1" max="10">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="agent-model-provider">LLM æä¾›å•†</label>
                                <select id="agent-model-provider">
                                    <option value="openai">OpenAI</option>
                                    <option value="gemini">Google Gemini</option>
                                    <option value="ollama">Ollama (æœ¬åœ°)</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="agent-model-name">æ¨¡å‹åç¨±</label>
                                <input type="text" id="agent-model-name" value="gpt-3.5-turbo">
                            </div>
                        </div>
                        
                        <div class="button-group">
                            <button type="button" class="btn btn-secondary" onclick="goToStage(2)">
                                ä¸Šä¸€æ­¥
                            </button>
                            <button type="submit" class="btn btn-primary" id="generate-agent-testset-btn">
                                ç”Ÿæˆ Agent æ¸¬è©¦é›†
                            </button>
                        </div>
                    </form>
                    
                    <div id="agent-testset-result" class="result-box" style="display: none;"></div>
                `;
                
                // Add event listener for Agent testset form
                document.getElementById('agent-testset-form').addEventListener('submit', handleAgentTestsetSubmit);
            }
            
            // Advance to stage 3
            setTimeout(() => goToStage(3), 500);
        }

        // Toggle custom docs input for RAG
        function toggleRAGCustomDocsInput() {
            const useCustom = document.getElementById('rag-use-custom-docs').value === 'custom';
            document.getElementById('rag-custom-docs-input').style.display = useCustom ? 'block' : 'none';
        }
        
        // Toggle custom docs input for Agent
        function toggleAgentCustomDocsInput() {
            const useCustom = document.getElementById('agent-use-custom-docs').value === 'custom';
            document.getElementById('agent-custom-docs-input').style.display = useCustom ? 'block' : 'none';
        }
        
        // Normalize RAG custom docs path
        function normalizeRAGCustomDocsPath() {
            const input = document.getElementById('rag-custom-docs-folder');
            if (!input.value) return;
            
            const originalPath = input.value;
            const convertedPath = convertToContainerPath(originalPath);
            
            if (originalPath !== convertedPath) {
                input.value = convertedPath;
                showPathConversionNotification(originalPath, convertedPath);
            }
        }
        
        // Normalize Agent custom docs path
        function normalizeAgentCustomDocsPath() {
            const input = document.getElementById('agent-custom-docs-folder');
            if (!input.value) return;
            
            const originalPath = input.value;
            const convertedPath = convertToContainerPath(originalPath);
            
            if (originalPath !== convertedPath) {
                input.value = convertedPath;
                showPathConversionNotification(originalPath, convertedPath);
            }
        }
        
        // Show path conversion notification
        function showPathConversionNotification(originalPath, convertedPath) {
            const notification = document.createElement('div');
            notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #4caf50; color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000;';
            notification.innerHTML = `âœ… è·¯å¾‘å·²è‡ªå‹•è½‰æ›ï¼š<br><small>${originalPath}</small><br>â†’<br><small>${convertedPath}</small>`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Handle RAG folder selection
        function handleRAGFolderSelect(event) {
            const files = event.target.files;
            const infoDiv = document.getElementById('rag-folder-info');
            
            if (files.length > 0) {
                // Get the folder path from the first file
                const firstFile = files[0];
                const folderPath = firstFile.webkitRelativePath.split('/')[0];
                
                // Count different file types
                const fileTypes = {};
                Array.from(files).forEach(file => {
                    const ext = file.name.split('.').pop().toLowerCase();
                    fileTypes[ext] = (fileTypes[ext] || 0) + 1;
                });
                
                const fileTypeInfo = Object.entries(fileTypes)
                    .map(([ext, count]) => `${ext}: ${count}`)
                    .join(', ');
                
                infoDiv.innerHTML = `
                    <strong>ğŸ“ å·²é¸æ“‡è³‡æ–™å¤¾: ${folderPath}</strong><br>
                    <strong>ğŸ“„ åŒ…å« ${files.length} å€‹æª”æ¡ˆ</strong><br>
                    <strong>ğŸ“‹ æª”æ¡ˆé¡å‹: ${fileTypeInfo}</strong>
                `;
                infoDiv.style.display = 'block';
            } else {
                infoDiv.style.display = 'none';
            }
        }
        
        // Handle Agent folder selection
        function handleAgentFolderSelect(event) {
            const files = event.target.files;
            if (files.length > 0) {
                const firstFile = files[0];
                const folderPath = firstFile.webkitRelativePath.split('/')[0];
                alert(`å·²é¸æ“‡è³‡æ–™å¤¾ï¼š${folderPath}\nåŒ…å« ${files.length} å€‹æª”æ¡ˆ`);
            }
        }

        // Handle RAG testset submission
        async function handleRAGTestsetSubmit(e) {
            e.preventDefault();
            
            const btn = document.getElementById('generate-rag-testset-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> ç”Ÿæˆä¸­...';
            
            // Show progress
            const resultBox = document.getElementById('rag-testset-result');
            resultBox.style.display = 'block';
            resultBox.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <strong>RAG æ¸¬è©¦é›†ç”Ÿæˆé€²åº¦</strong>
                        <span id="rag-progress-percent">0%</span>
                    </div>
                    <div style="width: 100%; height: 25px; background: #e0e0e0; border-radius: 12px; overflow: hidden;">
                        <div id="rag-progress-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #2196f3, #03a9f4); transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;"></div>
                    </div>
                </div>
            `;
            
            function updateRAGProgress(percent, text = '') {
                const bar = document.getElementById('rag-progress-bar');
                const percentText = document.getElementById('rag-progress-percent');
                if (bar && percentText) {
                    bar.style.width = percent + '%';
                    bar.textContent = text || (percent + '%');
                    percentText.textContent = percent + '%';
                }
            }
            
            // Determine documents folder
            const useCustom = document.getElementById('rag-use-custom-docs').value === 'custom';
            const documentsFolder = useCustom 
                ? document.getElementById('rag-custom-docs-folder').value 
                : workflowState.documents_folder;
            
            const formData = {
                documents_folder: documentsFolder,
                personas_json_path: workflowState.personas_json_path,
                output_folder: workflowState.output_folder,
                scenario_name: workflowState.scenario_name,
                model_provider: document.getElementById('rag-model-provider').value,
                model_name: document.getElementById('rag-model-name').value,
                language: 'ç¹é«”ä¸­æ–‡',
                chunk_size: parseInt(document.getElementById('rag-chunk-size').value),
                chunk_overlap: parseInt(document.getElementById('rag-chunk-overlap').value),
                qa_per_chunk: parseInt(document.getElementById('rag-qa-per-chunk').value)
            };
            
            try {
                updateRAGProgress(20, 'é€£æ¥ API...');
                
                // Simulate progress
                const ragProgressInterval = setInterval(() => {
                    const currentBar = document.getElementById('rag-progress-bar');
                    if (currentBar) {
                        const currentWidth = parseFloat(currentBar.style.width) || 20;
                        if (currentWidth < 80) {
                            updateRAGProgress(currentWidth + 4, 'ç”Ÿæˆ QA å°...');
                        }
                    }
                }, 3000);  // Update every 3 seconds
                
                const response = await fetch('/api/v1/testset/workflow/generate-rag-testset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                clearInterval(ragProgressInterval);
                updateRAGProgress(90, 'è™•ç†çµæœ...');
                
                const result = await response.json();
                
                if (result.success) {
                    updateRAGProgress(100, 'âœ… å®Œæˆ');
                    
                    // Store testset path in workflow state
                    workflowState.rag_testset_path = result.excel_path;
                    console.log('Saved RAG testset path:', result.excel_path);
                    
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    const resultBox = document.getElementById('rag-testset-result');
                    resultBox.style.display = 'block';
                    resultBox.innerHTML = `
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <strong>RAG æ¸¬è©¦é›†ç”Ÿæˆé€²åº¦</strong>
                                <span style="color: #4caf50;">100%</span>
                            </div>
                            <div style="width: 100%; height: 25px; background: #e0e0e0; border-radius: 12px; overflow: hidden;">
                                <div style="width: 100%; height: 100%; background: linear-gradient(90deg, #4caf50, #8bc34a); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">âœ… å®Œæˆ</div>
                            </div>
                        </div>
                        <div class="alert alert-success">
                            âœ… æˆåŠŸç”Ÿæˆ RAG æ¸¬è©¦é›†ï¼
                        </div>
                        <h3>ç”Ÿæˆçµæœ</h3>
                        <p><strong>Excel æª”æ¡ˆï¼š</strong>${result.excel_path}</p>
                        <p><strong>ç¸½ QA å°æ•¸ï¼š</strong>${result.total_qa_pairs}</p>
                        <p><strong>æ–‡ä»¶åˆ†å¡Šæ•¸ï¼š</strong>${result.total_chunks}</p>
                        <p><strong>åŸå§‹æ–‡ä»¶æ•¸ï¼š</strong>${result.total_documents}</p>
                        <p><strong>ä½¿ç”¨çš„è§’è‰²æ•¸ï¼š</strong>${result.personas_used}</p>
                        <div class="button-group" style="margin-top: 20px;">
                            <button type="button" class="btn btn-primary" onclick="goToStage(4)">
                                ä¸‹ä¸€æ­¥ï¼šé–‹å§‹è©•ä¼°
                            </button>
                        </div>
                    `;
                } else {
                    throw new Error(result.detail || 'ç”Ÿæˆå¤±æ•—');
                }
            } catch (error) {
                const resultBox = document.getElementById('rag-testset-result');
                resultBox.style.display = 'block';
                resultBox.innerHTML = `
                    <div class="alert alert-error">
                        âŒ éŒ¯èª¤ï¼š${error.message}
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.textContent = 'ç”Ÿæˆ RAG æ¸¬è©¦é›†';
            }
        }

        // Handle Agent testset submission
        async function handleAgentTestsetSubmit(e) {
            e.preventDefault();
            
            const btn = document.getElementById('generate-agent-testset-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> ç”Ÿæˆä¸­...';
            
            // Show progress
            const resultBox = document.getElementById('agent-testset-result');
            resultBox.style.display = 'block';
            resultBox.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <strong>Agent æ¸¬è©¦é›†ç”Ÿæˆé€²åº¦</strong>
                        <span id="agent-progress-percent">0%</span>
                    </div>
                    <div style="width: 100%; height: 25px; background: #e0e0e0; border-radius: 12px; overflow: hidden;">
                        <div id="agent-progress-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #9c27b0, #ba68c8); transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;"></div>
                    </div>
                </div>
            `;
            
            function updateAgentProgress(percent, text = '') {
                const bar = document.getElementById('agent-progress-bar');
                const percentText = document.getElementById('agent-progress-percent');
                if (bar && percentText) {
                    bar.style.width = percent + '%';
                    bar.textContent = text || (percent + '%');
                    percentText.textContent = percent + '%';
                }
            }
            
            // Determine documents folder
            const useCustom = document.getElementById('agent-use-custom-docs').value === 'custom';
            const documentsFolder = useCustom 
                ? document.getElementById('agent-custom-docs-folder').value 
                : workflowState.documents_folder;
            
            const formData = {
                documents_folder: documentsFolder,
                personas_json_path: workflowState.personas_json_path,
                output_folder: workflowState.output_folder,
                scenario_name: workflowState.scenario_name,
                model_provider: document.getElementById('agent-model-provider').value,
                model_name: document.getElementById('agent-model-name').value,
                language: 'ç¹é«”ä¸­æ–‡',
                chunk_size: parseInt(document.getElementById('agent-chunk-size').value),
                chunk_overlap: parseInt(document.getElementById('agent-chunk-overlap').value),
                tasks_per_chunk: parseInt(document.getElementById('agent-tasks-per-chunk').value)
            };
            
            try {
                updateAgentProgress(20, 'é€£æ¥ API...');
                
                // Simulate progress
                const agentProgressInterval = setInterval(() => {
                    const currentBar = document.getElementById('agent-progress-bar');
                    if (currentBar) {
                        const currentWidth = parseFloat(currentBar.style.width) || 20;
                        if (currentWidth < 80) {
                            updateAgentProgress(currentWidth + 4, 'ç”Ÿæˆä»»å‹™...');
                        }
                    }
                }, 3000);  // Update every 3 seconds
                
                const response = await fetch('/api/v1/testset/workflow/generate-agent-testset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                clearInterval(agentProgressInterval);
                updateAgentProgress(90, 'è™•ç†çµæœ...');
                
                const result = await response.json();
                
                if (result.success) {
                    updateAgentProgress(100, 'âœ… å®Œæˆ');
                    
                    // Store testset path in workflow state
                    workflowState.agent_testset_path = result.excel_path;
                    console.log('Saved Agent testset path:', result.excel_path);
                    
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    const resultBox = document.getElementById('agent-testset-result');
                    resultBox.style.display = 'block';
                    resultBox.innerHTML = `
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <strong>Agent æ¸¬è©¦é›†ç”Ÿæˆé€²åº¦</strong>
                                <span style="color: #4caf50;">100%</span>
                            </div>
                            <div style="width: 100%; height: 25px; background: #e0e0e0; border-radius: 12px; overflow: hidden;">
                                <div style="width: 100%; height: 100%; background: linear-gradient(90deg, #4caf50, #8bc34a); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">âœ… å®Œæˆ</div>
                            </div>
                        </div>
                        <div class="alert alert-success">
                            âœ… æˆåŠŸç”Ÿæˆ Agent æ¸¬è©¦é›†ï¼
                        </div>
                        <h3>ç”Ÿæˆçµæœ</h3>
                        <p><strong>Excel æª”æ¡ˆï¼š</strong>${result.excel_path}</p>
                        <p><strong>ç¸½ä»»å‹™æ•¸ï¼š</strong>${result.total_tasks}</p>
                        <p><strong>æ–‡ä»¶åˆ†å¡Šæ•¸ï¼š</strong>${result.total_chunks}</p>
                        <p><strong>åŸå§‹æ–‡ä»¶æ•¸ï¼š</strong>${result.total_documents}</p>
                        <p><strong>ä½¿ç”¨çš„è§’è‰²æ•¸ï¼š</strong>${result.personas_used}</p>
                        <div class="button-group" style="margin-top: 20px;">
                            <button type="button" class="btn btn-primary" onclick="goToStage(4)">
                                ä¸‹ä¸€æ­¥ï¼šé–‹å§‹è©•ä¼°
                            </button>
                        </div>
                    `;
                } else {
                    throw new Error(result.detail || 'ç”Ÿæˆå¤±æ•—');
                }
            } catch (error) {
                const resultBox = document.getElementById('agent-testset-result');
                resultBox.style.display = 'block';
                resultBox.innerHTML = `
                    <div class="alert alert-error">
                        âŒ éŒ¯èª¤ï¼š${error.message}
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.textContent = 'ç”Ÿæˆ Agent æ¸¬è©¦é›†';
            }
        }
        
        // Toggle persona details
        function togglePersonaDetails(personaId) {
            const detailsDiv = document.getElementById(personaId);
            const btn = event.target;
            
            if (detailsDiv.style.display === 'none') {
                detailsDiv.style.display = 'block';
                btn.textContent = 'æ”¶èµ·';
            } else {
                detailsDiv.style.display = 'none';
                btn.textContent = 'é¡¯ç¤ºæ›´å¤š';
            }
        }
        
        // Check for existing personas in the output folder
        async function checkExistingPersonas() {
            const outputFolder = document.getElementById('output-folder').value;
            const infoDiv = document.getElementById('existing-data-info');
            
            if (!outputFolder) {
                alert('è«‹å…ˆè¼¸å…¥è¼¸å‡ºè³‡æ–™å¤¾è·¯å¾‘');
                return;
            }
            
            infoDiv.innerHTML = '<p>ğŸ” æª¢æŸ¥ä¸­...</p>';
            infoDiv.style.display = 'block';
            
            try {
                const response = await fetch('/api/v1/testset/workflow/check-existing-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ output_folder: outputFolder })
                });
                
                const result = await response.json();
                
                if (result.has_personas) {
                    // Load existing personas
                    workflowState.personas_json_path = result.personas_json_path;
                    workflowState.scenario_name = result.scenario_name || 'existing_scenario';
                    workflowState.output_folder = outputFolder;
                    
                    // Show info with option to skip to next step
                    infoDiv.innerHTML = `
                        <div class="alert alert-success">
                            âœ… ç™¼ç¾å·²å­˜åœ¨çš„è§’è‰²è³‡æ–™ï¼
                            <p><strong>è§’è‰²æ•¸é‡ï¼š</strong>${result.total_personas}</p>
                            <p><strong>è§’è‰²æª”æ¡ˆï¼š</strong>${result.personas_json_path}</p>
                            <p><strong>æƒ…å¢ƒåç¨±ï¼š</strong>${result.scenario_name || 'N/A'}</p>
                            ${result.has_documents ? `<p><strong>æ–‡ä»¶è³‡æ–™å¤¾ï¼š</strong>${result.documents_folder}</p>` : ''}
                            <div class="button-group" style="margin-top: 15px;">
                                <button type="button" class="btn btn-primary" onclick="loadExistingData('${result.personas_json_path}', '${result.scenario_name}', ${result.has_documents}, '${result.documents_folder || ''}')">
                                    è¼‰å…¥è³‡æ–™ä¸¦è·³åˆ°ä¸‹ä¸€æ­¥
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="document.getElementById('existing-data-info').style.display='none'">
                                    é‡æ–°ç”Ÿæˆ
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    infoDiv.innerHTML = `
                        <div class="alert alert-info">
                            â„¹ï¸ æ­¤è³‡æ–™å¤¾ä¸‹æ²’æœ‰æ‰¾åˆ°å·²å­˜åœ¨çš„è§’è‰²è³‡æ–™ï¼Œæ‚¨å¯ä»¥é–‹å§‹ç”Ÿæˆæ–°çš„è§’è‰²ã€‚
                        </div>
                    `;
                    setTimeout(() => {
                        infoDiv.style.display = 'none';
                    }, 3000);
                }
            } catch (error) {
                infoDiv.innerHTML = `
                    <div class="alert alert-error">
                        âŒ æª¢æŸ¥å¤±æ•—ï¼š${error.message}
                    </div>
                `;
            }
        }
        
        // Load existing data and skip to next stage
        function loadExistingData(personasJsonPath, scenarioName, hasDocuments, documentsFolder) {
            // Update workflow state
            workflowState.personas_json_path = personasJsonPath;
            workflowState.scenario_name = scenarioName;
            workflowState.output_folder = document.getElementById('output-folder').value;
            
            if (hasDocuments && documentsFolder) {
                workflowState.documents_folder = documentsFolder;
                // Validate data integrity before proceeding
                validateDataIntegrity().then(isValid => {
                    if (isValid) {
                        // Skip to workflow selection
                        goToStage(2);
                    } else {
                        alert('è³‡æ–™ä¸å®Œæ•´ï¼Œè«‹é‡æ–°ç”Ÿæˆæˆ–æª¢æŸ¥è³‡æ–™å¤¾');
                    }
                });
            } else {
                alert('æ–‡ä»¶è³‡æ–™ä¸å®Œæ•´ï¼Œè«‹é‡æ–°ç”Ÿæˆ');
            }
            
            document.getElementById('existing-data-info').style.display = 'none';
        }
        
        // Auto-generate documents after personas
        async function generateDocumentsAfterPersonas(scenarioName) {
            const statusDiv = document.getElementById('doc-generation-status');
            
            // Add progress bar
            statusDiv.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <strong>æ–‡ä»¶ç”Ÿæˆé€²åº¦</strong>
                        <span id="doc-progress-percent">0%</span>
                    </div>
                    <div style="width: 100%; height: 25px; background: #e0e0e0; border-radius: 12px; overflow: hidden;">
                        <div id="doc-progress-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #f57c00, #ff9800); transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;"></div>
                    </div>
                </div>
                <div id="doc-progress-log" style="background: #f5f5f5; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 14px; max-height: 300px; overflow-y: auto;">
                </div>
            `;
            
            // Helper to add log
            function addDocLog(message, type = 'info') {
                const log = document.getElementById('doc-progress-log');
                if (log) {
                const color = type === 'error' ? '#d32f2f' : type === 'success' ? '#388e3c' : '#1976d2';
                    log.innerHTML += `<div style="color: ${color}; margin-bottom: 5px;">[${new Date().toLocaleTimeString('zh-TW')}] ${message}</div>`;
                    log.scrollTop = log.scrollHeight;
                }
            }
            
            // Progress update helper
            function updateDocProgress(percent, text = '') {
                const bar = document.getElementById('doc-progress-bar');
                const percentText = document.getElementById('doc-progress-percent');
                if (bar && percentText) {
                    bar.style.width = percent + '%';
                    bar.textContent = text || (percent + '%');
                    percentText.textContent = percent + '%';
                }
            }
            
            try {
                const numDocs = parseInt(document.getElementById('num-documents').value);
                
                updateDocProgress(10, 'åˆå§‹åŒ–...');
                addDocLog('ğŸ“„ é–‹å§‹ç”Ÿæˆæƒ…å¢ƒæ–‡ä»¶...');
                addDocLog(`ğŸ“Š æº–å‚™ç”Ÿæˆ ${numDocs} ä»½æ–‡ä»¶...`);
                
                const formData = {
                    scenario_description: workflowState.scenario_description,
                    num_documents: numDocs,
                    output_folder: workflowState.output_folder,
                    scenario_name: workflowState.scenario_name,
                    model_provider: document.getElementById('persona-model-provider').value,
                    model_name: document.getElementById('persona-model-name').value,
                    language: 'ç¹é«”ä¸­æ–‡'
                };
                
                addDocLog(`ğŸ¤– ä½¿ç”¨æ¨¡å‹: ${formData.model_provider}/${formData.model_name}`);
                
                updateDocProgress(30, 'é€£æ¥ API...');
                
                // Simulate progress during API call
                const docProgressInterval = setInterval(() => {
                    const currentBar = document.getElementById('doc-progress-bar');
                    if (currentBar) {
                        const currentWidth = parseFloat(currentBar.style.width) || 30;
                        if (currentWidth < 80) {
                            updateDocProgress(currentWidth + 3, 'ç”Ÿæˆä¸­...');
                        }
                    }
                }, 2000);  // Update every 2 seconds
                
                const response = await fetch('/api/v1/testset/workflow/generate-documents', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                clearInterval(docProgressInterval);
                updateDocProgress(90, 'è™•ç†çµæœ...');
                
                addDocLog('â³ ç­‰å¾… API å›æ‡‰...');
                
                const result = await response.json();
                
                if (result.success) {
                    updateDocProgress(100, 'âœ… å®Œæˆ');
                    addDocLog(`âœ… æˆåŠŸç”Ÿæˆ ${result.total_documents} ä»½æ–‡ä»¶ï¼`, 'success');
                    addDocLog(`ğŸ’¾ ä¿å­˜è‡³: ${result.documents_folder}`);
                    addDocLog('ğŸ‰ æ‰€æœ‰ç”Ÿæˆä»»å‹™å®Œæˆï¼', 'success');
                    
                    workflowState.documents_folder = result.documents_folder;
                    
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    statusDiv.innerHTML += `
                        <div class="alert alert-success" style="margin-top: 15px;">
                            âœ… è§’è‰²å’Œæ–‡ä»¶ç”Ÿæˆå®Œæˆï¼
                            <p><strong>è§’è‰²æ•¸ï¼š</strong>${result.total_personas || 'N/A'}</p>
                            <p><strong>æ–‡ä»¶æ•¸ï¼š</strong>${result.total_documents}</p>
                            <p><strong>æ–‡ä»¶è³‡æ–™å¤¾ï¼š</strong>${result.documents_folder}</p>
                        </div>
                        <div class="button-group" style="margin-top: 15px;">
                            <button type="button" class="btn btn-primary" onclick="goToStage(2)">
                                ä¸‹ä¸€æ­¥ï¼šé¸æ“‡å·¥ä½œæµç¨‹
                            </button>
                        </div>
                    `;
                } else {
                    throw new Error(result.error || 'ç”Ÿæˆå¤±æ•—');
                }
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="alert alert-error">
                        âŒ æ–‡ä»¶ç”Ÿæˆå¤±æ•—ï¼š${error.message}
                    </div>
                    <div class="button-group" style="margin-top: 15px;">
                        <button type="button" class="btn btn-secondary" onclick="location.reload()">
                            é‡æ–°é–‹å§‹
                        </button>
                    </div>
                `;
            }
        }
        
        // Validate data integrity
        async function validateDataIntegrity() {
            try {
                const response = await fetch('/api/v1/testset/workflow/validate-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        output_folder: workflowState.output_folder,
                        scenario_name: workflowState.scenario_name
                    })
                });
                
                const result = await response.json();
                return result.is_valid;
            } catch (error) {
                console.error('Data validation failed:', error);
                return false;
            }
        }
        
        // Check for existing RAG testset
        async function checkExistingRAGTestset() {
            const infoDiv = document.getElementById('rag-existing-testset-info');
            
            if (!workflowState.output_folder || !workflowState.scenario_name) {
                alert('è«‹å…ˆå®Œæˆå‰é¢çš„æ­¥é©Ÿ');
                return;
            }
            
            infoDiv.innerHTML = '<p>ğŸ” æª¢æŸ¥ä¸­...</p>';
            infoDiv.style.display = 'block';
            
            try {
                const response = await fetch('/api/v1/testset/workflow/check-existing-testset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        output_folder: workflowState.output_folder,
                        scenario_name: workflowState.scenario_name,
                        testset_type: 'rag'
                    })
                });
                
                const result = await response.json();
                
                if (result.has_testset) {
                    // Store testset path to avoid string escaping issues
                    window._tempRAGTestsetPath = result.testset_path;
                    
                    infoDiv.innerHTML = `
                        <div class="alert alert-success">
                            âœ… ç™¼ç¾å·²å­˜åœ¨çš„ RAG æ¸¬è©¦é›†ï¼
                            <p><strong>æ¸¬è©¦é›†æª”æ¡ˆï¼š</strong>${result.testset_path}</p>
                            <p><strong>QA å°æ•¸ï¼š</strong>${result.total_qa_pairs || 'N/A'}</p>
                            <div class="button-group" style="margin-top: 15px;">
                                <button type="button" class="btn btn-primary" onclick="loadExistingRAGTestset(window._tempRAGTestsetPath)">
                                    è¼‰å…¥æ¸¬è©¦é›†ä¸¦é€²å…¥è©•ä¼°
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="document.getElementById('rag-existing-testset-info').style.display='none'">
                                    é‡æ–°ç”Ÿæˆ
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    infoDiv.innerHTML = `
                        <div class="alert alert-info">
                            â„¹ï¸ æ­¤æƒ…å¢ƒä¸‹æ²’æœ‰æ‰¾åˆ°å·²å­˜åœ¨çš„ RAG æ¸¬è©¦é›†ï¼Œè«‹é–‹å§‹ç”Ÿæˆæ–°çš„æ¸¬è©¦é›†ã€‚
                        </div>
                    `;
                    setTimeout(() => {
                        infoDiv.style.display = 'none';
                    }, 3000);
                }
            } catch (error) {
                infoDiv.innerHTML = `
                    <div class="alert alert-error">
                        âŒ æª¢æŸ¥å¤±æ•—ï¼š${error.message}
                    </div>
                `;
            }
        }
        
        // Load existing RAG testset and go to evaluation
        function loadExistingRAGTestset(testsetPath) {
            workflowState.rag_testset_path = testsetPath;
            workflowState.workflow_type = 'rag'; // Ensure workflow type is set
            console.log('Loaded RAG testset:', testsetPath);
            console.log('Workflow state:', workflowState);
            goToStage(4); // Go to evaluation stage
            document.getElementById('rag-existing-testset-info').style.display = 'none';
        }
        
        // Handle RAG provider change - auto-detect models
        async function onRAGProviderChange() {
            const provider = document.getElementById('rag-model-provider').value;
            
            // Toggle API Key fields
            document.getElementById('rag-openai-key-group').style.display = 'none';
            document.getElementById('rag-gemini-key-group').style.display = 'none';
            document.getElementById('rag-ollama-url-group').style.display = 'none';
            
            if (provider === 'openai') {
                document.getElementById('rag-openai-key-group').style.display = 'block';
            } else if (provider === 'gemini') {
                document.getElementById('rag-gemini-key-group').style.display = 'block';
            } else if (provider === 'ollama') {
                document.getElementById('rag-ollama-url-group').style.display = 'block';
            }
            
            await autoDetectRAGModels();
        }
        
        // Auto-detect available models for RAG testset generation
        async function autoDetectRAGModels() {
            const provider = document.getElementById('rag-model-provider').value;
            const modelSelect = document.getElementById('rag-model-name');
            const hintElement = document.getElementById('rag-model-hint');
            
            // Show loading state
            modelSelect.innerHTML = '<option value="">ğŸ” æ­£åœ¨æª¢æ¸¬å¯ç”¨æ¨¡å‹...</option>';
            modelSelect.disabled = true;
            
            try {
                const response = await fetch('/api/v1/evaluation/judge-models/check-custom', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        openai_api_key: null,
                        gemini_api_key: null,
                        ollama_base_url: null
                    })
                });
                
                const result = await response.json();
                
                // Clear and populate model options
                modelSelect.innerHTML = '';
                
                if (result[provider] && result[provider].length > 0) {
                    result[provider].forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        modelSelect.appendChild(option);
                    });
                    
                    // Set default selection
                    if (provider === 'openai') {
                        modelSelect.value = 'gpt-4o-mini';
                    } else if (provider === 'gemini') {
                        modelSelect.value = result[provider][0];
                    } else if (provider === 'ollama') {
                        modelSelect.value = result[provider][0];
                    }
                    
                    hintElement.textContent = `å·²æª¢æ¸¬åˆ° ${result[provider].length} å€‹å¯ç”¨æ¨¡å‹`;
                } else {
                    modelSelect.innerHTML = '<option value="">âŒ æœªæ‰¾åˆ°å¯ç”¨æ¨¡å‹</option>';
                    hintElement.textContent = 'æœªæ‰¾åˆ°å¯ç”¨æ¨¡å‹ï¼Œè«‹æª¢æŸ¥APIé…ç½®';
                }
                
            } catch (error) {
                console.error('Error detecting RAG models:', error);
                modelSelect.innerHTML = '<option value="">âŒ æª¢æ¸¬å¤±æ•—</option>';
                hintElement.textContent = 'æ¨¡å‹æª¢æ¸¬å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¼¸å…¥æ¨¡å‹åç¨±';
            } finally {
                modelSelect.disabled = false;
            }
        }
        
        // Generate comprehensive performance report
        function generatePerformanceReport(scores, totalTests, testsetPath) {
            const metricsChart = generateMetricsChart(scores);
            const analysis = generatePerformanceAnalysis(scores);
            const improvements = generateImprovementSuggestions(scores);
            
            return {
                metricsChart,
                analysis,
                improvements
            };
        }
        
        // Generate metrics chart
        function generateMetricsChart(scores) {
            let chart = '<div style="display: grid; gap: 15px;">';
            
            for (const [metric, score] of Object.entries(scores)) {
                const percentage = (score * 100).toFixed(2);
                const barWidth = Math.min(percentage, 100);
                const color = score >= 0.8 ? '#4caf50' : score >= 0.6 ? '#ff9800' : '#f44336';
                
                const metricName = getMetricDisplayName(metric);
                
                chart += `
                    <div style="padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; background: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <strong>${metricName}</strong>
                            <span style="font-size: 18px; font-weight: bold; color: ${color};">${percentage}%</span>
                        </div>
                        <div style="height: 8px; background: #f0f0f0; border-radius: 4px; overflow: hidden;">
                            <div style="width: ${barWidth}%; height: 100%; background: ${color}; transition: width 0.3s;"></div>
                        </div>
                    </div>
                `;
            }
            
            chart += '</div>';
            return chart;
        }
        
        // Get display name for metrics
        function getMetricDisplayName(metric) {
            const names = {
                'answer_accuracy': 'Answer Accuracy',
                'factual_correctness': 'Factual Correctness',
                'context_precision': 'Context Precision',
                'context_recall': 'Context Recall',
                'answer_correctness': 'Answer Correctness',
                'faithfulness': 'Faithfulness',
                'answer_relevancy': 'Answer Relevancy',
                'response_relevancy': 'Response Relevancy',
                'f1_score': 'F1 Score (ç¶œåˆæŒ‡æ¨™)'
            };
            return names[metric] || metric;
        }
        
        // Generate performance analysis
        function generatePerformanceAnalysis(scores) {
            const avgScore = Object.values(scores).reduce((a, b) => a + b, 0) / Object.keys(scores).length;
            const lowMetrics = Object.entries(scores).filter(([_, score]) => score < 0.6);
            const highMetrics = Object.entries(scores).filter(([_, score]) => score >= 0.8);
            
            let analysis = `
                <div style="margin-bottom: 15px;">
                    <strong>æ•´é«”è¡¨ç¾ï¼š</strong>${(avgScore * 100).toFixed(1)}% 
                    <span style="color: ${avgScore >= 0.8 ? '#4caf50' : avgScore >= 0.6 ? '#ff9800' : '#f44336'};">
                        ${avgScore >= 0.8 ? 'å„ªç§€' : avgScore >= 0.6 ? 'è‰¯å¥½' : 'éœ€è¦æ”¹é€²'}
                    </span>
                </div>
            `;
            
            if (highMetrics.length > 0) {
                analysis += `
                    <div style="margin-bottom: 10px;">
                        <strong>âœ… è¡¨ç¾å„ªç§€çš„æŒ‡æ¨™ï¼š</strong>
                        ${highMetrics.map(([metric, _]) => getMetricDisplayName(metric)).join(', ')}
                    </div>
                `;
            }
            
            if (lowMetrics.length > 0) {
                analysis += `
                    <div style="margin-bottom: 10px;">
                        <strong>âš ï¸ éœ€è¦é—œæ³¨çš„æŒ‡æ¨™ï¼š</strong>
                        ${lowMetrics.map(([metric, score]) => `${getMetricDisplayName(metric)} (${(score * 100).toFixed(1)}%)`).join(', ')}
                    </div>
                `;
            }
            
            return analysis;
        }
        
        // Generate improvement suggestions
        function generateImprovementSuggestions(scores) {
            let suggestions = '<ul style="margin: 0; padding-left: 20px;">';
            
            if (scores.context_precision < 0.7) {
                suggestions += '<li>èª¿æ•´ <strong>Chunk Size</strong> å’Œ <strong>Overlap</strong> åƒæ•¸ä»¥æé«˜æª¢ç´¢ç²¾ç¢ºåº¦</li>';
            }
            
            if (scores.context_recall < 0.7) {
                suggestions += '<li>å¢åŠ æª¢ç´¢æ•¸é‡æˆ–å„ªåŒ– <strong>æ–‡ä»¶ç›¸ä¼¼åº¦é–€æª»</strong> ä»¥æé«˜å¬å›ç‡</li>';
            }
            
            if (scores.factual_correctness < 0.7) {
                suggestions += '<li>å„ªåŒ– <strong>System Prompt</strong> ä»¥æé«˜äº‹å¯¦æ­£ç¢ºæ€§</li>';
            }
            
            if (scores.answer_accuracy < 0.7) {
                suggestions += '<li>èª¿æ•´ <strong>LLM Temperature</strong> æˆ–æ›´æ›æ›´é©åˆçš„æ¨¡å‹</li>';
            }
            
            if (scores.faithfulness < 0.7) {
                suggestions += '<li>æ”¹å–„ <strong>æª¢ç´¢å“è³ª</strong> å’Œ <strong>æ¨¡å‹é¸æ“‡</strong> ä»¥æ¸›å°‘å¹»è¦º</li>';
            }
            
            suggestions += '<li>å®šæœŸæ›´æ–° <strong>æ¸¬è©¦é›†</strong> ä»¥ç¢ºä¿è©•ä¼°çš„æŒçºŒæœ‰æ•ˆæ€§</li>';
            suggestions += '<li>è€ƒæ…®ä½¿ç”¨ <strong>æ¨¡å‹å¾®èª¿</strong> ä¾†é‡å°ç‰¹å®šé ˜åŸŸå„ªåŒ–</li>';
            
            suggestions += '</ul>';
            return suggestions;
        }
        
        // Download performance report
        function downloadPerformanceReport() {
            // Get the evaluation result content
            const reportDiv = document.getElementById('evaluation-result');
            if (!reportDiv || !reportDiv.innerHTML || reportDiv.innerHTML.trim() === '') {
                alert('æ‰¾ä¸åˆ°æ•ˆèƒ½å ±å‘Šå…§å®¹ï¼Œè«‹å…ˆå®Œæˆè©•ä¼°');
                return;
            }
            
            // Create a comprehensive HTML report
            const reportContent = reportDiv.innerHTML;
            const timestamp = new Date().toLocaleString('zh-TW');
            
            // Create full HTML document
            const htmlContent = `
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG ç³»çµ±æ•ˆèƒ½è©•ä¼°å ±å‘Š</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .report-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        .report-header h1 {
            margin: 0 0 10px 0;
        }
        .report-section {
            background: white;
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }
        .score-bar {
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }
        .score-fill {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        .score-high { background: linear-gradient(90deg, #4caf50, #8bc34a); }
        .score-medium { background: linear-gradient(90deg, #ff9800, #ffc107); }
        .score-low { background: linear-gradient(90deg, #f44336, #e57373); }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #667eea;
            color: white;
        }
        .footer {
            text-align: center;
            color: #666;
            margin-top: 30px;
            padding: 20px;
            border-top: 2px solid #ddd;
        }
        @media print {
            body { background: white; }
            .report-section { page-break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div class="report-header">
        <h1>ğŸ¯ RAG ç³»çµ±æ•ˆèƒ½è©•ä¼°å ±å‘Š</h1>
        <p>ç”Ÿæˆæ™‚é–“ï¼š${timestamp}</p>
    </div>
    
    ${reportContent}
    
    <div class="footer">
        <p>æ­¤å ±å‘Šç”± LLM Evaluation Hub è‡ªå‹•ç”Ÿæˆ</p>
        <p>Â© 2024 LLM Evaluation Hub. All rights reserved.</p>
    </div>
</body>
</html>`;
            
            // Create a blob and download
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `RAG_Performance_Report_${new Date().getTime()}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Show success message
            alert('âœ… æ•ˆèƒ½å ±å‘Šå·²ä¸‹è¼‰ï¼\n\næ‚¨å¯ä»¥åœ¨ç€è¦½å™¨ä¸­æ‰“é–‹ HTML æ–‡ä»¶æŸ¥çœ‹å®Œæ•´å ±å‘Šï¼Œæˆ–ä½¿ç”¨ç€è¦½å™¨çš„åˆ—å°åŠŸèƒ½è½‰æ›ç‚º PDFã€‚');
        }
        
        // Toggle metric details
        function toggleMetricDetails(metricId) {
            const detailsDiv = document.getElementById(metricId + '-details');
            const button = event.target;
            
            if (detailsDiv.style.display === 'none') {
                detailsDiv.style.display = 'block';
                button.textContent = 'æ”¶èµ·';
            } else {
                detailsDiv.style.display = 'none';
                button.textContent = 'è©³æƒ…';
            }
        }
        
        // Handle persona provider change - auto-detect models
        async function onPersonaProviderChange() {
            const provider = document.getElementById('persona-model-provider').value;
            
            // Toggle API Key fields
            document.getElementById('persona-openai-key-group').style.display = 'none';
            document.getElementById('persona-gemini-key-group').style.display = 'none';
            document.getElementById('persona-ollama-url-group').style.display = 'none';
            
            if (provider === 'openai') {
                document.getElementById('persona-openai-key-group').style.display = 'block';
            } else if (provider === 'gemini') {
                document.getElementById('persona-gemini-key-group').style.display = 'block';
            } else if (provider === 'ollama') {
                document.getElementById('persona-ollama-url-group').style.display = 'block';
            }
            
            await autoDetectPersonaModels();
        }
        
        // Auto-detect available models for persona generation
        async function autoDetectPersonaModels() {
            const provider = document.getElementById('persona-model-provider').value;
            const modelSelect = document.getElementById('persona-model-name');
            const hintElement = document.getElementById('persona-model-hint');
            
            // Show loading state
            modelSelect.innerHTML = '<option value="">ğŸ” æ­£åœ¨æª¢æ¸¬å¯ç”¨æ¨¡å‹...</option>';
            modelSelect.disabled = true;
            
            try {
                const response = await fetch('/api/v1/evaluation/judge-models/check-custom', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        openai_api_key: null,
                        gemini_api_key: null,
                        ollama_base_url: null
                    })
                });
                
                const result = await response.json();
                
                // Clear and populate model options
                modelSelect.innerHTML = '';
                
                if (result[provider] && result[provider].length > 0) {
                    result[provider].forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        modelSelect.appendChild(option);
                    });
                    
                    // Set default selection
                    if (provider === 'openai') {
                        modelSelect.value = 'gpt-4o-mini';
                    } else if (provider === 'gemini') {
                        modelSelect.value = result[provider][0];
                    } else if (provider === 'ollama') {
                        modelSelect.value = result[provider][0];
                    }
                    
                    hintElement.textContent = `å·²æª¢æ¸¬åˆ° ${result[provider].length} å€‹å¯ç”¨æ¨¡å‹`;
                } else {
                    modelSelect.innerHTML = '<option value="">âŒ æœªæ‰¾åˆ°å¯ç”¨æ¨¡å‹</option>';
                    hintElement.textContent = 'æœªæ‰¾åˆ°å¯ç”¨æ¨¡å‹ï¼Œè«‹æª¢æŸ¥APIé…ç½®';
                }
                
            } catch (error) {
                console.error('Error detecting models:', error);
                modelSelect.innerHTML = '<option value="">âŒ æª¢æ¸¬å¤±æ•—</option>';
                hintElement.textContent = 'æ¨¡å‹æª¢æ¸¬å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¼¸å…¥æ¨¡å‹åç¨±';
            } finally {
                modelSelect.disabled = false;
            }
        }
        
        // Handle provider change - toggle API key fields and auto-detect models
        async function onJudgeProviderChange() {
            const provider = document.getElementById('judge-model-provider').value;
            
            // Toggle API Key fields
            document.getElementById('judge-openai-key-group').style.display = 'none';
            document.getElementById('judge-gemini-key-group').style.display = 'none';
            document.getElementById('judge-ollama-url-group').style.display = 'none';
            
            if (provider === 'openai') {
                document.getElementById('judge-openai-key-group').style.display = 'block';
            } else if (provider === 'gemini') {
                document.getElementById('judge-gemini-key-group').style.display = 'block';
            } else if (provider === 'ollama') {
                document.getElementById('judge-ollama-url-group').style.display = 'block';
            }
            
            // Auto-detect models
            await autoDetectJudgeModels();
        }
        
        // Auto-detect available models for selected provider
        async function autoDetectJudgeModels(useEnvKeys = false) {
            const provider = document.getElementById('judge-model-provider').value;
            const modelSelect = document.getElementById('judge-model-name');
            const hintElement = document.getElementById('judge-model-hint');
            
            // Show loading state
            modelSelect.innerHTML = '<option value="">ğŸ” æ­£åœ¨æª¢æ¸¬å¯ç”¨æ¨¡å‹...</option>';
            modelSelect.disabled = true;
            
            try {
                // If useEnvKeys is true, send null to use .env keys
                // Otherwise, use custom keys from input fields
                const requestData = {
                    openai_api_key: useEnvKeys ? null : (document.getElementById('judge-openai-api-key').value || null),
                    gemini_api_key: useEnvKeys ? null : (document.getElementById('judge-gemini-api-key').value || null),
                    ollama_base_url: useEnvKeys ? null : (document.getElementById('judge-ollama-base-url').value || null)
                };
                
                const response = await fetch('/api/v1/evaluation/judge-models/check-custom', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                // Clear options
                modelSelect.innerHTML = '';
                
                // Populate models based on provider
                let models = [];
                let hasError = false;
                
                if (provider === 'openai' && result.openai && result.openai.length > 0) {
                    if (result.openai[0].startsWith('Error:')) {
                        hasError = true;
                        modelSelect.innerHTML = `<option value="">âŒ ${result.openai[0]}</option>`;
                        hintElement.textContent = 'è«‹æª¢æŸ¥ API Key æˆ–ç¶²çµ¡é€£æ¥';
                        hintElement.style.color = '#d32f2f';
                    } else {
                        models = result.openai;
                        hintElement.textContent = 'å·²æª¢æ¸¬åˆ°å¯ç”¨æ¨¡å‹';
                        hintElement.style.color = '';
                    }
                } else if (provider === 'gemini' && result.gemini && result.gemini.length > 0) {
                    if (result.gemini[0].startsWith('Error:')) {
                        hasError = true;
                        modelSelect.innerHTML = `<option value="">âŒ ${result.gemini[0]}</option>`;
                        hintElement.textContent = 'è«‹æª¢æŸ¥ API Key æˆ–ç¶²çµ¡é€£æ¥';
                        hintElement.style.color = '#d32f2f';
                    } else {
                        models = result.gemini;
                        hintElement.textContent = 'Gemini Pro é©åˆå¤§å¤šæ•¸è©•ä¼°ä»»å‹™';
                        hintElement.style.color = '';
                    }
                } else if (provider === 'ollama' && result.ollama && result.ollama.length > 0) {
                    if (result.ollama[0].startsWith('Error:')) {
                        hasError = true;
                        modelSelect.innerHTML = `<option value="">âŒ ${result.ollama[0]}</option>`;
                        hintElement.textContent = 'è«‹ç¢ºèª Ollama æœå‹™æ­£åœ¨é‹è¡Œ';
                        hintElement.style.color = '#d32f2f';
                    } else {
                        models = result.ollama;
                        hintElement.textContent = 'æœ¬åœ°æ¨¡å‹ï¼Œç„¡éœ€ API Key';
                        hintElement.style.color = '';
                    }
                }
                
                // Add models to select
                if (!hasError && models.length > 0) {
                    models.forEach((model, index) => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        modelSelect.appendChild(option);
                    });
                    
                    // Set default selection - prefer gpt-4o-mini for OpenAI
                    if (provider === 'openai' && models.includes('gpt-4o-mini')) {
                        modelSelect.value = 'gpt-4o-mini';
                    } else {
                        modelSelect.value = models[0];
                    }
                } else if (!hasError) {
                    modelSelect.innerHTML = '<option value="">âš ï¸ æœªæª¢æ¸¬åˆ°å¯ç”¨æ¨¡å‹</option>';
                    hintElement.textContent = 'è«‹è¼¸å…¥ API Key å¾Œé‡æ–°é¸æ“‡æä¾›å•†';
                    hintElement.style.color = '#ff9800';
                }
                
            } catch (error) {
                console.error('Error detecting models:', error);
                modelSelect.innerHTML = '<option value="">âŒ æª¢æ¸¬å¤±æ•—</option>';
                hintElement.textContent = `éŒ¯èª¤: ${error.message}`;
                hintElement.style.color = '#d32f2f';
            } finally {
                modelSelect.disabled = false;
            }
        }
        
        // Legacy function for backward compatibility
        function toggleJudgeApiKeyFields() {
            onJudgeProviderChange();
        }
        
        
        // Handle evaluation form submission
        document.getElementById('evaluation-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const btn = document.getElementById('start-evaluation-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> è©•ä¼°ä¸­...';
            
            // Show progress area
            const progressDiv = document.getElementById('evaluation-progress');
            const progressLog = document.getElementById('progress-log');
            progressDiv.style.display = 'block';
            progressLog.innerHTML = '';
            
            // Add log message helper
            function addLog(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString('zh-TW');
                const color = type === 'error' ? '#d32f2f' : type === 'success' ? '#388e3c' : '#1976d2';
                progressLog.innerHTML += `<div style="color: ${color}; margin-bottom: 5px;">[${timestamp}] ${message}</div>`;
                progressLog.scrollTop = progressLog.scrollHeight;
            }
            
            // Progress update helper
            function updateEvalProgress(percent, text = '') {
                const bar = document.getElementById('eval-progress-bar');
                const percentText = document.getElementById('eval-progress-percent');
                if (bar && percentText) {
                    bar.style.width = percent + '%';
                    bar.textContent = text || (percent + '%');
                    percentText.textContent = percent + '%';
                }
            }
            
            try {
                updateEvalProgress(5, 'åˆå§‹åŒ–...');
                // Collect selected metrics
                const metrics = [];
                // Core metrics
                if (document.getElementById('metric-answer-accuracy')?.checked) metrics.push('answer_accuracy');
                if (document.getElementById('metric-factual-correctness')?.checked) metrics.push('factual_correctness');
                if (document.getElementById('metric-context-precision')?.checked) metrics.push('context_precision');
                if (document.getElementById('metric-context-recall')?.checked) metrics.push('context_recall');
                if (document.getElementById('metric-answer-correctness')?.checked) metrics.push('answer_correctness');
                // Advanced metrics
                if (document.getElementById('metric-faithfulness')?.checked) metrics.push('faithfulness');
                if (document.getElementById('metric-answer-relevancy')?.checked) metrics.push('answer_relevancy');
                if (document.getElementById('metric-response-relevancy')?.checked) metrics.push('response_relevancy');
                
                if (metrics.length === 0) {
                    throw new Error('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹è©•ä¼°æŒ‡æ¨™');
                }
                
                updateEvalProgress(10, 'æº–å‚™ä¸­...');
                
                // Determine testset path
                let testsetPath;
                const testsetSource = document.getElementById('testset-source').value;
                
                if (testsetSource === 'custom') {
                    testsetPath = document.getElementById('custom-testset-path').value;
                    if (!testsetPath) {
                        throw new Error('è«‹è¼¸å…¥æˆ–é¸æ“‡æ¸¬è©¦é›†æª”æ¡ˆ');
                    }
                } else {
                    // Use workflow testset
                    testsetPath = workflowState.workflow_type === 'rag' 
                        ? workflowState.rag_testset_path 
                        : workflowState.agent_testset_path;
                    
                    if (!testsetPath) {
                        throw new Error('æ‰¾ä¸åˆ°æ¸¬è©¦é›†ï¼Œè«‹å…ˆç”Ÿæˆæ¸¬è©¦é›†æˆ–é¸æ“‡è‡ªå®šç¾©æ¸¬è©¦é›†');
                    }
                }
                
                console.log('Using testset:', testsetPath);
                console.log('Workflow state:', workflowState);
                
                updateEvalProgress(15, 'è¼‰å…¥æ¸¬è©¦é›†...');
                addLog('ğŸ“‹ æ­£åœ¨è¼‰å…¥æ¸¬è©¦é›†...');
                addLog(`ğŸ“„ æ¸¬è©¦é›†è·¯å¾‘: ${testsetPath}`);
                
                const formData = {
                    testset_path: testsetPath,
                    target_api_url: document.getElementById('target-api-url').value,
                    target_api_method: document.getElementById('target-api-method').value,
                    target_api_key_header: document.getElementById('target-api-key-header').value || null,
                    target_api_key_value: document.getElementById('target-api-key-value').value || null,
                    target_api_question_field: document.getElementById('target-api-question-field').value,
                    target_api_response_field: document.getElementById('target-api-response-field').value,
                    judge_model_provider: document.getElementById('judge-model-provider').value,
                    judge_model_name: document.getElementById('judge-model-name').value,
                    // Custom API Keys for Judge LLM
                    judge_openai_api_key: document.getElementById('judge-openai-api-key').value || null,
                    judge_gemini_api_key: document.getElementById('judge-gemini-api-key').value || null,
                    judge_ollama_base_url: document.getElementById('judge-ollama-base-url').value || null,
                    metrics: metrics,
                    output_folder: workflowState.output_folder,
                    scenario_name: workflowState.scenario_name
                };
                
                updateEvalProgress(5, 'åˆå§‹åŒ–...');
                addLog('ğŸš€ é–‹å§‹è©•ä¼°æµç¨‹...');
                addLog(`ğŸ“Š é¸æ“‡çš„è©•ä¼°æŒ‡æ¨™: ${metrics.join(', ')}`);
                addLog('â° æ³¨æ„ï¼šRAGAS è©•ä¼°å¯èƒ½éœ€è¦è¼ƒé•·æ™‚é–“ï¼Œè«‹è€å¿ƒç­‰å¾…...', 'info');
                
                // Start evaluation (non-blocking)
                const evaluationPromise = fetch('/api/v1/evaluation/workflow/run-evaluation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                // Poll for progress updates
                let sessionId = null;
                let lastProgress = 0;
                let lastMessage = '';
                const progressInterval = setInterval(async () => {
                    try {
                        // Get progress from backend
                        const statusResponse = await fetch('/api/v1/evaluation/progress/current');
                        if (statusResponse.ok) {
                            const progressData = await statusResponse.json();
                            
                            console.log('Progress data:', progressData);
                            
                            if (progressData.status !== 'not_found' && progressData.status !== 'idle' && progressData.total > 0) {
                                // Use actual percentage from backend (don't cap at 95%)
                                const percentage = Math.min(progressData.percentage, 98);
                                updateEvalProgress(percentage, progressData.message || 'è©•ä¼°ä¸­...');
                                
                                // Add log for any message change or significant progress
                                if (progressData.message !== lastMessage) {
                                    addLog(`${progressData.message} (${percentage.toFixed(1)}%)`);
                                    lastMessage = progressData.message;
                                    lastProgress = Math.floor(percentage);
                                } else if (Math.floor(percentage) >= lastProgress + 10) {
                                    addLog(`â³ é€²åº¦æ›´æ–°: ${percentage.toFixed(1)}%`);
                                    lastProgress = Math.floor(percentage);
                                }
                            }
                        }
                    } catch (err) {
                        console.log('Progress poll error:', err);
                    }
                }, 1500);  // Poll every 1.5 seconds for more responsive updates
                
                // Wait for evaluation to complete
                const response = await evaluationPromise;
                
                clearInterval(progressInterval);
                updateEvalProgress(90, 'è™•ç†çµæœ...');
                
                const result = await response.json();
                
                if (result.success) {
                    updateEvalProgress(100, 'âœ… å®Œæˆ');
                    addLog('âœ… è©•ä¼°å®Œæˆï¼', 'success');
                    
                    // Show result
                    const resultBox = document.getElementById('evaluation-result');
                    resultBox.style.display = 'block';
                    
                    // Calculate F1 Score if both Precision and Recall are available
                    let f1Score = null;
                    const precision = result.scores['context_precision'];
                    const recall = result.scores['context_recall'];
                    
                    if (precision !== undefined && recall !== undefined && precision > 0 && recall > 0) {
                        f1Score = 2 * (precision * recall) / (precision + recall);
                        result.scores['f1_score'] = f1Score;
                    }
                    
                    // Generate metrics table
                    let metricsTable = '<table style="width: 100%; border-collapse: collapse; margin-top: 20px;"><thead><tr style="background: #667eea; color: white;"><th style="padding: 12px; text-align: left;">è©•ä¼°æŒ‡æ¨™</th><th style="padding: 12px; text-align: right;">å¾—åˆ†</th></tr></thead><tbody>';
                    
                    for (const [metric, score] of Object.entries(result.scores)) {
                        const percentage = (score * 100).toFixed(2);
                        const barWidth = percentage;
                        
                        // Add special styling for F1 score
                        const isF1 = metric === 'f1_score';
                        const rowStyle = isF1 ? 'border-bottom: 2px solid #667eea; background: #f0f4ff;' : 'border-bottom: 1px solid #ddd;';
                        const metricName = isF1 ? 'ğŸ“Š F1 Score (Precision & Recall ç¶œåˆ)' : metric;
                        
                        metricsTable += `
                            <tr style="${rowStyle}">
                                <td style="padding: 12px; ${isF1 ? 'font-weight: bold;' : ''}">${metricName}</td>
                                <td style="padding: 12px; text-align: right;">
                                    <div style="display: flex; align-items: center; justify-content: flex-end; gap: 10px;">
                                        <div style="flex: 1; max-width: 200px; height: 20px; background: #e0e0e0; border-radius: 10px; overflow: hidden;">
                                            <div style="width: ${barWidth}%; height: 100%; background: ${isF1 ? 'linear-gradient(90deg, #4caf50, #8bc34a)' : 'linear-gradient(90deg, #667eea, #764ba2)'}; transition: width 0.3s;"></div>
                                        </div>
                                        <strong style="${isF1 ? 'color: #4caf50;' : ''}">${percentage}%</strong>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }
                    metricsTable += '</tbody></table>';
                    
                    // Add F1 explanation if calculated
                    let f1Explanation = '';
                    if (f1Score !== null) {
                        f1Explanation = `
                            <div style="margin-top: 15px; padding: 12px; background: #f0f4ff; border-left: 4px solid #667eea; border-radius: 4px;">
                                <strong>ğŸ“Š F1 åˆ†æ•¸èªªæ˜ï¼š</strong><br>
                                F1 = 2 Ã— (Precision Ã— Recall) / (Precision + Recall)<br>
                                = 2 Ã— (${(precision * 100).toFixed(2)}% Ã— ${(recall * 100).toFixed(2)}%) / (${(precision * 100).toFixed(2)}% + ${(recall * 100).toFixed(2)}%)<br>
                                = <strong>${(f1Score * 100).toFixed(2)}%</strong>
                            </div>
                        `;
                    }
                    
                    // Generate comprehensive performance report
                    const performanceReport = generatePerformanceReport(result.scores, result.total_tests, testsetPath);
                    
                    resultBox.innerHTML = `
                        <div class="alert alert-success">
                            âœ… è©•ä¼°å®Œæˆï¼
                        </div>
                        
                        <!-- åŸºæœ¬è³‡è¨Š -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="margin-top: 0; color: #495057;">ğŸ“Š è©•ä¼°æ‘˜è¦</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div><strong>æ¸¬è©¦é›†ï¼š</strong>${testsetPath}</div>
                                <div><strong>ç¸½æ¸¬è©¦æ•¸ï¼š</strong>${result.total_tests}</div>
                                <div><strong>è©•ä¼°æ™‚é–“ï¼š</strong>${result.evaluation_time || 'N/A'}</div>
                                <div><strong>çµæœæª”æ¡ˆï¼š</strong>${result.result_file}</div>
                            </div>
                        </div>
                        
                        <!-- æŒ‡æ¨™å¾—åˆ† -->
                        <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <h3 style="margin-top: 0; color: #495057;">ğŸ“ˆ æŒ‡æ¨™å¾—åˆ†</h3>
                            ${performanceReport.metricsChart}
                        </div>
                        
                        <!-- æ•ˆèƒ½åˆ†æ -->
                        <div style="background: #fff3e0; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="margin-top: 0; color: #e65100;">ğŸ” æ•ˆèƒ½åˆ†æ</h3>
                            ${performanceReport.analysis}
                        </div>
                        
                        <!-- æ”¹é€²å»ºè­° -->
                        <div style="background: #e8f5e8; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="margin-top: 0; color: #2e7d32;">ğŸ’¡ æ”¹é€²å»ºè­°</h3>
                            ${performanceReport.improvements}
                        </div>
                        
                        <!-- æ“ä½œæŒ‰éˆ• -->
                        <div class="button-group" style="margin-top: 30px; text-align: center;">
                            <button type="button" class="btn btn-primary" onclick="downloadEvaluationResult('${result.result_file}')">
                                ğŸ“¥ ä¸‹è¼‰è©•ä¼°å ±å‘Š
                            </button>
                            <button type="button" class="btn btn-success" onclick="downloadPerformanceReport()">
                                ğŸ“Š ä¸‹è¼‰æ•ˆèƒ½å ±å‘Š
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="location.reload()">
                                ğŸ”„ é–‹å§‹æ–°è©•ä¼°
                            </button>
                        </div>
                    `;
                } else {
                    addLog(`âŒ è©•ä¼°å¤±æ•—: ${result.error}`, 'error');
                    throw new Error(result.error || 'è©•ä¼°å¤±æ•—');
                }
            } catch (error) {
                addLog(`âŒ éŒ¯èª¤: ${error.message}`, 'error');
                const resultBox = document.getElementById('evaluation-result');
                resultBox.style.display = 'block';
                resultBox.innerHTML = `
                    <div class="alert alert-error">
                        âŒ éŒ¯èª¤ï¼š${error.message}
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.textContent = 'é–‹å§‹è©•ä¼°';
            }
        });
        
        // Download evaluation result
        function downloadEvaluationResult(filePath) {
            window.open(`/api/v1/evaluation/download?file_path=${encodeURIComponent(filePath)}`, '_blank');
        }
        
        // Toggle testset input
        function toggleTestsetInput() {
            const source = document.getElementById('testset-source').value;
            const customInput = document.getElementById('custom-testset-input');
            customInput.style.display = source === 'custom' ? 'block' : 'none';
        }
        
        // Normalize testset path
        function normalizeTestsetPath() {
            const input = document.getElementById('custom-testset-path');
            if (!input.value) return;
            
            const originalPath = input.value;
            const convertedPath = convertToContainerPath(originalPath);
            
            if (originalPath !== convertedPath) {
                input.value = convertedPath;
                showPathConversionNotification(originalPath, convertedPath);
            }
        }
        
        // Handle testset file selection
        function handleTestsetFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                alert(`å·²é¸æ“‡æª”æ¡ˆï¼š${file.name}`);
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-detect models for default provider (OpenAI) using .env keys
            setTimeout(() => {
                autoDetectJudgeModels(true);  // true = use .env keys
                autoDetectPersonaModels();     // Auto-detect persona models
                autoDetectRAGModels();          // Auto-detect RAG models
                
                // Show OpenAI API Key group by default for all stages
                document.getElementById('persona-openai-key-group').style.display = 'block';
                document.getElementById('rag-openai-key-group').style.display = 'block';
                document.getElementById('judge-openai-key-group').style.display = 'block';
            }, 500);
        });
    </script>
</body>
</html>

