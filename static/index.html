<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Evaluation Hub - Complete Workflow</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .workflow-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .workflow-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            position: relative;
        }
        
        .workflow-steps::before {
            content: '';
            position: absolute;
            top: 30px;
            left: 10%;
            right: 10%;
            height: 2px;
            background: #e0e0e0;
            z-index: 0;
        }
        
        .step {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 1;
        }
        
        .step-number {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 24px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .step.active .step-number {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.1);
        }
        
        .step.completed .step-number {
            background: #4caf50;
            color: white;
        }
        
        .step-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .step-desc {
            font-size: 13px;
            color: #666;
        }
        
        .stage-content {
            display: none;
            animation: fadeIn 0.5s;
        }
        
        .stage-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-group textarea {
            min-height: 150px;
            resize: vertical;
        }
        
        .form-group small {
            display: block;
            margin-top: 5px;
            color: #666;
            font-size: 13px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .btn {
            padding: 14px 32px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        .workflow-choice {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }
        
        .choice-card {
            padding: 30px;
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .choice-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
        }
        
        .choice-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }
        
        .choice-card h3 {
            font-size: 24px;
            margin-bottom: 15px;
            color: #333;
        }
        
        .choice-card p {
            color: #666;
            line-height: 1.6;
        }
        
        .result-box {
            background: #f9f9f9;
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
        }
        
        .result-box h3 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .result-box pre {
            background: white;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 13px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .alert-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        
        .stage-intro {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
        }
        
        .stage-intro h2 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .stage-intro p {
            color: #666;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ LLM Evaluation Hub</h1>
            <p>å®Œæ•´çš„ RAG è©•ä¼°å·¥ä½œæµç¨‹</p>
        </div>
        
        <div class="workflow-container">
            <!-- Workflow Steps Indicator -->
            <div class="workflow-steps">
                <div class="step active" data-step="0">
                    <div class="step-number">1</div>
                    <div class="step-title">è§’è‰²&æ–‡ä»¶ç”Ÿæˆ</div>
                    <div class="step-desc">ç”Ÿæˆæ¨¡æ“¬ç”¨æˆ¶èˆ‡æè¿°æ–‡ä»¶</div>
                </div>
                <div class="step" data-step="1">
                    <div class="step-number">2</div>
                    <div class="step-title">ç”Ÿæˆæ¸¬è©¦é›†</div>
                    <div class="step-desc">RAG QA Pairs</div>
                </div>
                <div class="step" data-step="2">
                    <div class="step-number">3</div>
                    <div class="step-title">å¹³å°è©•ä¼°</div>
                    <div class="step-desc">åŸºæ–¼ Excel è©•ä¼°</div>
                </div>
            </div>
            
            <!-- Stage 0: Generate Personas and Documents -->
            <div class="stage-content active" id="stage-0">
                <div class="stage-intro">
                    <h2>éšæ®µ 1: ç”Ÿæˆç”¨æˆ¶è§’è‰²å’Œæƒ…å¢ƒæ–‡ä»¶</h2>
                    <p>æ ¹æ“šæ‚¨çš„ä½¿ç”¨æƒ…å¢ƒï¼Œç³»çµ±å°‡ä¸€æ¬¡æ€§ç”Ÿæˆç”¨æˆ¶è§’è‰²å’Œæƒ…å¢ƒæ–‡ä»¶ï¼Œç¢ºä¿å…§å®¹ä¸€è‡´æ€§å’Œå®Œæ•´æ€§ã€‚</p>
                </div>
                
                <form id="personas-form">
                    <div class="form-group">
                        <label for="scenario-description">ä½¿ç”¨æƒ…å¢ƒæè¿° *</label>
                        <textarea id="scenario-description" required 
                            placeholder="ä¾‹å¦‚ï¼šä¸€å€‹æˆ¿åœ°ç”¢åª’åˆå¹³å°ï¼Œé€£æ¥è³¼å±‹è€…å’Œè³£å±‹è€…ã€‚è³¼å±‹è€…å¯ä»¥æœå°‹ç¬¦åˆéœ€æ±‚çš„æˆ¿å±‹ï¼Œè³£å±‹è€…å¯ä»¥ä¸Šæ¶æˆ¿å±‹è³‡è¨Š..."></textarea>
                        <small>è«‹è©³ç´°æè¿°æ‚¨çš„ä½¿ç”¨æƒ…å¢ƒï¼ŒåŒ…æ‹¬ç›®æ¨™ç”¨æˆ¶ã€ä¸»è¦åŠŸèƒ½ã€ä½¿ç”¨å ´æ™¯ç­‰ã€‚</small>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="output-folder">è¼¸å‡ºè³‡æ–™å¤¾ *</label>
                            <div style="flex: 1; position: relative;">
                                <input type="text" id="output-folder" required 
                                    list="output-folder-list"
                                    placeholder="/app/outputs/my_scenario" 
                                    value="/app/outputs/"
                                    onblur="normalizeOutputFolderPath()"
                                    oninput="handleOutputFolderInput()"
                                    onfocus="loadOutputFolders()"
                                    style="width: 100%;">
                                <datalist id="output-folder-list"></datalist>
                            </div>
                            <small>é è¨­åœ¨ <code>/app/outputs/</code> ä¸‹ï¼Œå¯å¾ä¸‹æ‹‰é¸å–®é¸æ“‡å·²å­˜åœ¨çš„è³‡æ–™å¤¾ï¼Œæˆ–è¼¸å…¥æ–°è³‡æ–™å¤¾åç¨±ã€‚</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="scenario-name">å°ˆæ¡ˆåç¨±ï¼ˆé¸å¡«ï¼‰</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <div style="flex: 1; position: relative;">
                                    <input type="text" id="scenario-name" 
                                        placeholder="ä¾‹å¦‚ï¼šreal_estate_platform"
                                        oninput="updateCheckExistingButton()">
                                </div>
                                <button type="button" class="btn btn-secondary" id="check-existing-btn" 
                                    onclick="checkExistingPersonas()" 
                                    disabled
                                    style="white-space: nowrap;"
                                    title="è«‹å…ˆè¼¸å…¥å°ˆæ¡ˆåç¨±æ‰èƒ½æª¢æŸ¥å·²æœ‰è³‡æ–™">
                                    æª¢æŸ¥å·²æœ‰è³‡æ–™
                                </button>
                            </div>
                            <small>ç•™ç©ºå‰‡è‡ªå‹•ç”Ÿæˆæ™‚é–“æˆ³è¨˜åç¨±ã€‚è¼¸å…¥å°ˆæ¡ˆåç¨±å¾Œå¯é»æ“Šã€Œæª¢æŸ¥å·²æœ‰è³‡æ–™ã€ä¾†è¼‰å…¥å·²å­˜åœ¨çš„è³‡æ–™ã€‚</small>
                        </div>
                    </div>
                    
                    <div id="existing-data-info" class="alert alert-info" style="display: none; margin-top: 20px;">
                        <!-- å·²å­˜åœ¨è³‡æ–™çš„ä¿¡æ¯å°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="num-personas">è§’è‰²æ•¸é‡</label>
                            <input type="number" id="num-personas" min="3" max="5" value="3">
                            <small>å»ºè­°ç”Ÿæˆ 3-5 å€‹è§’è‰²ä»¥ç²å¾—æ›´å¥½çš„å¤šæ¨£æ€§</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="num-documents">æ–‡ä»¶æ•¸é‡</label>
                            <input type="number" id="num-documents" min="1" max="20" value="1">
                            <small>å»ºè­° 1-5 ä»½æ ¸å¿ƒæ–‡ä»¶ï¼Œå°ˆæ³¨æ–¼ä½¿ç”¨è€…ä¸»è¦ä½¿ç”¨æƒ…å¢ƒã€‚</small>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="persona-model-provider">LLM æä¾›å•†</label>
                            <select id="persona-model-provider" onchange="onPersonaProviderChange()">
                                <option value="openai">OpenAI</option>
                                <option value="gemini">Google Gemini</option>
                                <option value="ollama">Ollama (æœ¬åœ°)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="persona-model-name">æ¨¡å‹åç¨±</label>
                            <select id="persona-model-name">
                                <option value="gpt-4o-mini">gpt-4o-mini</option>
                            </select>
                            <small id="persona-model-hint">å»ºè­°ä½¿ç”¨ GPT-4o-mini ä»¥ç²å¾—æ›´é«˜è³ªé‡çš„å…§å®¹ã€‚</small>
                        </div>
                    </div>
                    
                    <!-- API Key é…ç½® -->
                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-top: 15px; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #e65100;">ğŸ”‘ API Key é…ç½®ï¼ˆå¯é¸ï¼‰</h4>
                        <p style="margin: 0 0 15px 0; color: #666; font-size: 14px;">å¦‚æœæ‚¨æƒ³ä½¿ç”¨è‡ªå·±çš„ API Keyï¼Œè«‹åœ¨ä¸‹æ–¹è¼¸å…¥ã€‚ç•™ç©ºå‰‡ä½¿ç”¨ç³»çµ±é è¨­çš„ .env é…ç½®ã€‚</p>
                        
                        <div class="form-group" id="persona-openai-key-group" style="display: none;">
                            <label for="persona-openai-api-key">OpenAI API Key</label>
                            <input type="password" id="persona-openai-api-key" placeholder="sk-...ï¼ˆç•™ç©ºä½¿ç”¨ .env é…ç½®ï¼‰">
                            <small>ç”¨æ–¼ OpenAI æ¨¡å‹çš„è§’è‰²ç”Ÿæˆã€‚</small>
                        </div>
                        
                        <div class="form-group" id="persona-gemini-key-group" style="display: none;">
                            <label for="persona-gemini-api-key">Gemini API Key</label>
                            <input type="password" id="persona-gemini-api-key" placeholder="AI...ï¼ˆç•™ç©ºä½¿ç”¨ .env é…ç½®ï¼‰">
                            <small>ç”¨æ–¼ Gemini æ¨¡å‹çš„è§’è‰²ç”Ÿæˆã€‚</small>
                        </div>
                        
                        <div class="form-group" id="persona-ollama-url-group" style="display: none;">
                            <label for="persona-ollama-base-url">Ollama Base URL</label>
                            <input type="text" id="persona-ollama-base-url" placeholder="http://localhost:11434ï¼ˆç•™ç©ºä½¿ç”¨ .env é…ç½®ï¼‰">
                            <small>ç”¨æ–¼ Ollama æ¨¡å‹çš„è§’è‰²ç”Ÿæˆã€‚</small>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button type="submit" class="btn btn-primary" id="generate-personas-btn">
                            é–‹å§‹ç”Ÿæˆè§’è‰²å’Œæ–‡ä»¶
                        </button>
                    </div>
                </form>
                
                <div id="personas-result" class="result-box" style="display: none;"></div>
            </div>
            
            <!-- Stage 1: Generate RAG Testset -->
            <div class="stage-content" id="stage-1" style="display: none;">
                <div class="stage-intro">
                    <h2>éšæ®µ 2: ç”Ÿæˆ RAG æ¸¬è©¦é›†</h2>
                    <p>ä½¿ç”¨ç”Ÿæˆçš„è§’è‰²å’Œæ–‡ä»¶ï¼ŒåŸºæ–¼ RAGAS æ¡†æ¶ç”Ÿæˆå•ç­”å°æ¸¬è©¦é›†ï¼ˆQA Pairsï¼‰ï¼Œä¸¦è¼¸å‡ºç‚º Excel æª”æ¡ˆã€‚æ¯å€‹å•é¡Œéƒ½å°æ‡‰ä¸€å€‹ç‰¹å®šçš„è§’è‰²ã€‚</p>
                    <div style="margin-top: 15px;">
                        <button type="button" class="btn btn-secondary" onclick="checkExistingRAGTestset()" style="margin-right: 10px;">
                            ğŸ” æª¢æŸ¥å·²æœ‰æ¸¬è©¦é›†
                        </button>
                    </div>
                    <div id="rag-existing-testset-info" class="alert alert-info" style="display: none; margin-top: 15px;">
                        <!-- å·²å­˜åœ¨æ¸¬è©¦é›†çš„ä¿¡æ¯å°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
                    </div>
                </div>
                
                <form id="rag-testset-form">
                    <div class="form-group">
                        <label for="rag-use-custom-docs">æ–‡ä»¶ä¾†æº</label>
                        <select id="rag-use-custom-docs" onchange="toggleRAGCustomDocsInput()">
                            <option value="workflow" id="rag-workflow-docs-option">ä½¿ç”¨å·¥ä½œæµç¨‹ç”Ÿæˆçš„æ–‡ä»¶ (æœªç”Ÿæˆ)</option>
                            <option value="custom">ä½¿ç”¨è‡ªå®šç¾©è³‡æ–™å¤¾</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="rag-custom-docs-input" style="display: none;">
                        <label>ä¸Šå‚³æ–‡ä»¶åˆ°å°ˆæ¡ˆè³‡æ–™å¤¾</label>
                        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                            <input type="file" id="rag-file-upload" multiple accept=".txt,.md,.pdf" style="flex: 1;">
                            <button type="button" class="btn btn-secondary" onclick="uploadRAGFiles()" style="white-space: nowrap;">
                                ğŸ“¤ ä¸Šå‚³æ–‡ä»¶
                            </button>
                        </div>
                        <div id="rag-upload-status" class="alert alert-info" style="display: none; margin-top: 10px;">
                            <!-- ä¸Šå‚³ç‹€æ…‹å°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
                        </div>
                        <small>é¸æ“‡æ–‡ä»¶ä¸Šå‚³åˆ°å°ˆæ¡ˆçš„ 02_documents è³‡æ–™å¤¾ã€‚æ”¯æ´ .txt, .md, .pdf æ ¼å¼ã€‚</small>
                    </div>
                    
                    <div class="form-group" id="rag-documents-selection" style="display: none; margin-top: 20px;">
                        <label>é¸æ“‡è¦ä½¿ç”¨çš„æ–‡ä»¶ï¼ˆå¯å¤šé¸ï¼‰</label>
                        <div id="rag-documents-list" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; background: #f9f9f9;">
                            <p style="color: #666; text-align: center; padding: 20px;">è¼‰å…¥ä¸­...</p>
                        </div>
                        <small>å‹¾é¸è¦åŒ…å«åœ¨æ¸¬è©¦é›†ç”Ÿæˆä¸­çš„æ–‡ä»¶ã€‚é è¨­å…¨é¸ã€‚</small>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="rag-chunk-size">æ–‡ä»¶åˆ†å¡Šå¤§å°</label>
                            <input type="number" id="rag-chunk-size" value="5000" min="100" max="20000">
                        </div>
                        
                        <div class="form-group">
                            <label for="rag-chunk-overlap">åˆ†å¡Šé‡ç–Š</label>
                            <input type="number" id="rag-chunk-overlap" value="200" min="0" max="1000">
                        </div>
                        
                        <div class="form-group">
                            <label for="rag-qa-per-chunk">æ¯å€‹åˆ†å¡Šçš„ QA æ•¸é‡</label>
                            <input type="number" id="rag-qa-per-chunk" value="3" min="1" max="10">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="rag-model-provider">LLM æä¾›å•†</label>
                            <select id="rag-model-provider" onchange="onRAGProviderChange()">
                                <option value="openai">OpenAI</option>
                                <option value="gemini">Google Gemini</option>
                                <option value="ollama">Ollama (æœ¬åœ°)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="rag-model-name">æ¨¡å‹åç¨±</label>
                            <select id="rag-model-name">
                                <option value="gpt-4o-mini">gpt-4o-mini</option>
                            </select>
                            <small id="rag-model-hint">å»ºè­°ä½¿ç”¨ GPT-4o-miniã€‚</small>
                        </div>
                    </div>
                    
                    <!-- API Key é…ç½® -->
                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-top: 15px; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #e65100;">ğŸ”‘ API Key é…ç½®ï¼ˆå¯é¸ï¼‰</h4>
                        <p style="margin: 0 0 15px 0; color: #666; font-size: 14px;">å¦‚æœæ‚¨æƒ³ä½¿ç”¨è‡ªå·±çš„ API Keyï¼Œè«‹åœ¨ä¸‹æ–¹è¼¸å…¥ã€‚ç•™ç©ºå‰‡ä½¿ç”¨ç³»çµ±é è¨­çš„ .env é…ç½®ã€‚</p>
                        
                        <div class="form-group" id="rag-openai-key-group" style="display: none;">
                            <label for="rag-openai-api-key">OpenAI API Key</label>
                            <input type="password" id="rag-openai-api-key" placeholder="sk-...ï¼ˆç•™ç©ºä½¿ç”¨ .env é…ç½®ï¼‰">
                            <small>ç”¨æ–¼ OpenAI æ¨¡å‹çš„æ¸¬è©¦é›†ç”Ÿæˆã€‚</small>
                        </div>
                        
                        <div class="form-group" id="rag-gemini-key-group" style="display: none;">
                            <label for="rag-gemini-api-key">Gemini API Key</label>
                            <input type="password" id="rag-gemini-api-key" placeholder="AI...ï¼ˆç•™ç©ºä½¿ç”¨ .env é…ç½®ï¼‰">
                            <small>ç”¨æ–¼ Gemini æ¨¡å‹çš„æ¸¬è©¦é›†ç”Ÿæˆã€‚</small>
                        </div>
                        
                        <div class="form-group" id="rag-ollama-url-group" style="display: none;">
                            <label for="rag-ollama-base-url">Ollama Base URL</label>
                            <input type="text" id="rag-ollama-base-url" placeholder="http://localhost:11434ï¼ˆç•™ç©ºä½¿ç”¨ .env é…ç½®ï¼‰">
                            <small>ç”¨æ–¼ Ollama æ¨¡å‹çš„æ¸¬è©¦é›†ç”Ÿæˆã€‚</small>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button type="button" class="btn btn-secondary" onclick="goToStage(0)">
                            ä¸Šä¸€æ­¥
                        </button>
                        <button type="submit" class="btn btn-primary" id="generate-rag-testset-btn">
                            ç”Ÿæˆ QA Pairs Excel
                        </button>
                    </div>
                </form>
                
                <div id="rag-testset-result" class="result-box" style="display: none;"></div>
            </div>
            
            <!-- Stage 2: Evaluation -->
            <div class="stage-content" id="stage-2" style="display: none;">
                <div class="stage-intro">
                    <h2>éšæ®µ 3: åŸºæ–¼ Excel é€²è¡Œå¹³å°è©•ä¼°</h2>
                    <p>ä½¿ç”¨ç”Ÿæˆçš„ QA Pairs Excel æª”æ¡ˆï¼Œé…ç½®æ‚¨è¦è©•ä¼°çš„ç³»çµ± APIï¼Œä½¿ç”¨ RAGAS æ¡†æ¶é€²è¡Œè‡ªå‹•åŒ–è©•ä¼°ã€‚</p>
                </div>
                
                <form id="evaluation-form">
                    <!-- æ¸¬è©¦é›†é¸æ“‡ -->
                    <div class="form-group">
                        <label for="testset-source">æ¸¬è©¦é›†ä¾†æº</label>
                        <select id="testset-source" onchange="toggleTestsetInput()">
                            <option value="workflow">ä½¿ç”¨å·¥ä½œæµç¨‹ç”Ÿæˆçš„ QA Pairs Excel</option>
                            <option value="custom">é¸æ“‡è‡ªå®šç¾©æ¸¬è©¦é›† Excel</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="custom-testset-input" style="display: none;">
                        <label for="custom-testset-path">QA Pairs Excel æª”æ¡ˆè·¯å¾‘</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="custom-testset-path" placeholder="è¼¸å…¥æ¸¬è©¦é›†æª”æ¡ˆè·¯å¾‘" style="flex: 1;" onblur="normalizeTestsetPath()">
                            <input type="file" id="testset-file-picker" accept=".xlsx,.xls" style="display: none;" onchange="handleTestsetFileSelect(event)">
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('testset-file-picker').click()" style="white-space: nowrap;">
                                ğŸ“ é¸æ“‡æª”æ¡ˆ
                            </button>
                        </div>
                        <small>é¸æ“‡åŒ…å«æ¸¬è©¦é›†çš„ Excel æª”æ¡ˆï¼ˆMac è·¯å¾‘æœƒè‡ªå‹•è½‰æ›ï¼‰ã€‚</small>
                    </div>
                    
                    <div id="testset-info" class="alert alert-info" style="display: none; margin-top: 15px;">
                        <!-- æ¸¬è©¦é›†è³‡è¨Šå°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
                    </div>
                    
                    <!-- å¾…è©•ä¼° API é…ç½® -->
                    <h3 style="margin-top: 30px; margin-bottom: 15px;">å¾…è©•ä¼°çš„ API é…ç½®</h3>
                    
                    <div class="form-group">
                        <label for="target-api-url">API ç«¯é» *</label>
                        <input type="text" id="target-api-url" required 
                            placeholder="https://your-api.com/chat">
                        <small>è¼¸å…¥æ‚¨è¦è©•ä¼°çš„ RAG ç³»çµ± API ç«¯é»ã€‚</small>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="target-api-method">HTTP æ–¹æ³•</label>
                            <select id="target-api-method">
                                <option value="POST">POST</option>
                                <option value="GET">GET</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="target-api-key-header">API Key Headerï¼ˆé¸å¡«ï¼‰</label>
                            <input type="text" id="target-api-key-header" placeholder="ä¾‹å¦‚: Authorization">
                            <small>å¦‚æœ API éœ€è¦é©—è­‰ï¼Œè¼¸å…¥ Header åç¨±ã€‚</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="target-api-key-value">API Key Valueï¼ˆé¸å¡«ï¼‰</label>
                            <input type="password" id="target-api-key-value" placeholder="ä¾‹å¦‚: Bearer your-token">
                            <small>API Key çš„å€¼ã€‚</small>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="target-api-question-field">å•é¡Œæ¬„ä½åç¨±</label>
                        <input type="text" id="target-api-question-field" value="question" placeholder="question">
                        <small>API è«‹æ±‚ body ä¸­å•é¡Œçš„æ¬„ä½åç¨±ï¼ˆä¾‹å¦‚ï¼šquestion, query, messageï¼‰ã€‚</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="target-api-response-field">å›ç­”æ¬„ä½è·¯å¾‘</label>
                        <input type="text" id="target-api-response-field" value="response" placeholder="response">
                        <small>API å›æ‡‰ä¸­ç­”æ¡ˆçš„æ¬„ä½è·¯å¾‘ï¼ˆä¾‹å¦‚ï¼šresponse, answer, data.messageï¼‰ã€‚</small>
                    </div>
                    
                    <!-- Judge LLM é…ç½® -->
                    <h3 style="margin-top: 30px; margin-bottom: 15px;">è©•ä¼°æ¨¡å‹é…ç½®ï¼ˆJudge LLMï¼‰</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="judge-model-provider">Judge LLM æä¾›å•†</label>
                            <select id="judge-model-provider" onchange="onJudgeProviderChange()">
                                <option value="openai">OpenAI</option>
                                <option value="gemini">Google Gemini</option>
                                <option value="ollama">Ollama (æœ¬åœ°)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="judge-model-name">Judge æ¨¡å‹åç¨±</label>
                            <select id="judge-model-name" style="width: 100%;">
                                <option value="gpt-4o-mini">gpt-4o-mini</option>
                            </select>
                            <small id="judge-model-hint">å»ºè­°ä½¿ç”¨ GPT-4o-miniã€‚</small>
                        </div>
                    </div>
                    
                    <!-- API Key é…ç½® -->
                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-top: 15px; margin-bottom: 15px;">
                        <h4 style="margin-bottom: 10px; color: #f57c00;">ğŸ”‘ API Key é…ç½®ï¼ˆå¯é¸ï¼‰</h4>
                        <p style="margin-bottom: 15px; font-size: 14px; color: #666;">
                            å¦‚æœæ‚¨æƒ³ä½¿ç”¨è‡ªå·±çš„ API Keyï¼Œè«‹åœ¨ä¸‹æ–¹è¼¸å…¥ã€‚ç•™ç©ºå‰‡ä½¿ç”¨ç³»çµ±é è¨­çš„ .env é…ç½®ã€‚
                        </p>
                        
                        <div class="form-group" id="judge-openai-key-group">
                            <label for="judge-openai-api-key">OpenAI API Key</label>
                            <input type="password" id="judge-openai-api-key" placeholder="sk-...ï¼ˆç•™ç©ºä½¿ç”¨ .env é…ç½®ï¼‰">
                            <small>ç”¨æ–¼ GPT-4 ç­‰ OpenAI æ¨¡å‹çš„è©•ä¼°ã€‚</small>
                        </div>
                        
                        <div class="form-group" id="judge-gemini-key-group" style="display: none;">
                            <label for="judge-gemini-api-key">Gemini API Key</label>
                            <input type="password" id="judge-gemini-api-key" placeholder="AI...ï¼ˆç•™ç©ºä½¿ç”¨ .env é…ç½®ï¼‰">
                            <small>ç”¨æ–¼ Gemini æ¨¡å‹çš„è©•ä¼°ã€‚</small>
                        </div>
                        
                        <div class="form-group" id="judge-ollama-url-group" style="display: none;">
                            <label for="judge-ollama-base-url">Ollama Base URL</label>
                            <input type="text" id="judge-ollama-base-url" placeholder="http://localhost:11434ï¼ˆç•™ç©ºä½¿ç”¨ .env é…ç½®ï¼‰">
                            <small>Ollama æœå‹™çš„ URLã€‚</small>
                        </div>
                    </div>
                    
                    <!-- è©•ä¼°æŒ‡æ¨™é¸æ“‡ -->
                    <h3 style="margin-top: 30px; margin-bottom: 20px;">ğŸ“Š è©•ä¼°æŒ‡æ¨™</h3>
                    
                    <!-- æ ¸å¿ƒæŒ‡æ¨™ -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                        <h4 style="margin: 0 0 15px 0; font-size: 18px;">ğŸ¯ æ ¸å¿ƒæŒ‡æ¨™ï¼ˆæ¨è–¦ï¼‰</h4>
                        
                        <div class="metric-item" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 12px; backdrop-filter: blur(10px);">
                            <label style="display: flex; align-items: center; cursor: pointer; margin: 0;">
                                <input type="checkbox" id="metric-answer-accuracy" checked style="margin-right: 12px; transform: scale(1.2);">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">Answer Accuracy</div>
                                    <div style="font-size: 14px; opacity: 0.9;">è©•ä¼°ç­”æ¡ˆçš„æº–ç¢ºæ€§</div>
                                </div>
                                <button type="button" onclick="toggleMetricDetails('answer-accuracy')" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">è©³æƒ…</button>
                            </label>
                            <div id="answer-accuracy-details" class="metric-details" style="display: none; margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 6px; font-size: 13px;">
                                <div><strong>è©³ç´°èªªæ˜ï¼š</strong>æª¢æŸ¥æ¨¡å‹æ˜¯å¦èƒ½æ­£ç¢ºå›ç­”å•é¡Œï¼ŒåŸºæ–¼æ¨™æº–ç­”æ¡ˆé€²è¡Œæ¯”è¼ƒã€‚</div>
                                <div style="margin-top: 8px;"><strong>åˆ†æ•¸ä½æ™‚å¯èª¿æ•´ï¼š</strong>System Promptã€LLM Temperatureã€æ¨¡å‹é¸æ“‡</div>
                            </div>
                        </div>
                        
                        <div class="metric-item" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 12px; backdrop-filter: blur(10px);">
                            <label style="display: flex; align-items: center; cursor: pointer; margin: 0;">
                                <input type="checkbox" id="metric-factual-correctness" checked style="margin-right: 12px; transform: scale(1.2);">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">Factual Correctness</div>
                                    <div style="font-size: 14px; opacity: 0.9;">æª¢æŸ¥å›æ‡‰æ˜¯å¦èˆ‡æ–‡ä»¶ä¸€è‡´</div>
                                </div>
                                <button type="button" onclick="toggleMetricDetails('factual-correctness')" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">è©³æƒ…</button>
                            </label>
                            <div id="factual-correctness-details" class="metric-details" style="display: none; margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 6px; font-size: 13px;">
                                <div><strong>è©³ç´°èªªæ˜ï¼š</strong>è©•ä¼°ç”Ÿæˆçš„å›æ‡‰æ˜¯å¦èˆ‡æä¾›çš„æ–‡ä»¶å…§å®¹ä¸€è‡´ï¼Œç„¡è‡†é€ è³‡è¨Šã€‚</div>
                                <div style="margin-top: 8px;"><strong>åˆ†æ•¸ä½æ™‚å¯èª¿æ•´ï¼š</strong>System Promptã€æ–‡ä»¶å“è³ªã€æª¢ç´¢ç­–ç•¥</div>
                            </div>
                        </div>
                        
                        <div class="metric-item" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 12px; backdrop-filter: blur(10px);">
                            <label style="display: flex; align-items: center; cursor: pointer; margin: 0;">
                                <input type="checkbox" id="metric-context-precision" checked style="margin-right: 12px; transform: scale(1.2);">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">Context Precision</div>
                                    <div style="font-size: 14px; opacity: 0.9;">æª¢ç´¢è³‡è¨Šçš„ç²¾ç¢ºåº¦</div>
                                </div>
                                <button type="button" onclick="toggleMetricDetails('context-precision')" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">è©³æƒ…</button>
                            </label>
                            <div id="context-precision-details" class="metric-details" style="display: none; margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 6px; font-size: 13px;">
                                <div><strong>è©³ç´°èªªæ˜ï¼š</strong>è©•ä¼°æª¢ç´¢åˆ°çš„è³‡è¨Šä¸­æœ‰å¤šå°‘æ¯”ä¾‹æ˜¯ç›¸é—œä¸”æ­£ç¢ºçš„ã€‚</div>
                                <div style="margin-top: 8px;"><strong>åˆ†æ•¸ä½æ™‚å¯èª¿æ•´ï¼š</strong>Chunk Sizeã€Overlapã€æª¢ç´¢ç®—æ³•ã€Embeddingæ¨¡å‹</div>
                            </div>
                        </div>
                        
                        <div class="metric-item" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 12px; backdrop-filter: blur(10px);">
                            <label style="display: flex; align-items: center; cursor: pointer; margin: 0;">
                                <input type="checkbox" id="metric-context-recall" checked style="margin-right: 12px; transform: scale(1.2);">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">Context Recall</div>
                                    <div style="font-size: 14px; opacity: 0.9;">æª¢ç´¢è³‡è¨Šçš„å®Œæ•´æ€§</div>
                                </div>
                                <button type="button" onclick="toggleMetricDetails('context-recall')" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">è©³æƒ…</button>
                            </label>
                            <div id="context-recall-details" class="metric-details" style="display: none; margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 6px; font-size: 13px;">
                                <div><strong>è©³ç´°èªªæ˜ï¼š</strong>è©•ä¼°æ¨™æº–ç­”æ¡ˆä¸­çš„è³‡è¨Šæœ‰å¤šå°‘è¢«æ­£ç¢ºæª¢ç´¢å’Œæ¶µè“‹ã€‚</div>
                                <div style="margin-top: 8px;"><strong>åˆ†æ•¸ä½æ™‚å¯èª¿æ•´ï¼š</strong>Chunk Sizeã€Overlapã€æª¢ç´¢æ•¸é‡ã€æ–‡ä»¶ç›¸ä¼¼åº¦é–€æª»</div>
                            </div>
                        </div>
                        
                        <div class="metric-item" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 0; backdrop-filter: blur(10px);">
                            <label style="display: flex; align-items: center; cursor: pointer; margin: 0;">
                                <input type="checkbox" id="metric-answer-correctness" checked style="margin-right: 12px; transform: scale(1.2);">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">Answer Correctness</div>
                                    <div style="font-size: 14px; opacity: 0.9;">ç¶œåˆæ­£ç¢ºæ€§ï¼ˆå«F1åˆ†æ•¸ï¼‰</div>
                                </div>
                                <button type="button" onclick="toggleMetricDetails('answer-correctness')" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">è©³æƒ…</button>
                            </label>
                            <div id="answer-correctness-details" class="metric-details" style="display: none; margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 6px; font-size: 13px;">
                                <div><strong>è©³ç´°èªªæ˜ï¼š</strong>Precisionèˆ‡Recallçš„ç¶œåˆå¹³è¡¡æŒ‡æ¨™ï¼Œæä¾›F1åˆ†æ•¸ã€‚</div>
                                <div style="margin-top: 8px;"><strong>åˆ†æ•¸ä½æ™‚å¯èª¿æ•´ï¼š</strong>æ•´é«”ç³»çµ±å„ªåŒ–ã€æ¨¡å‹å¾®èª¿ã€æª¢ç´¢ç­–ç•¥èª¿æ•´</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- é€²éšæŒ‡æ¨™ -->
                    <div style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); color: #333; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(255, 154, 158, 0.3);">
                        <h4 style="margin: 0 0 15px 0; font-size: 18px;">ğŸ” é€²éšæŒ‡æ¨™</h4>
                        
                        <div class="metric-item" style="background: rgba(255,255,255,0.3); padding: 15px; border-radius: 8px; margin-bottom: 12px; backdrop-filter: blur(10px);">
                            <label style="display: flex; align-items: center; cursor: pointer; margin: 0;">
                                <input type="checkbox" id="metric-faithfulness" style="margin-right: 12px; transform: scale(1.2);">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">Faithfulness</div>
                                    <div style="font-size: 14px; opacity: 0.8;">å›æ‡‰çš„å¿ å¯¦åº¦</div>
                        </div>
                                <button type="button" onclick="toggleMetricDetails('faithfulness')" style="background: rgba(255,255,255,0.4); border: none; color: #333; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">è©³æƒ…</button>
                            </label>
                            <div id="faithfulness-details" class="metric-details" style="display: none; margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.3); border-radius: 6px; font-size: 13px;">
                                <div><strong>è©³ç´°èªªæ˜ï¼š</strong>è©•ä¼°å›æ‡‰æ˜¯å¦å¿ å¯¦æ–¼æª¢ç´¢åˆ°çš„æ–‡ä»¶å…§å®¹ï¼Œé¿å…å¹»è¦ºã€‚</div>
                                <div style="margin-top: 8px;"><strong>åˆ†æ•¸ä½æ™‚å¯èª¿æ•´ï¼š</strong>System Promptã€æ¨¡å‹é¸æ“‡ã€æª¢ç´¢å“è³ª</div>
                        </div>
                        </div>
                        
                        <div class="metric-item" style="background: rgba(255,255,255,0.3); padding: 15px; border-radius: 8px; margin-bottom: 12px; backdrop-filter: blur(10px);">
                            <label style="display: flex; align-items: center; cursor: pointer; margin: 0;">
                                <input type="checkbox" id="metric-answer-relevancy" style="margin-right: 12px; transform: scale(1.2);">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">Answer Relevancy</div>
                                    <div style="font-size: 14px; opacity: 0.8;">å›æ‡‰çš„ç›¸é—œæ€§</div>
                                </div>
                                <button type="button" onclick="toggleMetricDetails('answer-relevancy')" style="background: rgba(255,255,255,0.4); border: none; color: #333; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">è©³æƒ…</button>
                            </label>
                            <div id="answer-relevancy-details" class="metric-details" style="display: none; margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.3); border-radius: 6px; font-size: 13px;">
                                <div><strong>è©³ç´°èªªæ˜ï¼š</strong>è©•ä¼°å›æ‡‰æ˜¯å¦èˆ‡å•é¡Œç›¸é—œï¼Œæ˜¯å¦å›ç­”äº†ç”¨æˆ¶çš„å•é¡Œã€‚</div>
                                <div style="margin-top: 8px;"><strong>åˆ†æ•¸ä½æ™‚å¯èª¿æ•´ï¼š</strong>System Promptã€å•é¡Œç†è§£ã€å›æ‡‰ç”Ÿæˆç­–ç•¥</div>
                            </div>
                        </div>
                        
                        <div class="metric-item" style="background: rgba(255,255,255,0.3); padding: 15px; border-radius: 8px; margin-bottom: 0; backdrop-filter: blur(10px);">
                            <label style="display: flex; align-items: center; cursor: pointer; margin: 0;">
                                <input type="checkbox" id="metric-response-relevancy" style="margin-right: 12px; transform: scale(1.2);">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">Response Relevancy</div>
                                    <div style="font-size: 14px; opacity: 0.8;">å›æ‡‰çš„æ•´é«”ç›¸é—œæ€§</div>
                                </div>
                                <button type="button" onclick="toggleMetricDetails('response-relevancy')" style="background: rgba(255,255,255,0.4); border: none; color: #333; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">è©³æƒ…</button>
                            </label>
                            <div id="response-relevancy-details" class="metric-details" style="display: none; margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.3); border-radius: 6px; font-size: 13px;">
                                <div><strong>è©³ç´°èªªæ˜ï¼š</strong>è©•ä¼°å›æ‡‰çš„æ•´é«”ç›¸é—œæ€§å’Œæœ‰ç”¨æ€§ã€‚</div>
                                <div style="margin-top: 8px;"><strong>åˆ†æ•¸ä½æ™‚å¯èª¿æ•´ï¼š</strong>æ¨¡å‹é¸æ“‡ã€Promptå·¥ç¨‹ã€å›æ‡‰é•·åº¦æ§åˆ¶</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="button-group" style="margin-top: 30px;">
                        <button type="button" class="btn btn-secondary" onclick="goToStage(1)">
                            ä¸Šä¸€æ­¥
                        </button>
                        <button type="submit" class="btn btn-primary" id="start-evaluation-btn">
                            é–‹å§‹è©•ä¼°
                        </button>
                    </div>
                </form>
                
                <div id="evaluation-result" class="result-box" style="display: none;"></div>
                <div id="evaluation-progress" class="result-box" style="display: none;">
                    <h3>è©•ä¼°é€²åº¦</h3>
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <strong>è©•ä¼°é€²åº¦</strong>
                            <span id="eval-progress-percent">0%</span>
                        </div>
                        <div style="width: 100%; height: 30px; background: #e0e0e0; border-radius: 15px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
                            <div id="eval-progress-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #4caf50, #8bc34a); transition: width 0.5s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;"></div>
                        </div>
                    </div>
                    <div id="progress-log" style="max-height: 400px; overflow-y: auto; background: #f5f5f5; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 14px;">
                        <!-- é€²åº¦æ—¥èªŒå°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let workflowState = {
            currentStage: 0,
            scenario_description: '',
            output_folder: '',
            scenario_name: '',
            personas_json_path: '',
            documents_folder: '',
            workflow_type: 'rag' // Always use RAG mode
        };
        
        // Function to convert Mac local path to container path
        function convertToContainerPath(path) {
            if (!path) return path;
            
            // Remove trailing slashes
            path = path.replace(/\/+$/, '');
            
            // If already a container path, return as is
            if (path.startsWith('/app/')) {
                return path;
            }
            
            // Common patterns to detect and convert
            const patterns = [
                // Match full project path
                {
                    regex: /^\/Users\/[^\/]+\/.*?\/llm-eval-hub\//,
                    replacement: '/app/'
                },
                // Match if path contains llm-eval-hub
                {
                    regex: /.*\/llm-eval-hub\//,
                    replacement: '/app/'
                },
                // Match relative paths
                {
                    regex: /^\.?\/?outputs\//,
                    replacement: '/app/outputs/'
                }
            ];
            
            for (const pattern of patterns) {
                if (pattern.regex.test(path)) {
                    const converted = path.replace(pattern.regex, pattern.replacement);
                    console.log(`è·¯å¾‘è½‰æ›: ${path} -> ${converted}`);
                    return converted;
                }
            }
            
            // If no pattern matched but looks like an absolute Mac path, try to extract relevant part
            if (path.startsWith('/Users/') && path.includes('/outputs/')) {
                const outputsIndex = path.indexOf('/outputs/');
                const converted = '/app' + path.substring(outputsIndex);
                console.log(`è·¯å¾‘è½‰æ›: ${path} -> ${converted}`);
                return converted;
            }
            
            return path;
        }
        
        // Normalize output folder path when user finishes editing
        function normalizeOutputFolderPath() {
            const input = document.getElementById('output-folder');
            const originalPath = input.value;
            const convertedPath = convertToContainerPath(originalPath);
            
            if (originalPath !== convertedPath) {
                input.value = convertedPath;
                // Show notification
                const notification = document.createElement('div');
                notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #4caf50; color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000; animation: slideIn 0.3s ease-out;';
                notification.innerHTML = `âœ… è·¯å¾‘å·²è‡ªå‹•è½‰æ›ï¼š<br><small>${originalPath}</small><br>â†’<br><small>${convertedPath}</small>`;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease-in';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
        }

        // Stage navigation
        function goToStage(stageNum) {
            // Update steps indicator
            document.querySelectorAll('.step').forEach((step, index) => {
                step.classList.remove('active');
                if (index < stageNum) {
                    step.classList.add('completed');
                } else if (index === stageNum) {
                    step.classList.add('active');
                } else {
                    step.classList.remove('completed');
                }
            });
            
            // Update content
            document.querySelectorAll('.stage-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });
            const targetStage = document.getElementById(`stage-${stageNum}`);
            if (targetStage) {
                targetStage.classList.add('active');
                targetStage.style.display = 'block';
            }
            
            workflowState.currentStage = stageNum;
            
            // Initialize RAG testset form when entering stage 1
            if (stageNum === 1) {
                initializeRAGTestsetForm();
            }
        }

        // Handle personas form submission
        document.getElementById('personas-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const btn = document.getElementById('generate-personas-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> ç”Ÿæˆä¸­...';
            
            // Show progress area with progress bar
            const resultBox = document.getElementById('personas-result');
            resultBox.style.display = 'block';
            resultBox.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <strong>ç”Ÿæˆé€²åº¦</strong>
                        <span id="persona-progress-percent">0%</span>
                    </div>
                    <div style="width: 100%; height: 25px; background: #e0e0e0; border-radius: 12px; overflow: hidden;">
                        <div id="persona-progress-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;"></div>
                    </div>
                </div>
                <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 14px; max-height: 300px; overflow-y: auto;" id="persona-progress-log">
                    <div style="color: #1976d2; margin-bottom: 5px;">[${new Date().toLocaleTimeString('zh-TW')}] ğŸš€ é–‹å§‹ç”Ÿæˆç”¨æˆ¶è§’è‰²...</div>
                </div>
            `;
            
            const formData = {
                scenario_description: document.getElementById('scenario-description').value,
                num_personas: parseInt(document.getElementById('num-personas').value),
                output_folder: document.getElementById('output-folder').value,
                scenario_name: document.getElementById('scenario-name')?.value || null,  // Optional, auto-generated if empty
                model_provider: document.getElementById('persona-model-provider').value,
                model_name: document.getElementById('persona-model-name').value,
                language: 'ç¹é«”ä¸­æ–‡'
            };
            
            // Store in state
            workflowState.scenario_description = formData.scenario_description;
            workflowState.output_folder = formData.output_folder;
            workflowState.scenario_name = formData.scenario_name;
            
            // Helper to add log
            function addPersonaLog(message, type = 'info') {
                const log = document.getElementById('persona-progress-log');
                if (log) {
                    const color = type === 'error' ? '#d32f2f' : type === 'success' ? '#388e3c' : '#1976d2';
                    log.innerHTML += `<div style="color: ${color}; margin-bottom: 5px;">[${new Date().toLocaleTimeString('zh-TW')}] ${message}</div>`;
                    log.scrollTop = log.scrollHeight;
                }
            }
            
            // Progress update helper
            function updateProgress(percent, text = '') {
                const bar = document.getElementById('persona-progress-bar');
                const percentText = document.getElementById('persona-progress-percent');
                if (bar && percentText) {
                    bar.style.width = percent + '%';
                    bar.textContent = text || (percent + '%');
                    percentText.textContent = percent + '%';
                }
            }
            
            try {
                updateProgress(10, 'åˆå§‹åŒ–...');
                addPersonaLog(`ğŸ“ æº–å‚™ç”Ÿæˆ ${formData.num_personas} å€‹è§’è‰²...`);
                addPersonaLog(`ğŸ¤– ä½¿ç”¨æ¨¡å‹: ${formData.model_provider}/${formData.model_name}`);
                
                updateProgress(20, 'é€£æ¥ API...');
                
                // Simulate progress during API call
                const progressInterval = setInterval(() => {
                    const currentBar = document.getElementById('persona-progress-bar');
                    if (currentBar) {
                        const currentWidth = parseFloat(currentBar.style.width) || 20;
                        if (currentWidth < 80) {
                            updateProgress(currentWidth + 5, 'ç”Ÿæˆä¸­...');
                        }
                    }
                }, 2000);  // Update every 2 seconds
                
                const response = await fetch('/api/v1/testset/workflow/generate-personas', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                clearInterval(progressInterval);
                updateProgress(90, 'è™•ç†çµæœ...');
                
                const result = await response.json();
                
                addPersonaLog('â³ è™•ç† API å›æ‡‰...');
                
                if (result.success) {
                    updateProgress(100, 'âœ… å®Œæˆ');
                    addPersonaLog(`âœ… æˆåŠŸç”Ÿæˆ ${result.total_personas} å€‹è§’è‰²ï¼`, 'success');
                    addPersonaLog(`ğŸ’¾ ä¿å­˜è‡³: ${result.personas_folder}`);
                    
                    // Store paths and personas
                    workflowState.personas_json_path = result.json_file;
                    workflowState.scenario_name = result.scenario_name;
                    workflowState.personas = result.personas || result.personas_preview || [];
                    
                    // Wait a bit for visual effect
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // Show result with improved persona preview
                    const resultBox = document.getElementById('personas-result');
                    resultBox.style.display = 'block';
                    
                    // Store personas in workflowState for editing
                    workflowState.personas = result.personas || result.personas_preview || [];
                    
                    // Generate persona cards - show all personas with edit capability
                    let personaCards = '';
                    const allPersonas = result.personas || result.personas_preview || [];
                    
                    allPersonas.forEach((persona, index) => {
                        const personaId = persona.persona_id || `persona_${index}`;
                        personaCards += `
                            <div id="persona-card-${index}" style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #f9f9f9;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <h4 style="margin: 0; color: #667eea;">
                                        <span id="persona-name-${index}">${persona.persona_name || personaId}</span>
                                    </h4>
                                    <div style="display: flex; gap: 5px;">
                                        <button type="button" class="btn btn-secondary" style="font-size: 12px; padding: 5px 10px;" 
                                            onclick="togglePersonaEdit(${index})" id="edit-btn-${index}">
                                            ç·¨è¼¯
                                        </button>
                                        <button type="button" class="btn btn-secondary" style="font-size: 12px; padding: 5px 10px;" 
                                            onclick="togglePersonaDetails(${index})" id="details-btn-${index}">
                                            é¡¯ç¤ºè©³ç´°
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- åŸºæœ¬æ‘˜è¦ï¼ˆå¯ç·¨è¼¯ï¼‰ -->
                                <div id="persona-summary-${index}" style="margin-bottom: 10px;">
                                    ${persona.basic_info ? `
                                        <p style="margin: 5px 0;"><strong>å¹´é½¡ï¼š</strong><span id="persona-age-${index}">${persona.basic_info.age || 'N/A'}</span></p>
                                        <p style="margin: 5px 0;"><strong>è·æ¥­ï¼š</strong><span id="persona-occupation-${index}">${persona.basic_info.occupation || 'N/A'}</span></p>
                                        <p style="margin: 5px 0;"><strong>å±…ä½åœ°ï¼š</strong><span id="persona-location-${index}">${persona.basic_info.location || 'N/A'}</span></p>
                                    ` : ''}
                                </div>
                                
                                <!-- ç·¨è¼¯è¡¨å–®ï¼ˆé è¨­éš±è—ï¼‰ -->
                                <div id="persona-edit-${index}" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                                    <textarea id="persona-json-${index}" style="width: 100%; min-height: 300px; font-family: monospace; font-size: 12px; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">${JSON.stringify(persona, null, 2)}</textarea>
                                    <div style="margin-top: 10px; display: flex; gap: 10px;">
                                        <button type="button" class="btn btn-primary" onclick="savePersonaEdit(${index})">ä¿å­˜</button>
                                        <button type="button" class="btn btn-secondary" onclick="cancelPersonaEdit(${index})">å–æ¶ˆ</button>
                                    </div>
                                </div>
                                
                                <!-- è©³ç´°å…§å®¹ï¼ˆé è¨­æŠ˜ç–Šï¼‰ -->
                                <div id="persona-details-${index}" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                                    <pre style="background: white; padding: 10px; border-radius: 4px; font-size: 12px; max-height: 400px; overflow-y: auto;">${JSON.stringify(persona, null, 2)}</pre>
                                </div>
                            </div>
                        `;
                    });
                    
                    resultBox.innerHTML = `
                        <div class="alert alert-success">
                            âœ… æˆåŠŸç”Ÿæˆ ${result.total_personas} å€‹ç”¨æˆ¶è§’è‰²ï¼
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                            <div>
                                <h3>ç”Ÿæˆçµæœ</h3>
                                <p><strong>æƒ…å¢ƒåç¨±ï¼š</strong>${result.scenario_name}</p>
                                <p><strong>è§’è‰²æª”æ¡ˆä½ç½®ï¼š</strong>${result.personas_folder}</p>
                                <p><strong>JSON æª”æ¡ˆï¼š</strong>${result.json_file}</p>
                            </div>
                        </div>
                        
                        <h4 style="margin-top: 20px; margin-bottom: 15px;">æ‰€æœ‰ç”Ÿæˆçš„ç”¨æˆ¶è§’è‰²ï¼ˆå…± ${allPersonas.length} å€‹ï¼‰ï¼š</h4>
                        <p style="margin-bottom: 15px; color: #666;">æ‚¨å¯ä»¥ç·¨è¼¯æ¯å€‹è§’è‰²çš„è©³ç´°è³‡è¨Šï¼Œç·¨è¼¯å¾Œé»æ“Šã€Œä¿å­˜ã€æŒ‰éˆ•ã€‚</p>
                        ${personaCards}
                        
                        <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border: 1px solid #ffc107;">
                            <strong>ğŸ’¡ æç¤ºï¼š</strong> ç·¨è¼¯å®Œæˆå¾Œï¼Œè«‹é»æ“Šã€Œä¿å­˜ã€æŒ‰éˆ•ä»¥æ›´æ–°è§’è‰²è³‡è¨Šã€‚æ‰€æœ‰è®Šæ›´å°‡åœ¨ç”Ÿæˆæ¸¬è©¦é›†æ™‚ä½¿ç”¨ã€‚
                        </div>
                        
                        <div id="doc-generation-status" style="margin-top: 20px; padding: 15px; background: #f0f8ff; border-radius: 8px;">
                            <p>â³ æ­£åœ¨è‡ªå‹•ç”Ÿæˆæ–‡ä»¶...</p>
                        </div>
                    `;
                    
                    // Auto-generate documents after personas
                    setTimeout(() => generateDocumentsAfterPersonas(result.scenario_name), 1000);
                } else {
                    throw new Error(result.error || 'ç”Ÿæˆå¤±æ•—');
                }
            } catch (error) {
                const resultBox = document.getElementById('personas-result');
                resultBox.style.display = 'block';
                resultBox.innerHTML = `
                    <div class="alert alert-error">
                        âŒ éŒ¯èª¤ï¼š${error.message}
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.textContent = 'é–‹å§‹ç”Ÿæˆè§’è‰²';
            }
        });

        // Documents form submission is now handled within personas-form (stage-0)
        // The documents are generated automatically after personas generation
        // Old documents-form event listener removed - form merged into stage-0
        /*
        document.getElementById('documents-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const btn = document.getElementById('generate-documents-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> ç”Ÿæˆä¸­...';
            
            const formData = {
                scenario_description: workflowState.scenario_description,
                num_documents: parseInt(document.getElementById('num-documents').value),
                output_folder: workflowState.output_folder,
                scenario_name: workflowState.scenario_name,
                model_provider: document.getElementById('doc-model-provider').value,
                model_name: document.getElementById('doc-model-name').value,
                language: 'ç¹é«”ä¸­æ–‡'
            };
            
            try {
                const response = await fetch('/api/v1/testset/workflow/generate-documents', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Store paths and documents
                    workflowState.documents_folder = result.documents_folder;
                    workflowState.documents_metadata_file = result.metadata_file;
                    workflowState.documents = result.documents || result.documents_preview || [];
                    
                    // Show documents with edit capability
                    const resultBox = document.getElementById('documents-result');
                    resultBox.style.display = 'block';
                    showDocumentsWithEdit(result.documents || result.documents_preview || [], result);
                } else {
                    throw new Error(result.error || 'ç”Ÿæˆå¤±æ•—');
                }
            } catch (error) {
                const resultBox = document.getElementById('documents-result');
                resultBox.style.display = 'block';
                resultBox.innerHTML = `
                    <div class="alert alert-error">
                        âŒ éŒ¯èª¤ï¼š${error.message}
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.textContent = 'ç”Ÿæˆæ–‡ä»¶';
            }
        });
        */

        // Show documents with edit capability (similar to showPersonasWithEdit)
        // Define this early to ensure it's available when called
        function showDocumentsWithEdit(documents, result) {
            // Try multiple possible container IDs - doc-generation-status is used during auto-generation
            let targetDiv = document.getElementById('documents-result') || 
                           document.getElementById('documents-status') || 
                           document.getElementById('doc-generation-status');
            
            if (!targetDiv) {
                console.warn('Cannot find documents display container. Trying to create one after personas-result...');
                // Try to find personas-result and append after it
                const personasResult = document.getElementById('personas-result');
                if (personasResult) {
                    const newDiv = document.createElement('div');
                    newDiv.id = 'documents-result';
                    newDiv.style.marginTop = '30px';
                    personasResult.parentNode.insertBefore(newDiv, personasResult.nextSibling);
                    targetDiv = newDiv;
                } else {
                    console.error('Cannot find personas-result either. Cannot display documents.');
                    alert('ç„¡æ³•æ‰¾åˆ°é¡¯ç¤ºå€åŸŸï¼Œè«‹åˆ·æ–°é é¢é‡è©¦');
                    return;
                }
            }
            
            targetDiv.style.display = 'block';
            
            let documentCards = '';
            documents.forEach((doc, index) => {
                const docId = doc.document_id || `doc_${String(index + 1).padStart(3, '0')}`;
                const title = doc.title || 'Untitled';
                documentCards += `
                    <div id="document-card-${index}" style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #f9f9f9;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="margin: 0; color: #667eea;">
                                <span id="document-title-${index}">${title}</span>
                            </h4>
                            <div style="display: flex; gap: 5px;">
                                <button type="button" class="btn btn-secondary" style="font-size: 12px; padding: 5px 10px;" 
                                    onclick="toggleDocumentEdit(${index})" id="doc-edit-btn-${index}">
                                    ç·¨è¼¯
                                </button>
                                <button type="button" class="btn btn-secondary" style="font-size: 12px; padding: 5px 10px;" 
                                    onclick="toggleDocumentDetails(${index})" id="doc-details-btn-${index}">
                                    é¡¯ç¤ºè©³ç´°
                                </button>
                            </div>
                        </div>
                        <div id="document-summary-${index}" style="margin-bottom: 10px;">
                            <p style="margin: 5px 0;"><strong>åˆ†é¡ï¼š</strong><span id="doc-category-${index}">${doc.category || 'N/A'}</span></p>
                            <p style="margin: 5px 0;"><strong>ç›®æ¨™å—çœ¾ï¼š</strong><span id="doc-audience-${index}">${doc.target_audience || 'N/A'}</span></p>
                            <p style="margin: 5px 0;"><strong>è¤‡é›œåº¦ï¼š</strong><span id="doc-complexity-${index}">${doc.complexity_level || 'N/A'}</span></p>
                            <p style="margin: 5px 0;"><strong>å…§å®¹é è¦½ï¼š</strong><span id="doc-content-preview-${index}">${(doc.content || '').substring(0, 100)}${(doc.content || '').length > 100 ? '...' : ''}</span></p>
                        </div>
                        <div id="document-edit-${index}" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                            <textarea id="document-json-${index}" style="width: 100%; min-height: 400px; font-family: monospace; font-size: 12px; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">${JSON.stringify(doc, null, 2)}</textarea>
                            <div style="margin-top: 10px; display: flex; gap: 10px;">
                                <button type="button" class="btn btn-primary" onclick="saveDocumentEdit(${index})">ä¿å­˜</button>
                                <button type="button" class="btn btn-secondary" onclick="cancelDocumentEdit(${index})">å–æ¶ˆ</button>
                            </div>
                        </div>
                        <div id="document-details-${index}" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                            <pre style="background: white; padding: 10px; border-radius: 4px; font-size: 12px; max-height: 400px; overflow-y: auto;">${JSON.stringify(doc, null, 2)}</pre>
                        </div>
                    </div>
                `;
            });
            
            const htmlContent = `
                <div class="alert alert-success">
                    âœ… å·²è¼‰å…¥ ${documents.length} ä»½æ–‡ä»¶ï¼
                </div>
                <h4 style="margin-top: 20px; margin-bottom: 15px;">æ‰€æœ‰æ–‡ä»¶ï¼ˆå…± ${documents.length} ä»½ï¼‰ï¼š</h4>
                <p style="margin-bottom: 15px; color: #666;">æ‚¨å¯ä»¥ç·¨è¼¯æ¯ä»½æ–‡ä»¶çš„è©³ç´°è³‡è¨Šï¼Œç·¨è¼¯å¾Œé»æ“Šã€Œä¿å­˜ã€æŒ‰éˆ•ã€‚</p>
                ${documentCards}
                <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border: 1px solid #ffc107;">
                    <strong>ğŸ’¡ æç¤ºï¼š</strong> ç·¨è¼¯å®Œæˆå¾Œï¼Œè«‹é»æ“Šã€Œä¿å­˜ã€æŒ‰éˆ•ä»¥æ›´æ–°æ–‡ä»¶è³‡è¨Šã€‚æ‰€æœ‰è®Šæ›´å°‡åœ¨ç”Ÿæˆæ¸¬è©¦é›†æ™‚ä½¿ç”¨ã€‚
                </div>
                <div style="margin-top: 30px; padding: 20px; background: #f0f8ff; border-radius: 8px; border: 2px solid #667eea; text-align: center;">
                    <p style="margin-bottom: 15px; font-size: 16px; color: #333;">æº–å‚™å¥½ç”Ÿæˆæ¸¬è©¦é›†äº†å—ï¼Ÿ</p>
                    <div class="button-group" style="display: flex; gap: 15px; justify-content: center;">
                        <button type="button" class="btn btn-primary" onclick="goToStage(1)" style="padding: 12px 30px; font-size: 16px;">
                            ğŸš€ ä¸‹ä¸€æ­¥ï¼šç”Ÿæˆæ¸¬è©¦é›†
                        </button>
                    </div>
                </div>
            `;
            
            // Set innerHTML to the target div
            targetDiv.innerHTML = htmlContent;
            targetDiv.style.display = 'block';
            
            // Scroll to the documents section
            setTimeout(() => {
                targetDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }
        
        // Toggle document edit mode
        function toggleDocumentEdit(index) {
            const editDiv = document.getElementById(`document-edit-${index}`);
            const detailsDiv = document.getElementById(`document-details-${index}`);
            const summaryDiv = document.getElementById(`document-summary-${index}`);
            const editBtn = document.getElementById(`doc-edit-btn-${index}`);
            
            if (editDiv && editDiv.style.display === 'none') {
                editDiv.style.display = 'block';
                if (detailsDiv) detailsDiv.style.display = 'none';
                if (summaryDiv) summaryDiv.style.display = 'none';
                if (editBtn) editBtn.textContent = 'å–æ¶ˆç·¨è¼¯';
            } else if (editDiv) {
                editDiv.style.display = 'none';
                if (summaryDiv) summaryDiv.style.display = 'block';
                if (editBtn) editBtn.textContent = 'ç·¨è¼¯';
            }
        }
        
        // Toggle document details
        function toggleDocumentDetails(index) {
            const detailsDiv = document.getElementById(`document-details-${index}`);
            const editDiv = document.getElementById(`document-edit-${index}`);
            const summaryDiv = document.getElementById(`document-summary-${index}`);
            const detailsBtn = document.getElementById(`doc-details-btn-${index}`);
            
            if (detailsDiv && detailsDiv.style.display === 'none') {
                detailsDiv.style.display = 'block';
                if (editDiv) editDiv.style.display = 'none';
                if (summaryDiv) summaryDiv.style.display = 'none';
                if (detailsBtn) detailsBtn.textContent = 'éš±è—è©³ç´°';
            } else if (detailsDiv) {
                detailsDiv.style.display = 'none';
                if (summaryDiv) summaryDiv.style.display = 'block';
                if (detailsBtn) detailsBtn.textContent = 'é¡¯ç¤ºè©³ç´°';
            }
        }
        
        // Cancel document edit
        function cancelDocumentEdit(index) {
            if (workflowState.documents && workflowState.documents[index]) {
                const originalDoc = workflowState.documents[index];
                document.getElementById(`document-json-${index}`).value = JSON.stringify(originalDoc, null, 2);
            }
            toggleDocumentEdit(index);
        }
        
        // Save document edit
        async function saveDocumentEdit(index) {
            try {
                const jsonText = document.getElementById(`document-json-${index}`).value;
                const updatedDocument = JSON.parse(jsonText);
                
                // Update workflowState
                if (workflowState.documents && workflowState.documents[index]) {
                    workflowState.documents[index] = updatedDocument;
                }
                
                // Update display
                const titleEl = document.getElementById(`document-title-${index}`);
                const categoryEl = document.getElementById(`doc-category-${index}`);
                const audienceEl = document.getElementById(`doc-audience-${index}`);
                const complexityEl = document.getElementById(`doc-complexity-${index}`);
                const previewEl = document.getElementById(`doc-content-preview-${index}`);
                
                if (titleEl) titleEl.textContent = updatedDocument.title || 'Untitled';
                if (categoryEl) categoryEl.textContent = updatedDocument.category || 'N/A';
                if (audienceEl) audienceEl.textContent = updatedDocument.target_audience || 'N/A';
                if (complexityEl) complexityEl.textContent = updatedDocument.complexity_level || 'N/A';
                if (previewEl) {
                    const content = updatedDocument.content || '';
                    previewEl.textContent = content.substring(0, 100) + (content.length > 100 ? '...' : '');
                }
                
                // Save to backend
                if (workflowState.documents_metadata_file && workflowState.documents) {
                    const response = await fetch('/api/v1/testset/workflow/update-documents', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            metadata_file: workflowState.documents_metadata_file,
                            documents: workflowState.documents
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        alert('âœ… æ–‡ä»¶å·²æˆåŠŸä¿å­˜ï¼');
                        toggleDocumentEdit(index);
                    } else {
                        throw new Error(result.error || 'ä¿å­˜å¤±æ•—');
                    }
                } else {
                    alert('âš ï¸ è­¦å‘Šï¼šç„¡æ³•ä¿å­˜ï¼Œç¼ºå°‘å¿…è¦çš„è·¯å¾‘è³‡è¨Š');
                }
            } catch (error) {
                console.error('Error saving document:', error);
                alert(`âŒ ä¿å­˜å¤±æ•—ï¼š${error.message}`);
            }
        }
        
        // Initialize RAG testset form when stage 1 is shown
        function initializeRAGTestsetForm() {
            // Update documents folder option text
            const workflowOption = document.getElementById('rag-workflow-docs-option');
            if (workflowOption) {
                workflowOption.textContent = `ä½¿ç”¨å·¥ä½œæµç¨‹ç”Ÿæˆçš„æ–‡ä»¶ (${workflowState.documents_folder || 'æœªç”Ÿæˆ'})`;
            }
            
            // Load documents list if in custom mode
            const useCustom = document.getElementById('rag-use-custom-docs')?.value === 'custom';
            if (useCustom && workflowState.output_folder && workflowState.scenario_name) {
                loadRAGDocumentsList();
            }
            
            // Add event listener for RAG testset form if not already added
            const ragForm = document.getElementById('rag-testset-form');
            if (ragForm && !ragForm.hasAttribute('data-listener-added')) {
                ragForm.addEventListener('submit', handleRAGTestsetSubmit);
                ragForm.setAttribute('data-listener-added', 'true');
            }
        }

        // Toggle custom docs input for RAG
        function toggleRAGCustomDocsInput() {
            const useCustom = document.getElementById('rag-use-custom-docs').value === 'custom';
            const customInput = document.getElementById('rag-custom-docs-input');
            const selectionDiv = document.getElementById('rag-documents-selection');
            
            customInput.style.display = useCustom ? 'block' : 'none';
            selectionDiv.style.display = useCustom ? 'block' : 'none';
            
            // Load documents list when switching to custom mode
            if (useCustom && workflowState.output_folder && workflowState.scenario_name) {
                loadRAGDocumentsList();
            }
        }
        
        // Upload files to 02_documents folder
        async function uploadRAGFiles() {
            const fileInput = document.getElementById('rag-file-upload');
            const files = fileInput.files;
            const statusDiv = document.getElementById('rag-upload-status');
            
            if (!files || files.length === 0) {
                alert('è«‹å…ˆé¸æ“‡è¦ä¸Šå‚³çš„æ–‡ä»¶');
                return;
            }
            
            if (!workflowState.output_folder || !workflowState.scenario_name) {
                alert('è«‹å…ˆå®Œæˆå‰é¢çš„æ­¥é©Ÿï¼ˆç”Ÿæˆè§’è‰²å’Œæ–‡ä»¶ï¼‰');
                return;
            }
            
            statusDiv.style.display = 'block';
            statusDiv.className = 'alert alert-info';
            statusDiv.innerHTML = `ğŸ“¤ æ­£åœ¨ä¸Šå‚³ ${files.length} å€‹æ–‡ä»¶...`;
            
            try {
                const formData = new FormData();
                Array.from(files).forEach(file => {
                    formData.append('files', file);
                });
                formData.append('output_folder', workflowState.output_folder);
                formData.append('scenario_name', workflowState.scenario_name);
                
                const response = await fetch('/api/v1/testset/workflow/upload-documents', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    statusDiv.className = 'alert alert-success';
                    statusDiv.innerHTML = `âœ… æˆåŠŸä¸Šå‚³ ${result.uploaded_count} å€‹æ–‡ä»¶åˆ° 02_documents è³‡æ–™å¤¾ï¼`;
                    
                    // Clear file input
                    fileInput.value = '';
                    
                    // Reload documents list
                    await loadRAGDocumentsList();
                } else {
                    throw new Error(result.error || 'ä¸Šå‚³å¤±æ•—');
                }
            } catch (error) {
                statusDiv.className = 'alert alert-error';
                statusDiv.innerHTML = `âŒ ä¸Šå‚³å¤±æ•—ï¼š${error.message}`;
            }
        }
        
        // Load documents list from 02_documents folder
        async function loadRAGDocumentsList() {
            const listDiv = document.getElementById('rag-documents-list');
            if (!listDiv) return;
            
            if (!workflowState.output_folder || !workflowState.scenario_name) {
                listDiv.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">è«‹å…ˆå®Œæˆå‰é¢çš„æ­¥é©Ÿ</p>';
                return;
            }
            
            listDiv.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">è¼‰å…¥ä¸­...</p>';
            
            try {
                const response = await fetch('/api/v1/testset/workflow/list-documents', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        output_folder: workflowState.output_folder,
                        scenario_name: workflowState.scenario_name
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.files && result.files.length > 0) {
                    let checkboxes = '';
                    result.files.forEach((file, index) => {
                        const fileSize = file.size ? `(${(file.size / 1024).toFixed(1)} KB)` : '';
                        checkboxes += `
                            <div style="padding: 8px; margin: 5px 0; background: white; border-radius: 4px; display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="rag-doc-${index}" value="${file.name}" checked style="cursor: pointer; width: 18px; height: 18px; min-width: 18px; flex-shrink: 0;">
                                <label for="rag-doc-${index}" style="flex: 1; cursor: pointer; margin: 0; font-size: 14px;">
                                    <strong>${file.name}</strong> ${fileSize}
                                </label>
                            </div>
                        `;
                    });
                    
                    listDiv.innerHTML = `
                        <div style="margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                            <span><strong>å…± ${result.files.length} å€‹æ–‡ä»¶</strong></span>
                            <div>
                                <button type="button" class="btn btn-secondary" style="font-size: 12px; padding: 5px 10px;" onclick="selectAllRAGDocuments(true)">å…¨é¸</button>
                                <button type="button" class="btn btn-secondary" style="font-size: 12px; padding: 5px 10px;" onclick="selectAllRAGDocuments(false)">å…¨ä¸é¸</button>
                            </div>
                        </div>
                        ${checkboxes}
                    `;
                } else {
                    listDiv.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">02_documents è³‡æ–™å¤¾ä¸­æ²’æœ‰æ–‡ä»¶</p>';
                }
            } catch (error) {
                listDiv.innerHTML = `<p style="color: #d32f2f; text-align: center; padding: 20px;">è¼‰å…¥å¤±æ•—ï¼š${error.message}</p>`;
            }
        }
        
        // Select/deselect all documents
        function selectAllRAGDocuments(select) {
            const checkboxes = document.querySelectorAll('#rag-documents-list input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = select);
        }
        
        // Get selected documents
        function getSelectedRAGDocuments() {
            const checkboxes = document.querySelectorAll('#rag-documents-list input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }
        
        // Normalize RAG custom docs path
        function normalizeRAGCustomDocsPath() {
            const input = document.getElementById('rag-custom-docs-folder');
            if (!input.value) return;
            
            const originalPath = input.value;
            const convertedPath = convertToContainerPath(originalPath);
            
            if (originalPath !== convertedPath) {
                input.value = convertedPath;
                showPathConversionNotification(originalPath, convertedPath);
            }
        }
        
        // Show path conversion notification
        function showPathConversionNotification(originalPath, convertedPath) {
            const notification = document.createElement('div');
            notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #4caf50; color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000;';
            notification.innerHTML = `âœ… è·¯å¾‘å·²è‡ªå‹•è½‰æ›ï¼š<br><small>${originalPath}</small><br>â†’<br><small>${convertedPath}</small>`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Handle RAG folder selection
        function handleRAGFolderSelect(event) {
            const files = event.target.files;
            const infoDiv = document.getElementById('rag-folder-info');
            
            if (files.length > 0) {
                // Get the folder path from the first file
                const firstFile = files[0];
                const folderPath = firstFile.webkitRelativePath.split('/')[0];
                
                // Count different file types
                const fileTypes = {};
                Array.from(files).forEach(file => {
                    const ext = file.name.split('.').pop().toLowerCase();
                    fileTypes[ext] = (fileTypes[ext] || 0) + 1;
                });
                
                const fileTypeInfo = Object.entries(fileTypes)
                    .map(([ext, count]) => `${ext}: ${count}`)
                    .join(', ');
                
                infoDiv.innerHTML = `
                    <strong>ğŸ“ å·²é¸æ“‡è³‡æ–™å¤¾: ${folderPath}</strong><br>
                    <strong>ğŸ“„ åŒ…å« ${files.length} å€‹æª”æ¡ˆ</strong><br>
                    <strong>ğŸ“‹ æª”æ¡ˆé¡å‹: ${fileTypeInfo}</strong>
                `;
                infoDiv.style.display = 'block';
            } else {
                infoDiv.style.display = 'none';
            }
        }
        
        // Handle RAG testset submission
        async function handleRAGTestsetSubmit(e) {
            e.preventDefault();
            
            const btn = document.getElementById('generate-rag-testset-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> ç”Ÿæˆä¸­...';
            
            // Show progress
            const resultBox = document.getElementById('rag-testset-result');
            resultBox.style.display = 'block';
            resultBox.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <strong>RAG æ¸¬è©¦é›†ç”Ÿæˆé€²åº¦</strong>
                        <span id="rag-progress-percent">0%</span>
                    </div>
                    <div style="width: 100%; height: 25px; background: #e0e0e0; border-radius: 12px; overflow: hidden;">
                        <div id="rag-progress-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #2196f3, #03a9f4); transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;"></div>
                    </div>
                </div>
            `;
            
            function updateRAGProgress(percent, text = '') {
                const bar = document.getElementById('rag-progress-bar');
                const percentText = document.getElementById('rag-progress-percent');
                if (bar && percentText) {
                    bar.style.width = percent + '%';
                    bar.textContent = text || (percent + '%');
                    percentText.textContent = percent + '%';
                }
            }
            
            // Determine documents folder and selected files
            const useCustom = document.getElementById('rag-use-custom-docs').value === 'custom';
            let documentsFolder = useCustom 
                ? null  // Will use project's 02_documents folder
                : workflowState.documents_folder;
            
            // If using custom, get selected files
            let selected_files = null;
            if (useCustom) {
                selected_files = getSelectedRAGDocuments();
                if (selected_files.length === 0) {
                    alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æ–‡ä»¶');
                    return;
                }
                // Use project's 02_documents folder
                // Use OutputManager to get the correct scenario folder path
                if (workflowState.output_folder && workflowState.scenario_name) {
                    // Get the correct scenario folder path from backend
                    try {
                        const pathResponse = await fetch('/api/v1/testset/workflow/get-scenario-folder', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                output_folder: workflowState.output_folder,
                                scenario_name: workflowState.scenario_name
                            })
                        });
                        const pathResult = await pathResponse.json();
                        if (pathResult.success) {
                            documentsFolder = `${pathResult.scenario_folder}/02_documents`;
                        } else {
                            throw new Error(pathResult.error || 'Failed to get scenario folder path');
                        }
                    } catch (error) {
                        console.error('Error getting scenario folder path:', error);
                        alert(`ç„¡æ³•ç²å–å°ˆæ¡ˆè³‡æ–™å¤¾è·¯å¾‘ï¼š${error.message}`);
                        return;
                    }
                } else {
                    alert('è«‹å…ˆå®Œæˆå‰é¢çš„æ­¥é©Ÿï¼ˆç”Ÿæˆè§’è‰²å’Œæ–‡ä»¶ï¼‰');
                    return;
                }
            }
            
            const formData = {
                documents_folder: documentsFolder,
                personas_json_path: workflowState.personas_json_path,
                output_folder: workflowState.output_folder,
                scenario_name: workflowState.scenario_name,
                model_provider: document.getElementById('rag-model-provider').value,
                model_name: document.getElementById('rag-model-name').value,
                language: 'ç¹é«”ä¸­æ–‡',
                chunk_size: parseInt(document.getElementById('rag-chunk-size').value),
                chunk_overlap: parseInt(document.getElementById('rag-chunk-overlap').value),
                qa_per_chunk: parseInt(document.getElementById('rag-qa-per-chunk').value),
                selected_files: selected_files  // List of selected file names
            };
            
            try {
                // Initialize progress display
                const resultBox = document.getElementById('rag-testset-result');
                resultBox.style.display = 'block';
                
                // Show input files info before starting
                let inputFilesInfo = '';
                if (selected_files && selected_files.length > 0) {
                    inputFilesInfo = `
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #2196f3;">
                            <h4 style="margin: 0 0 10px 0; color: #1976d2;">ğŸ“‹ è¼¸å…¥æ–‡ä»¶è³‡è¨Š</h4>
                            <p style="margin: 5px 0;"><strong>é¸æ“‡çš„æ–‡ä»¶ï¼ˆ${selected_files.length} å€‹ï¼‰ï¼š</strong></p>
                            <ul style="margin: 5px 0; padding-left: 20px;">
                                ${selected_files.map(f => `<li>${f}</li>`).join('')}
                            </ul>
                            <p style="margin: 5px 0;"><strong>æ–‡ä»¶åˆ†å¡Šå¤§å°ï¼š</strong>${formData.chunk_size}</p>
                            <p style="margin: 5px 0;"><strong>åˆ†å¡Šé‡ç–Šï¼š</strong>${formData.chunk_overlap}</p>
                            <p style="margin: 5px 0;"><strong>æ¯å€‹åˆ†å¡Šçš„ QA æ•¸é‡ï¼š</strong>${formData.qa_per_chunk}</p>
                        </div>
                    `;
                } else {
                    inputFilesInfo = `
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #2196f3;">
                            <h4 style="margin: 0 0 10px 0; color: #1976d2;">ğŸ“‹ è¼¸å…¥æ–‡ä»¶è³‡è¨Š</h4>
                            <p style="margin: 5px 0;"><strong>ä½¿ç”¨æ–‡ä»¶ï¼š</strong>å…¨éƒ¨æ–‡ä»¶</p>
                            <p style="margin: 5px 0;"><strong>æ–‡ä»¶è³‡æ–™å¤¾ï¼š</strong>${formData.documents_folder}</p>
                            <p style="margin: 5px 0;"><strong>æ–‡ä»¶åˆ†å¡Šå¤§å°ï¼š</strong>${formData.chunk_size}</p>
                            <p style="margin: 5px 0;"><strong>åˆ†å¡Šé‡ç–Šï¼š</strong>${formData.chunk_overlap}</p>
                            <p style="margin: 5px 0;"><strong>æ¯å€‹åˆ†å¡Šçš„ QA æ•¸é‡ï¼š</strong>${formData.qa_per_chunk}</p>
                        </div>
                    `;
                }
                
                resultBox.innerHTML = `
                    ${inputFilesInfo}
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <strong>RAG æ¸¬è©¦é›†ç”Ÿæˆé€²åº¦</strong>
                            <span id="rag-progress-percent" style="color: #4caf50;">0%</span>
                        </div>
                        <div style="width: 100%; height: 25px; background: #e0e0e0; border-radius: 12px; overflow: hidden;">
                            <div id="rag-progress-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #4caf50, #8bc34a); transition: width 0.3s;"></div>
                        </div>
                    </div>
                    <div id="rag-progress-message" style="margin-bottom: 10px; color: #666;">é€£æ¥ API...</div>
                    <div id="rag-generation-info" style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 10px; display: none;">
                        <div style="font-weight: bold; margin-bottom: 5px;">ğŸ“Š ç”Ÿæˆè³‡è¨Šï¼š</div>
                        <div id="rag-generation-info-content" style="font-size: 12px;"></div>
                    </div>
                    <div id="rag-qa-pairs-list" style="max-height: 300px; overflow-y: auto; margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 5px;">
                        <div style="font-weight: bold; margin-bottom: 5px;">å·²ç”Ÿæˆçš„ QA Pairs:</div>
                        <div id="rag-qa-pairs-content" style="font-size: 12px;"></div>
                    </div>
                `;
                
                // Helper function to update progress
                const updateRAGProgress = (percent, message) => {
                    const progressBar = document.getElementById('rag-progress-bar');
                    const progressPercent = document.getElementById('rag-progress-percent');
                    const progressMessage = document.getElementById('rag-progress-message');
                    if (progressBar) progressBar.style.width = percent + '%';
                    if (progressPercent) progressPercent.textContent = percent + '%';
                    if (progressMessage) progressMessage.textContent = message;
                };
                
                // Use fetch with streaming response
                const response = await fetch('/api/v1/testset/workflow/generate-rag-testset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let result = null;
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';  // Keep incomplete line in buffer
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                
                                if (data.type === 'start') {
                                    updateRAGProgress(5, data.message || 'é–‹å§‹ç”Ÿæˆ...');
                                    
                                    // Show input files info if available
                                    if (data.selected_files || data.documents_folder) {
                                        const infoDiv = document.getElementById('rag-generation-info');
                                        const infoContent = document.getElementById('rag-generation-info-content');
                                        if (infoDiv && infoContent) {
                                            let infoHtml = '';
                                            if (data.selected_files && data.selected_files.length > 0) {
                                                infoHtml = `
                                                    <p><strong>é¸æ“‡çš„æ–‡ä»¶ï¼ˆ${data.selected_files.length} å€‹ï¼‰ï¼š</strong></p>
                                                    <ul style="margin: 5px 0; padding-left: 20px;">
                                                        ${data.selected_files.map(f => `<li>${f}</li>`).join('')}
                                                    </ul>
                                                `;
                                            } else {
                                                infoHtml = `<p><strong>ä½¿ç”¨æ–‡ä»¶ï¼š</strong>å…¨éƒ¨æ–‡ä»¶</p>`;
                                            }
                                            infoHtml += `
                                                <p><strong>æ–‡ä»¶è³‡æ–™å¤¾ï¼š</strong>${data.documents_folder || 'N/A'}</p>
                                                <p><strong>åˆ†å¡Šå¤§å°ï¼š</strong>${data.chunk_size || 'N/A'}</p>
                                                <p><strong>åˆ†å¡Šé‡ç–Šï¼š</strong>${data.chunk_overlap || 'N/A'}</p>
                                                <p><strong>æ¯å€‹åˆ†å¡Šçš„ QA æ•¸é‡ï¼š</strong>${data.qa_per_chunk || 'N/A'}</p>
                                            `;
                                            infoContent.innerHTML = infoHtml;
                                            infoDiv.style.display = 'block';
                                        }
                                    }
                                } else if (data.type === 'generation_info') {
                                    // Show detailed generation info (files loaded, chunks created)
                                    updateRAGProgress(10, data.message || 'æ–‡ä»¶è¼‰å…¥å®Œæˆ');
                                    
                                    const infoDiv = document.getElementById('rag-generation-info');
                                    const infoContent = document.getElementById('rag-generation-info-content');
                                    if (infoDiv && infoContent) {
                                        let infoHtml = '';
                                        
                                        // Show selected files vs loaded files
                                        if (data.selected_files && data.selected_files.length > 0) {
                                            infoHtml += `
                                                <p><strong>ğŸ“‹ é¸æ“‡çš„æ–‡ä»¶ï¼ˆ${data.selected_files.length} å€‹ï¼‰ï¼š</strong></p>
                                                <ul style="margin: 5px 0; padding-left: 20px; max-height: 80px; overflow-y: auto;">
                                                    ${data.selected_files.map(f => `<li>${f}</li>`).join('')}
                                                </ul>
                                            `;
                                        }
                                        
                                        // Show successfully loaded files
                                        if (data.loaded_files && data.loaded_files.length > 0) {
                                            infoHtml += `
                                                <p style="color: #4caf50; margin-top: 10px;"><strong>âœ… å·²è¼‰å…¥æ–‡ä»¶ï¼ˆ${data.total_files || data.loaded_files.length} å€‹ï¼‰ï¼š</strong></p>
                                                <ul style="margin: 5px 0; padding-left: 20px; max-height: 100px; overflow-y: auto; color: #4caf50;">
                                                    ${data.loaded_files.map(f => `<li>${f}</li>`).join('')}
                                                </ul>
                                            `;
                                        }
                                        
                                        // Show failed files if any
                                        if (data.failed_files && data.failed_files.length > 0) {
                                            infoHtml += `
                                                <p style="color: #d32f2f; margin-top: 10px;"><strong>âŒ è¼‰å…¥å¤±æ•—çš„æ–‡ä»¶ï¼ˆ${data.failed_files.length} å€‹ï¼‰ï¼š</strong></p>
                                                <ul style="margin: 5px 0; padding-left: 20px; max-height: 80px; overflow-y: auto; color: #d32f2f;">
                                                    ${data.failed_files.map(f => `<li>${f}</li>`).join('')}
                                                </ul>
                                            `;
                                        }
                                        
                                        infoHtml += `
                                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                                                <p><strong>ğŸ“„ åŸå§‹æ–‡ä»¶æ•¸ï¼š</strong>${data.total_documents || 'N/A'}</p>
                                                <p><strong>âœ‚ï¸ åˆ†å¡Šæ•¸é‡ï¼š</strong>${data.total_chunks || 'N/A'}</p>
                                                <p><strong>ğŸ“ åˆ†å¡Šå¤§å°ï¼š</strong>${data.chunk_size || 'N/A'}</p>
                                                <p><strong>ğŸ”„ åˆ†å¡Šé‡ç–Šï¼š</strong>${data.chunk_overlap || 'N/A'}</p>
                                                <p><strong>â“ æ¯å€‹åˆ†å¡Šçš„ QA æ•¸é‡ï¼š</strong>${data.qa_per_chunk || 'N/A'}</p>
                                                ${data.expected_qa_pairs ? `<p><strong>ğŸ¯ é æœŸç”Ÿæˆ QA å°æ•¸ï¼š</strong>ç´„ ${data.expected_qa_pairs} å€‹</p>` : ''}
                                            </div>
                                            <p style="color: #4caf50; font-weight: bold; margin-top: 10px;">âœ… é…ç½®æ­£ç¢ºï¼Œé–‹å§‹ç”Ÿæˆ QA Pairs...</p>
                                        `;
                                        infoContent.innerHTML = infoHtml;
                                        infoDiv.style.display = 'block';
                                    }
                                } else if (data.type === 'qa_pair_generated') {
                                    const progress = data.progress_percent || 0;
                                    const total = data.total_generated || 0;
                                    const chunkProgress = data.chunk_progress || '';
                                    updateRAGProgress(progress, `å·²ç”Ÿæˆ ${total} å€‹ QA Pairs (${chunkProgress})`);
                                    
                                    // Add QA pair to list
                                    const qaContent = document.getElementById('rag-qa-pairs-content');
                                    if (qaContent && data.qa_pair) {
                                        const qaDiv = document.createElement('div');
                                        qaDiv.style.cssText = 'padding: 5px; margin: 3px 0; background: white; border-radius: 3px; border-left: 3px solid #4caf50;';
                                        qaDiv.innerHTML = `
                                            <strong>${data.qa_pair.persona_name || 'Unknown'}</strong>: 
                                            ${data.qa_pair.question || ''}
                                        `;
                                        qaContent.appendChild(qaDiv);
                                        // Auto scroll to bottom
                                        qaContent.parentElement.scrollTop = qaContent.parentElement.scrollHeight;
                                    }
                                } else if (data.type === 'saving_file') {
                                    updateRAGProgress(data.progress_percent || 95, data.message || 'æ­£åœ¨ä¿å­˜æª”æ¡ˆ...');
                                } else if (data.type === 'file_saved') {
                                    updateRAGProgress(100, 'âœ… Excel æª”æ¡ˆå·²ä¿å­˜');
                                } else if (data.type === 'complete') {
                                    result = data;
                                    updateRAGProgress(100, 'âœ… å®Œæˆ');
                                } else if (data.type === 'error') {
                                    throw new Error(data.message || 'ç”Ÿæˆå¤±æ•—');
                                }
                            } catch (e) {
                                console.error('Error parsing SSE data:', e, line);
                            }
                        }
                    }
                }
                
                if (!result) {
                    throw new Error('æœªæ”¶åˆ°å®Œæˆè¨Šæ¯');
                }
                
                if (result.success) {
                    // Store testset path in workflow state
                    workflowState.rag_testset_path = result.excel_path;
                    console.log('Saved RAG testset path:', result.excel_path);
                    
                    // Update result box with final results (keep the progress display)
                    const progressMessage = document.getElementById('rag-progress-message');
                    if (progressMessage) {
                        progressMessage.innerHTML = `
                            <div class="alert alert-success">
                                âœ… æˆåŠŸç”Ÿæˆ QA Pairs Excel æª”æ¡ˆï¼
                            </div>
                            <h3>ç”Ÿæˆçµæœ</h3>
                            <p><strong>Excel æª”æ¡ˆè·¯å¾‘ï¼š</strong>${result.excel_path}</p>
                            <p><strong>ç¸½ QA å°æ•¸ï¼š</strong>${result.total_qa_pairs}</p>
                            <p><strong>æ–‡ä»¶åˆ†å¡Šæ•¸ï¼š</strong>${result.total_chunks}</p>
                            <p><strong>åŸå§‹æ–‡ä»¶æ•¸ï¼š</strong>${result.total_documents}</p>
                            <p><strong>ä½¿ç”¨çš„è§’è‰²æ•¸ï¼š</strong>${result.personas_used || 'N/A'}</p>
                            <p><strong>ç”Ÿæˆæ–¹æ³•ï¼š</strong>${result.method === 'ragas' ? 'RAGAS æ¡†æ¶' : 'LLM ç”Ÿæˆ'}</p>
                            <div class="button-group" style="margin-top: 20px;">
                                <button type="button" class="btn btn-primary" onclick="goToStage(2)" style="padding: 12px 30px; font-size: 16px;">
                                    ğŸš€ ä¸‹ä¸€æ­¥ï¼šåŸºæ–¼ Excel é€²è¡Œå¹³å°è©•ä¼°
                                </button>
                            </div>
                        `;
                    }
                } else {
                    throw new Error(result.detail || result.message || 'ç”Ÿæˆå¤±æ•—');
                }
            } catch (error) {
                const resultBox = document.getElementById('rag-testset-result');
                resultBox.style.display = 'block';
                resultBox.innerHTML = `
                    <div class="alert alert-error">
                        âŒ éŒ¯èª¤ï¼š${error.message}
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.textContent = 'ç”Ÿæˆ QA Pairs Excel';
            }
        }

        // Toggle persona details
        // Persona editing functions
        function togglePersonaEdit(index) {
            const editDiv = document.getElementById(`persona-edit-${index}`);
            const detailsDiv = document.getElementById(`persona-details-${index}`);
            const summaryDiv = document.getElementById(`persona-summary-${index}`);
            const editBtn = document.getElementById(`edit-btn-${index}`);
            
            if (editDiv && editDiv.style.display === 'none') {
                editDiv.style.display = 'block';
                if (detailsDiv) detailsDiv.style.display = 'none';
                if (summaryDiv) summaryDiv.style.display = 'none';
                if (editBtn) editBtn.textContent = 'å–æ¶ˆç·¨è¼¯';
            } else if (editDiv) {
                editDiv.style.display = 'none';
                if (summaryDiv) summaryDiv.style.display = 'block';
                if (editBtn) editBtn.textContent = 'ç·¨è¼¯';
            }
        }
        
        async function savePersonaEdit(index) {
            try {
                const jsonText = document.getElementById(`persona-json-${index}`).value;
                const updatedPersona = JSON.parse(jsonText);
                
                // Update workflowState
                if (workflowState.personas && workflowState.personas[index]) {
                    workflowState.personas[index] = updatedPersona;
                }
                
                // Update display
                const personaNameEl = document.getElementById(`persona-name-${index}`);
                if (personaNameEl) personaNameEl.textContent = updatedPersona.persona_name || updatedPersona.persona_id;
                
                const ageEl = document.getElementById(`persona-age-${index}`);
                if (ageEl && updatedPersona.basic_info) ageEl.textContent = updatedPersona.basic_info.age || 'N/A';
                
                const occupationEl = document.getElementById(`persona-occupation-${index}`);
                if (occupationEl && updatedPersona.basic_info) occupationEl.textContent = updatedPersona.basic_info.occupation || 'N/A';
                
                const locationEl = document.getElementById(`persona-location-${index}`);
                if (locationEl && updatedPersona.basic_info) locationEl.textContent = updatedPersona.basic_info.location || 'N/A';
                
                // Save to file if json_path exists
                if (workflowState.personas_json_path && workflowState.personas) {
                    try {
                        const response = await fetch('/api/v1/testset/workflow/update-personas', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                json_path: workflowState.personas_json_path,
                                personas: workflowState.personas
                            })
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            togglePersonaEdit(index);
                            alert('âœ… è§’è‰²è³‡è¨Šå·²æ›´æ–°ä¸¦ä¿å­˜åˆ°æª”æ¡ˆï¼');
                        } else {
                            throw new Error(result.error || 'ä¿å­˜å¤±æ•—');
                        }
                    } catch (saveError) {
                        console.error('Error saving to file:', saveError);
                        togglePersonaEdit(index);
                        alert('âš ï¸ è§’è‰²è³‡è¨Šå·²æ›´æ–°ï¼Œä½†ä¿å­˜åˆ°æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + saveError.message);
                    }
                } else {
                    togglePersonaEdit(index);
                    alert('âœ… è§’è‰²è³‡è¨Šå·²æ›´æ–°ï¼ï¼ˆå°šæœªä¿å­˜åˆ°æª”æ¡ˆï¼Œå°‡åœ¨ç”Ÿæˆæ¸¬è©¦é›†æ™‚ä¿å­˜ï¼‰');
                }
            } catch (error) {
                alert('âŒ JSON æ ¼å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥è¼¸å…¥å…§å®¹ï¼š' + error.message);
            }
        }
        
        function cancelPersonaEdit(index) {
            if (workflowState.personas && workflowState.personas[index]) {
                const originalPersona = workflowState.personas[index];
                document.getElementById(`persona-json-${index}`).value = JSON.stringify(originalPersona, null, 2);
            }
            togglePersonaEdit(index);
        }
        
        function togglePersonaDetails(index) {
            const detailsDiv = document.getElementById(`persona-details-${index}`);
            const editDiv = document.getElementById(`persona-edit-${index}`);
            const detailsBtn = document.getElementById(`details-btn-${index}`);
            
            if (editDiv && editDiv.style.display !== 'none') {
                editDiv.style.display = 'none';
                const editBtn = document.getElementById(`edit-btn-${index}`);
                if (editBtn) editBtn.textContent = 'ç·¨è¼¯';
            }
            
            if (detailsDiv && detailsDiv.style.display === 'none') {
                detailsDiv.style.display = 'block';
                if (detailsBtn) detailsBtn.textContent = 'éš±è—è©³ç´°';
                
                if (workflowState.personas && workflowState.personas[index]) {
                    const persona = workflowState.personas[index];
                    const preEl = detailsDiv.querySelector('pre');
                    if (preEl) preEl.textContent = JSON.stringify(persona, null, 2);
                }
            } else if (detailsDiv) {
                detailsDiv.style.display = 'none';
                if (detailsBtn) detailsBtn.textContent = 'é¡¯ç¤ºè©³ç´°';
            }
        }
        
        // Legacy function for backward compatibility
        function togglePersonaDetailsOld(personaId) {
            const detailsDiv = document.getElementById(personaId);
            const btn = event.target;
            
            if (detailsDiv.style.display === 'none') {
                detailsDiv.style.display = 'block';
                btn.textContent = 'æ”¶èµ·';
            } else {
                detailsDiv.style.display = 'none';
                btn.textContent = 'é¡¯ç¤ºæ›´å¤š';
            }
        }
        
        // Load output folders for dropdown
        async function loadOutputFolders() {
            try {
                const response = await fetch('/api/v1/testset/workflow/list-output-folders?base_path=/app/outputs');
                const result = await response.json();
                
                const datalist = document.getElementById('output-folder-list');
                if (datalist && result.folders) {
                    datalist.innerHTML = '';
                    result.folders.forEach(folder => {
                        const option = document.createElement('option');
                        option.value = `/app/outputs/${folder}`;
                        datalist.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading output folders:', error);
            }
        }
        
        // Handle output folder input
        function handleOutputFolderInput() {
            const input = document.getElementById('output-folder');
            if (input && !input.value.startsWith('/app/outputs/')) {
                // Auto-prepend /app/outputs/ if not present
                if (!input.value.startsWith('/app/')) {
                    input.value = '/app/outputs/' + input.value.replace(/^\/+/, '');
                }
            }
        }
        
        // Show personas with edit capability
        function showPersonasWithEdit(personas, result) {
            const resultBox = document.getElementById('personas-result');
            if (!resultBox) return;
            
            resultBox.style.display = 'block';
            
            let personaCards = '';
            personas.forEach((persona, index) => {
                const personaId = persona.persona_id || `persona_${index}`;
                personaCards += `
                    <div id="persona-card-${index}" style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #f9f9f9;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="margin: 0; color: #667eea;">
                                <span id="persona-name-${index}">${persona.persona_name || personaId}</span>
                            </h4>
                            <div style="display: flex; gap: 5px;">
                                <button type="button" class="btn btn-secondary" style="font-size: 12px; padding: 5px 10px;" 
                                    onclick="togglePersonaEdit(${index})" id="edit-btn-${index}">
                                    ç·¨è¼¯
                                </button>
                                <button type="button" class="btn btn-secondary" style="font-size: 12px; padding: 5px 10px;" 
                                    onclick="togglePersonaDetails(${index})" id="details-btn-${index}">
                                    é¡¯ç¤ºè©³ç´°
                                </button>
                            </div>
                        </div>
                        <div id="persona-summary-${index}" style="margin-bottom: 10px;">
                            ${persona.basic_info ? `
                                <p style="margin: 5px 0;"><strong>å¹´é½¡ï¼š</strong><span id="persona-age-${index}">${persona.basic_info.age || 'N/A'}</span></p>
                                <p style="margin: 5px 0;"><strong>è·æ¥­ï¼š</strong><span id="persona-occupation-${index}">${persona.basic_info.occupation || 'N/A'}</span></p>
                                <p style="margin: 5px 0;"><strong>å±…ä½åœ°ï¼š</strong><span id="persona-location-${index}">${persona.basic_info.location || 'N/A'}</span></p>
                            ` : ''}
                        </div>
                        <div id="persona-edit-${index}" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                            <textarea id="persona-json-${index}" style="width: 100%; min-height: 300px; font-family: monospace; font-size: 12px; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">${JSON.stringify(persona, null, 2)}</textarea>
                            <div style="margin-top: 10px; display: flex; gap: 10px;">
                                <button type="button" class="btn btn-primary" onclick="savePersonaEdit(${index})">ä¿å­˜</button>
                                <button type="button" class="btn btn-secondary" onclick="cancelPersonaEdit(${index})">å–æ¶ˆ</button>
                            </div>
                        </div>
                        <div id="persona-details-${index}" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                            <pre style="background: white; padding: 10px; border-radius: 4px; font-size: 12px; max-height: 400px; overflow-y: auto;">${JSON.stringify(persona, null, 2)}</pre>
                        </div>
                    </div>
                `;
            });
            
            resultBox.innerHTML = `
                <div class="alert alert-success">
                    âœ… å·²è¼‰å…¥ ${personas.length} å€‹ç”¨æˆ¶è§’è‰²ï¼
                </div>
                <h4 style="margin-top: 20px; margin-bottom: 15px;">æ‰€æœ‰ç”¨æˆ¶è§’è‰²ï¼ˆå…± ${personas.length} å€‹ï¼‰ï¼š</h4>
                <p style="margin-bottom: 15px; color: #666;">æ‚¨å¯ä»¥ç·¨è¼¯æ¯å€‹è§’è‰²çš„è©³ç´°è³‡è¨Šï¼Œç·¨è¼¯å¾Œé»æ“Šã€Œä¿å­˜ã€æŒ‰éˆ•ã€‚</p>
                ${personaCards}
                <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border: 1px solid #ffc107;">
                    <strong>ğŸ’¡ æç¤ºï¼š</strong> ç·¨è¼¯å®Œæˆå¾Œï¼Œè«‹é»æ“Šã€Œä¿å­˜ã€æŒ‰éˆ•ä»¥æ›´æ–°è§’è‰²è³‡è¨Šã€‚æ‰€æœ‰è®Šæ›´å°‡åœ¨ç”Ÿæˆæ¸¬è©¦é›†æ™‚ä½¿ç”¨ã€‚
                </div>
                <div style="margin-top: 30px; padding: 20px; background: #f0f8ff; border-radius: 8px; border: 2px solid #667eea; text-align: center;">
                    <p style="margin-bottom: 15px; font-size: 16px; color: #333;">æº–å‚™å¥½ç”Ÿæˆæ¸¬è©¦é›†äº†å—ï¼Ÿ</p>
                    <div class="button-group" style="display: flex; gap: 15px; justify-content: center;">
                        <button type="button" class="btn btn-primary" onclick="goToStage(1)" style="padding: 12px 30px; font-size: 16px;">
                            ğŸš€ ä¸‹ä¸€æ­¥ï¼šç”Ÿæˆæ¸¬è©¦é›†
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Update check existing button state based on scenario name
        function updateCheckExistingButton() {
            const scenarioName = document.getElementById('scenario-name').value.trim();
            const checkBtn = document.getElementById('check-existing-btn');
            if (checkBtn) {
                if (scenarioName) {
                    checkBtn.disabled = false;
                    checkBtn.title = 'é»æ“Šæª¢æŸ¥å·²æœ‰è³‡æ–™';
                    checkBtn.style.opacity = '1';
                    checkBtn.style.cursor = 'pointer';
                } else {
                    checkBtn.disabled = true;
                    checkBtn.title = 'è«‹å…ˆè¼¸å…¥å°ˆæ¡ˆåç¨±æ‰èƒ½æª¢æŸ¥å·²æœ‰è³‡æ–™';
                    checkBtn.style.opacity = '0.5';
                    checkBtn.style.cursor = 'not-allowed';
                }
            }
        }
        
        // Check for existing personas in the output folder
        async function checkExistingPersonas() {
            const outputFolder = document.getElementById('output-folder').value;
            const scenarioName = document.getElementById('scenario-name').value.trim();
            const infoDiv = document.getElementById('existing-data-info');
            
            if (!outputFolder) {
                alert('è«‹å…ˆè¼¸å…¥è¼¸å‡ºè³‡æ–™å¤¾è·¯å¾‘');
                return;
            }
            
            if (!scenarioName) {
                alert('è«‹å…ˆè¼¸å…¥å°ˆæ¡ˆåç¨±æ‰èƒ½æª¢æŸ¥å·²æœ‰è³‡æ–™');
                document.getElementById('scenario-name').focus();
                return;
            }
            
            infoDiv.innerHTML = '<p>ğŸ” æª¢æŸ¥ä¸­...</p>';
            infoDiv.style.display = 'block';
            
            try {
                const response = await fetch('/api/v1/testset/workflow/check-existing-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        output_folder: outputFolder,
                        scenario_name: scenarioName
                    })
                });
                
                const result = await response.json();
                
                if (result.has_personas && result.has_documents) {
                    // Both personas and documents exist with valid JSON - load and show results
                    workflowState.personas_json_path = result.personas_json_path;
                    workflowState.scenario_name = result.scenario_name || 'existing_scenario';
                    workflowState.output_folder = result.scenario_folder || outputFolder;
                    workflowState.documents_folder = result.documents_folder;
                    
                    // Load personas from JSON
                    try {
                        const personasResponse = await fetch(`/api/v1/testset/workflow/load-personas?json_path=${encodeURIComponent(result.personas_json_path)}`);
                        const personasData = await personasResponse.json();
                        workflowState.personas = personasData.personas || [];
                        workflowState.personas_json_path = result.personas_json_path;  // Store json path for saving
                        
                        // Load documents from metadata JSON
                        let documentsData = null;
                        if (result.documents_metadata_path) {
                            try {
                                const documentsResponse = await fetch(`/api/v1/testset/workflow/load-documents?metadata_path=${encodeURIComponent(result.documents_metadata_path)}`);
                                documentsData = await documentsResponse.json();
                                workflowState.documents = documentsData.documents || [];
                                workflowState.documents_metadata_file = result.documents_metadata_path;
                            } catch (docError) {
                                console.error('Error loading documents:', docError);
                            }
                        }
                        
                        // Show personas with edit capability
                        showPersonasWithEdit(workflowState.personas, result);
                        
                        // Show documents with edit capability if available
                        if (documentsData && documentsData.documents && documentsData.documents.length > 0) {
                            // Create a temporary result object for showDocumentsWithEdit
                            const docResult = {
                                documents_folder: result.documents_folder,
                                metadata_file: result.documents_metadata_path,
                                total_documents: documentsData.total || documentsData.documents.length
                            };
                            // Show documents in a separate section after personas
                            setTimeout(() => {
                                const personasResult = document.getElementById('personas-result');
                                if (personasResult) {
                                    const documentsSection = document.createElement('div');
                                    documentsSection.id = 'existing-documents-section';
                                    documentsSection.style.marginTop = '30px';
                                    personasResult.parentNode.insertBefore(documentsSection, personasResult.nextSibling);
                                    
                                    // Temporarily set documents-result to the new section
                                    const originalResultBox = document.getElementById('documents-result');
                                    documentsSection.id = 'documents-result-temp';
                                    showDocumentsWithEdit(documentsData.documents, docResult);
                                    // Restore original
                                    if (originalResultBox) {
                                        documentsSection.id = 'existing-documents-section';
                                    }
                                }
                            }, 100);
                        }
                        
                        // Show info with option to proceed
                        const documentsInfo = documentsData ? `<p><strong>æ–‡ä»¶æ•¸é‡ï¼š</strong>${documentsData.total || 0}</p>` : '';
                        infoDiv.innerHTML = `
                            <div class="alert alert-success">
                                âœ… ç™¼ç¾å·²å­˜åœ¨çš„å®Œæ•´è³‡æ–™ï¼ˆè§’è‰² + æ–‡ä»¶ï¼‰ï¼
                                <p><strong>è§’è‰²æ•¸é‡ï¼š</strong>${result.total_personas}</p>
                                ${documentsInfo}
                                <p><strong>æƒ…å¢ƒåç¨±ï¼š</strong>${result.scenario_name || 'N/A'}</p>
                                <p><strong>å°ˆæ¡ˆè³‡æ–™å¤¾ï¼š</strong>${result.scenario_folder || result.documents_folder}</p>
                                <p style="margin-top: 10px; color: #666;">å·²è¼‰å…¥è³‡æ–™ï¼Œæ‚¨å¯ä»¥ç·¨è¼¯è§’è‰²æˆ–æ–‡ä»¶ï¼Œæˆ–ç›´æ¥è·³åˆ°ä¸‹ä¸€æ­¥ã€‚</p>
                                <div class="button-group" style="margin-top: 15px; display: flex; gap: 10px;">
                                    <button type="button" class="btn btn-primary" onclick="goToStage(1)" style="flex: 1;">
                                        ğŸš€ ä¸‹ä¸€æ­¥ï¼šç”Ÿæˆæ¸¬è©¦é›†
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('existing-data-info').style.display='none'" style="flex: 1;">
                                        é‡æ–°ç”Ÿæˆ
                                    </button>
                                </div>
                            </div>
                        `;
                        // Ensure the info div is visible
                        infoDiv.style.display = 'block';
                    } catch (error) {
                        console.error('Error loading personas:', error);
                        infoDiv.innerHTML = `
                            <div class="alert alert-error">
                                âŒ è¼‰å…¥è§’è‰²è³‡æ–™å¤±æ•—ï¼š${error.message}
                            </div>
                        `;
                    }
                } else if (result.has_personas) {
                    // Only personas exist (no documents or documents JSON missing)
                    // Use the scenario name from input if provided, otherwise use the detected one
                    const inputScenarioName = document.getElementById('scenario-name').value.trim();
                    workflowState.personas_json_path = result.personas_json_path;
                    workflowState.scenario_name = inputScenarioName || result.scenario_name || 'existing_scenario';
                    workflowState.output_folder = result.scenario_folder || outputFolder;
                    
                    // Load personas from JSON
                    try {
                        const personasResponse = await fetch(`/api/v1/testset/workflow/load-personas?json_path=${encodeURIComponent(result.personas_json_path)}`);
                        const personasData = await personasResponse.json();
                        workflowState.personas = personasData.personas || [];
                        workflowState.personas_json_path = result.personas_json_path;  // Store json path for saving
                        
                        // Show personas with edit capability
                        showPersonasWithEdit(workflowState.personas, result);
                        
                        const missingDocsMsg = result.has_documents_folder 
                            ? 'æ–‡ä»¶è³‡æ–™å¤¾å­˜åœ¨ä½†ç¼ºå°‘æœ‰æ•ˆçš„ JSON æª”æ¡ˆï¼' 
                            : 'ç¼ºå°‘æ–‡ä»¶è³‡æ–™ï¼';
                        
                        infoDiv.innerHTML = `
                            <div class="alert alert-warning">
                                âš ï¸ ç™¼ç¾å·²å­˜åœ¨çš„è§’è‰²è³‡æ–™ï¼Œä½†${missingDocsMsg}
                                <p><strong>è§’è‰²æ•¸é‡ï¼š</strong>${result.total_personas}</p>
                                <p><strong>æƒ…å¢ƒåç¨±ï¼š</strong>${result.scenario_name || 'N/A'}</p>
                                <p style="margin-top: 10px; color: #666;">å·²è¼‰å…¥è§’è‰²ï¼Œæ‚¨å¯ä»¥ç·¨è¼¯æˆ–ç¹¼çºŒç”Ÿæˆæ–‡ä»¶ã€‚</p>
                                <div class="button-group" style="margin-top: 15px;">
                                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('existing-data-info').style.display='none'">
                                        ç¹¼çºŒç”Ÿæˆæ–‡ä»¶
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        // Hide the personas form since we have existing data
                        const personasForm = document.getElementById('personas-form');
                        if (personasForm) {
                            personasForm.style.display = 'none';
                        }
                    } catch (error) {
                        console.error('Error loading personas:', error);
                        infoDiv.innerHTML = `
                            <div class="alert alert-error">
                                âŒ è¼‰å…¥è§’è‰²è³‡æ–™å¤±æ•—ï¼š${error.message}
                            </div>
                        `;
                    }
                } else {
                    infoDiv.innerHTML = `
                        <div class="alert alert-info">
                            â„¹ï¸ æ­¤è³‡æ–™å¤¾ä¸‹æ²’æœ‰æ‰¾åˆ°å·²å­˜åœ¨çš„è§’è‰²è³‡æ–™ï¼Œæ‚¨å¯ä»¥é–‹å§‹ç”Ÿæˆæ–°çš„è§’è‰²ã€‚
                        </div>
                    `;
                    setTimeout(() => {
                        infoDiv.style.display = 'none';
                    }, 3000);
                }
            } catch (error) {
                infoDiv.innerHTML = `
                    <div class="alert alert-error">
                        âŒ æª¢æŸ¥å¤±æ•—ï¼š${error.message}
                    </div>
                `;
            }
        }
        
        // Load existing data and skip to next stage
        function loadExistingData(personasJsonPath, scenarioName, hasDocuments, documentsFolder) {
            // Update workflow state
            workflowState.personas_json_path = personasJsonPath;
            workflowState.scenario_name = scenarioName;
            workflowState.output_folder = document.getElementById('output-folder').value;
            
            if (hasDocuments && documentsFolder) {
                workflowState.documents_folder = documentsFolder;
                // Validate data integrity before proceeding
                validateDataIntegrity().then(isValid => {
                    if (isValid) {
                        // Skip to workflow selection
                        goToStage(1);
                    } else {
                        alert('è³‡æ–™ä¸å®Œæ•´ï¼Œè«‹é‡æ–°ç”Ÿæˆæˆ–æª¢æŸ¥è³‡æ–™å¤¾');
                    }
                });
            } else {
                alert('æ–‡ä»¶è³‡æ–™ä¸å®Œæ•´ï¼Œè«‹é‡æ–°ç”Ÿæˆ');
            }
            
            document.getElementById('existing-data-info').style.display = 'none';
        }
        
        // Auto-generate documents after personas
        async function generateDocumentsAfterPersonas(scenarioName) {
            const statusDiv = document.getElementById('doc-generation-status');
            
            // Add progress bar
            statusDiv.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <strong>æ–‡ä»¶ç”Ÿæˆé€²åº¦</strong>
                        <span id="doc-progress-percent">0%</span>
                    </div>
                    <div style="width: 100%; height: 25px; background: #e0e0e0; border-radius: 12px; overflow: hidden;">
                        <div id="doc-progress-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #f57c00, #ff9800); transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;"></div>
                    </div>
                </div>
                <div id="doc-progress-log" style="background: #f5f5f5; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 14px; max-height: 300px; overflow-y: auto;">
                </div>
            `;
            
            // Helper to add log
            function addDocLog(message, type = 'info') {
                const log = document.getElementById('doc-progress-log');
                if (log) {
                const color = type === 'error' ? '#d32f2f' : type === 'success' ? '#388e3c' : '#1976d2';
                    log.innerHTML += `<div style="color: ${color}; margin-bottom: 5px;">[${new Date().toLocaleTimeString('zh-TW')}] ${message}</div>`;
                    log.scrollTop = log.scrollHeight;
                }
            }
            
            // Progress update helper
            function updateDocProgress(percent, text = '') {
                const bar = document.getElementById('doc-progress-bar');
                const percentText = document.getElementById('doc-progress-percent');
                if (bar && percentText) {
                    bar.style.width = percent + '%';
                    bar.textContent = text || (percent + '%');
                    percentText.textContent = percent + '%';
                }
            }
            
            try {
                const numDocs = parseInt(document.getElementById('num-documents').value);
                
                updateDocProgress(10, 'åˆå§‹åŒ–...');
                addDocLog('ğŸ“„ é–‹å§‹ç”Ÿæˆæƒ…å¢ƒæ–‡ä»¶...');
                addDocLog(`ğŸ“Š æº–å‚™ç”Ÿæˆ ${numDocs} ä»½æ–‡ä»¶...`);
                
                const formData = {
                    scenario_description: workflowState.scenario_description,
                    num_documents: numDocs,
                    output_folder: workflowState.output_folder,
                    scenario_name: workflowState.scenario_name,
                    model_provider: document.getElementById('persona-model-provider').value,
                    model_name: document.getElementById('persona-model-name').value,
                    language: 'ç¹é«”ä¸­æ–‡'
                };
                
                addDocLog(`ğŸ¤– ä½¿ç”¨æ¨¡å‹: ${formData.model_provider}/${formData.model_name}`);
                
                updateDocProgress(30, 'é€£æ¥ API...');
                
                // Simulate progress during API call
                const docProgressInterval = setInterval(() => {
                    const currentBar = document.getElementById('doc-progress-bar');
                    if (currentBar) {
                        const currentWidth = parseFloat(currentBar.style.width) || 30;
                        if (currentWidth < 80) {
                            updateDocProgress(currentWidth + 3, 'ç”Ÿæˆä¸­...');
                        }
                    }
                }, 2000);  // Update every 2 seconds
                
                const response = await fetch('/api/v1/testset/workflow/generate-documents', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                clearInterval(docProgressInterval);
                updateDocProgress(90, 'è™•ç†çµæœ...');
                
                addDocLog('â³ ç­‰å¾… API å›æ‡‰...');
                
                const result = await response.json();
                
                if (result.success) {
                    updateDocProgress(100, 'âœ… å®Œæˆ');
                    addDocLog(`âœ… æˆåŠŸç”Ÿæˆ ${result.total_documents} ä»½æ–‡ä»¶ï¼`, 'success');
                    addDocLog(`ğŸ’¾ ä¿å­˜è‡³: ${result.documents_folder}`);
                    addDocLog('ğŸ‰ æ‰€æœ‰ç”Ÿæˆä»»å‹™å®Œæˆï¼', 'success');
                    
                    workflowState.documents_folder = result.documents_folder;
                    workflowState.documents_metadata_file = result.metadata_file;
                    workflowState.documents = result.documents || result.documents_preview || [];
                    
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // Show documents with edit capability
                    showDocumentsWithEdit(result.documents || result.documents_preview || [], result);
                } else {
                    throw new Error(result.error || 'ç”Ÿæˆå¤±æ•—');
                }
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="alert alert-error">
                        âŒ æ–‡ä»¶ç”Ÿæˆå¤±æ•—ï¼š${error.message}
                    </div>
                    <div class="button-group" style="margin-top: 15px;">
                        <button type="button" class="btn btn-secondary" onclick="location.reload()">
                            é‡æ–°é–‹å§‹
                        </button>
                    </div>
                `;
            }
        }
        
        // Validate data integrity
        async function validateDataIntegrity() {
            try {
                const response = await fetch('/api/v1/testset/workflow/validate-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        output_folder: workflowState.output_folder,
                        scenario_name: workflowState.scenario_name
                    })
                });
                
                const result = await response.json();
                return result.is_valid;
            } catch (error) {
                console.error('Data validation failed:', error);
                return false;
            }
        }
        
        // Check for existing RAG testset
        async function checkExistingRAGTestset() {
            const infoDiv = document.getElementById('rag-existing-testset-info');
            
            if (!workflowState.output_folder) {
                alert('è«‹å…ˆå®Œæˆå‰é¢çš„æ­¥é©Ÿ');
                return;
            }
            
            // scenario_name is auto-generated by backend after persona generation
            // If not set, user needs to generate personas first
            if (!workflowState.scenario_name) {
                alert('è«‹å…ˆå®Œæˆã€Œç”Ÿæˆç”¨æˆ¶è§’è‰²ã€æ­¥é©Ÿ');
                return;
            }
            
            infoDiv.innerHTML = '<p>ğŸ” æª¢æŸ¥ä¸­...</p>';
            infoDiv.style.display = 'block';
            
            try {
                const response = await fetch('/api/v1/testset/workflow/check-existing-testset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        output_folder: workflowState.output_folder,
                        scenario_name: workflowState.scenario_name,
                        testset_type: 'rag'
                    })
                });
                
                const result = await response.json();
                
                if (result.has_testset) {
                    // Store testset path to avoid string escaping issues
                    window._tempRAGTestsetPath = result.testset_path;
                    
                    infoDiv.innerHTML = `
                        <div class="alert alert-success">
                            âœ… ç™¼ç¾å·²å­˜åœ¨çš„ RAG æ¸¬è©¦é›†ï¼
                            <p><strong>æ¸¬è©¦é›†æª”æ¡ˆï¼š</strong>${result.testset_path}</p>
                            <p><strong>QA å°æ•¸ï¼š</strong>${result.total_qa_pairs || 'N/A'}</p>
                            <div class="button-group" style="margin-top: 15px;">
                                <button type="button" class="btn btn-primary" onclick="loadExistingRAGTestset(window._tempRAGTestsetPath)">
                                    è¼‰å…¥æ¸¬è©¦é›†ä¸¦é€²å…¥è©•ä¼°
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="document.getElementById('rag-existing-testset-info').style.display='none'">
                                    é‡æ–°ç”Ÿæˆ
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    infoDiv.innerHTML = `
                        <div class="alert alert-info">
                            â„¹ï¸ æ­¤æƒ…å¢ƒä¸‹æ²’æœ‰æ‰¾åˆ°å·²å­˜åœ¨çš„ RAG æ¸¬è©¦é›†ï¼Œè«‹é–‹å§‹ç”Ÿæˆæ–°çš„æ¸¬è©¦é›†ã€‚
                        </div>
                    `;
                    setTimeout(() => {
                        infoDiv.style.display = 'none';
                    }, 3000);
                }
            } catch (error) {
                infoDiv.innerHTML = `
                    <div class="alert alert-error">
                        âŒ æª¢æŸ¥å¤±æ•—ï¼š${error.message}
                    </div>
                `;
            }
        }
        
        // Load existing RAG testset and go to evaluation
        function loadExistingRAGTestset(testsetPath) {
            workflowState.rag_testset_path = testsetPath;
            workflowState.workflow_type = 'rag'; // Ensure workflow type is set
            console.log('Loaded RAG testset:', testsetPath);
            console.log('Workflow state:', workflowState);
            goToStage(2); // Go to evaluation stage
            document.getElementById('rag-existing-testset-info').style.display = 'none';
        }
        
        // Handle RAG provider change - auto-detect models
        async function onRAGProviderChange() {
            const provider = document.getElementById('rag-model-provider').value;
            
            // Toggle API Key fields
            document.getElementById('rag-openai-key-group').style.display = 'none';
            document.getElementById('rag-gemini-key-group').style.display = 'none';
            document.getElementById('rag-ollama-url-group').style.display = 'none';
            
            if (provider === 'openai') {
                document.getElementById('rag-openai-key-group').style.display = 'block';
            } else if (provider === 'gemini') {
                document.getElementById('rag-gemini-key-group').style.display = 'block';
            } else if (provider === 'ollama') {
                document.getElementById('rag-ollama-url-group').style.display = 'block';
            }
            
            await autoDetectRAGModels();
        }
        
        // Auto-detect available models for RAG testset generation
        async function autoDetectRAGModels() {
            const provider = document.getElementById('rag-model-provider').value;
            const modelSelect = document.getElementById('rag-model-name');
            const hintElement = document.getElementById('rag-model-hint');
            
            // Show loading state
            modelSelect.innerHTML = '<option value="">ğŸ” æ­£åœ¨æª¢æ¸¬å¯ç”¨æ¨¡å‹...</option>';
            modelSelect.disabled = true;
            
            try {
                const response = await fetch('/api/v1/evaluation/judge-models/check-custom', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        openai_api_key: null,
                        gemini_api_key: null,
                        ollama_base_url: null
                    })
                });
                
                const result = await response.json();
                
                // Clear and populate model options
                modelSelect.innerHTML = '';
                
                if (result[provider] && result[provider].length > 0) {
                    result[provider].forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        modelSelect.appendChild(option);
                    });
                    
                    // Set default selection
                    if (provider === 'openai') {
                        modelSelect.value = 'gpt-4o-mini';
                    } else if (provider === 'gemini') {
                        modelSelect.value = result[provider][0];
                    } else if (provider === 'ollama') {
                        modelSelect.value = result[provider][0];
                    }
                    
                    hintElement.textContent = `å·²æª¢æ¸¬åˆ° ${result[provider].length} å€‹å¯ç”¨æ¨¡å‹`;
                } else {
                    modelSelect.innerHTML = '<option value="">âŒ æœªæ‰¾åˆ°å¯ç”¨æ¨¡å‹</option>';
                    hintElement.textContent = 'æœªæ‰¾åˆ°å¯ç”¨æ¨¡å‹ï¼Œè«‹æª¢æŸ¥APIé…ç½®';
                }
                
            } catch (error) {
                console.error('Error detecting RAG models:', error);
                modelSelect.innerHTML = '<option value="">âŒ æª¢æ¸¬å¤±æ•—</option>';
                hintElement.textContent = 'æ¨¡å‹æª¢æ¸¬å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¼¸å…¥æ¨¡å‹åç¨±';
            } finally {
                modelSelect.disabled = false;
            }
        }
        
        // Generate comprehensive performance report
        function generatePerformanceReport(scores, totalTests, testsetPath) {
            const metricsChart = generateMetricsChart(scores);
            const analysis = generatePerformanceAnalysis(scores);
            const improvements = generateImprovementSuggestions(scores);
            
            return {
                metricsChart,
                analysis,
                improvements
            };
        }
        
        // Generate metrics chart
        function generateMetricsChart(scores) {
            let chart = '<div style="display: grid; gap: 15px;">';
            
            for (const [metric, score] of Object.entries(scores)) {
                const percentage = (score * 100).toFixed(2);
                const barWidth = Math.min(percentage, 100);
                const color = score >= 0.8 ? '#4caf50' : score >= 0.6 ? '#ff9800' : '#f44336';
                
                const metricName = getMetricDisplayName(metric);
                
                chart += `
                    <div style="padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; background: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <strong>${metricName}</strong>
                            <span style="font-size: 18px; font-weight: bold; color: ${color};">${percentage}%</span>
                        </div>
                        <div style="height: 8px; background: #f0f0f0; border-radius: 4px; overflow: hidden;">
                            <div style="width: ${barWidth}%; height: 100%; background: ${color}; transition: width 0.3s;"></div>
                        </div>
                    </div>
                `;
            }
            
            chart += '</div>';
            return chart;
        }
        
        // Get display name for metrics
        function getMetricDisplayName(metric) {
            const names = {
                'answer_accuracy': 'Answer Accuracy',
                'factual_correctness': 'Factual Correctness',
                'context_precision': 'Context Precision',
                'context_recall': 'Context Recall',
                'answer_correctness': 'Answer Correctness',
                'faithfulness': 'Faithfulness',
                'answer_relevancy': 'Answer Relevancy',
                'response_relevancy': 'Response Relevancy',
                'f1_score': 'F1 Score (ç¶œåˆæŒ‡æ¨™)'
            };
            return names[metric] || metric;
        }
        
        // Generate performance analysis
        function generatePerformanceAnalysis(scores) {
            const avgScore = Object.values(scores).reduce((a, b) => a + b, 0) / Object.keys(scores).length;
            const lowMetrics = Object.entries(scores).filter(([_, score]) => score < 0.6);
            const highMetrics = Object.entries(scores).filter(([_, score]) => score >= 0.8);
            
            let analysis = `
                <div style="margin-bottom: 15px;">
                    <strong>æ•´é«”è¡¨ç¾ï¼š</strong>${(avgScore * 100).toFixed(1)}% 
                    <span style="color: ${avgScore >= 0.8 ? '#4caf50' : avgScore >= 0.6 ? '#ff9800' : '#f44336'};">
                        ${avgScore >= 0.8 ? 'å„ªç§€' : avgScore >= 0.6 ? 'è‰¯å¥½' : 'éœ€è¦æ”¹é€²'}
                    </span>
                </div>
            `;
            
            if (highMetrics.length > 0) {
                analysis += `
                    <div style="margin-bottom: 10px;">
                        <strong>âœ… è¡¨ç¾å„ªç§€çš„æŒ‡æ¨™ï¼š</strong>
                        ${highMetrics.map(([metric, _]) => getMetricDisplayName(metric)).join(', ')}
                    </div>
                `;
            }
            
            if (lowMetrics.length > 0) {
                analysis += `
                    <div style="margin-bottom: 10px;">
                        <strong>âš ï¸ éœ€è¦é—œæ³¨çš„æŒ‡æ¨™ï¼š</strong>
                        ${lowMetrics.map(([metric, score]) => `${getMetricDisplayName(metric)} (${(score * 100).toFixed(1)}%)`).join(', ')}
                    </div>
                `;
            }
            
            return analysis;
        }
        
        // Generate improvement suggestions
        function generateImprovementSuggestions(scores) {
            let suggestions = '<ul style="margin: 0; padding-left: 20px;">';
            
            if (scores.context_precision < 0.7) {
                suggestions += '<li>èª¿æ•´ <strong>Chunk Size</strong> å’Œ <strong>Overlap</strong> åƒæ•¸ä»¥æé«˜æª¢ç´¢ç²¾ç¢ºåº¦</li>';
            }
            
            if (scores.context_recall < 0.7) {
                suggestions += '<li>å¢åŠ æª¢ç´¢æ•¸é‡æˆ–å„ªåŒ– <strong>æ–‡ä»¶ç›¸ä¼¼åº¦é–€æª»</strong> ä»¥æé«˜å¬å›ç‡</li>';
            }
            
            if (scores.factual_correctness < 0.7) {
                suggestions += '<li>å„ªåŒ– <strong>System Prompt</strong> ä»¥æé«˜äº‹å¯¦æ­£ç¢ºæ€§</li>';
            }
            
            if (scores.answer_accuracy < 0.7) {
                suggestions += '<li>èª¿æ•´ <strong>LLM Temperature</strong> æˆ–æ›´æ›æ›´é©åˆçš„æ¨¡å‹</li>';
            }
            
            if (scores.faithfulness < 0.7) {
                suggestions += '<li>æ”¹å–„ <strong>æª¢ç´¢å“è³ª</strong> å’Œ <strong>æ¨¡å‹é¸æ“‡</strong> ä»¥æ¸›å°‘å¹»è¦º</li>';
            }
            
            suggestions += '<li>å®šæœŸæ›´æ–° <strong>æ¸¬è©¦é›†</strong> ä»¥ç¢ºä¿è©•ä¼°çš„æŒçºŒæœ‰æ•ˆæ€§</li>';
            suggestions += '<li>è€ƒæ…®ä½¿ç”¨ <strong>æ¨¡å‹å¾®èª¿</strong> ä¾†é‡å°ç‰¹å®šé ˜åŸŸå„ªåŒ–</li>';
            
            suggestions += '</ul>';
            return suggestions;
        }
        
        // Download performance report
        function downloadPerformanceReport() {
            // Get the evaluation result content
            const reportDiv = document.getElementById('evaluation-result');
            if (!reportDiv || !reportDiv.innerHTML || reportDiv.innerHTML.trim() === '') {
                alert('æ‰¾ä¸åˆ°æ•ˆèƒ½å ±å‘Šå…§å®¹ï¼Œè«‹å…ˆå®Œæˆè©•ä¼°');
                return;
            }
            
            // Create a comprehensive HTML report
            const reportContent = reportDiv.innerHTML;
            const timestamp = new Date().toLocaleString('zh-TW');
            
            // Create full HTML document
            const htmlContent = `
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG ç³»çµ±æ•ˆèƒ½è©•ä¼°å ±å‘Š</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .report-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        .report-header h1 {
            margin: 0 0 10px 0;
        }
        .report-section {
            background: white;
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }
        .score-bar {
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }
        .score-fill {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        .score-high { background: linear-gradient(90deg, #4caf50, #8bc34a); }
        .score-medium { background: linear-gradient(90deg, #ff9800, #ffc107); }
        .score-low { background: linear-gradient(90deg, #f44336, #e57373); }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #667eea;
            color: white;
        }
        .footer {
            text-align: center;
            color: #666;
            margin-top: 30px;
            padding: 20px;
            border-top: 2px solid #ddd;
        }
        @media print {
            body { background: white; }
            .report-section { page-break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div class="report-header">
        <h1>ğŸ¯ RAG ç³»çµ±æ•ˆèƒ½è©•ä¼°å ±å‘Š</h1>
        <p>ç”Ÿæˆæ™‚é–“ï¼š${timestamp}</p>
    </div>
    
    ${reportContent}
    
    <div class="footer">
        <p>æ­¤å ±å‘Šç”± LLM Evaluation Hub è‡ªå‹•ç”Ÿæˆ</p>
        <p>Â© 2024 LLM Evaluation Hub. All rights reserved.</p>
    </div>
</body>
</html>`;
            
            // Create a blob and download
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `RAG_Performance_Report_${new Date().getTime()}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Show success message
            alert('âœ… æ•ˆèƒ½å ±å‘Šå·²ä¸‹è¼‰ï¼\n\næ‚¨å¯ä»¥åœ¨ç€è¦½å™¨ä¸­æ‰“é–‹ HTML æ–‡ä»¶æŸ¥çœ‹å®Œæ•´å ±å‘Šï¼Œæˆ–ä½¿ç”¨ç€è¦½å™¨çš„åˆ—å°åŠŸèƒ½è½‰æ›ç‚º PDFã€‚');
        }
        
        // Toggle metric details
        function toggleMetricDetails(metricId) {
            const detailsDiv = document.getElementById(metricId + '-details');
            const button = event.target;
            
            if (detailsDiv.style.display === 'none') {
                detailsDiv.style.display = 'block';
                button.textContent = 'æ”¶èµ·';
            } else {
                detailsDiv.style.display = 'none';
                button.textContent = 'è©³æƒ…';
            }
        }
        
        // Handle persona provider change - auto-detect models
        async function onPersonaProviderChange() {
            const provider = document.getElementById('persona-model-provider').value;
            
            // Toggle API Key fields
            document.getElementById('persona-openai-key-group').style.display = 'none';
            document.getElementById('persona-gemini-key-group').style.display = 'none';
            document.getElementById('persona-ollama-url-group').style.display = 'none';
            
            if (provider === 'openai') {
                document.getElementById('persona-openai-key-group').style.display = 'block';
            } else if (provider === 'gemini') {
                document.getElementById('persona-gemini-key-group').style.display = 'block';
            } else if (provider === 'ollama') {
                document.getElementById('persona-ollama-url-group').style.display = 'block';
            }
            
            await autoDetectPersonaModels();
        }
        
        // Auto-detect available models for persona generation
        async function autoDetectPersonaModels() {
            const provider = document.getElementById('persona-model-provider').value;
            const modelSelect = document.getElementById('persona-model-name');
            const hintElement = document.getElementById('persona-model-hint');
            
            // Show loading state
            modelSelect.innerHTML = '<option value="">ğŸ” æ­£åœ¨æª¢æ¸¬å¯ç”¨æ¨¡å‹...</option>';
            modelSelect.disabled = true;
            
            try {
                const response = await fetch('/api/v1/evaluation/judge-models/check-custom', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        openai_api_key: null,
                        gemini_api_key: null,
                        ollama_base_url: null
                    })
                });
                
                const result = await response.json();
                
                // Clear and populate model options
                modelSelect.innerHTML = '';
                
                if (result[provider] && result[provider].length > 0) {
                    result[provider].forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        modelSelect.appendChild(option);
                    });
                    
                    // Set default selection
                    if (provider === 'openai') {
                        modelSelect.value = 'gpt-4o-mini';
                    } else if (provider === 'gemini') {
                        modelSelect.value = result[provider][0];
                    } else if (provider === 'ollama') {
                        modelSelect.value = result[provider][0];
                    }
                    
                    hintElement.textContent = `å·²æª¢æ¸¬åˆ° ${result[provider].length} å€‹å¯ç”¨æ¨¡å‹`;
                } else {
                    modelSelect.innerHTML = '<option value="">âŒ æœªæ‰¾åˆ°å¯ç”¨æ¨¡å‹</option>';
                    hintElement.textContent = 'æœªæ‰¾åˆ°å¯ç”¨æ¨¡å‹ï¼Œè«‹æª¢æŸ¥APIé…ç½®';
                }
                
            } catch (error) {
                console.error('Error detecting models:', error);
                modelSelect.innerHTML = '<option value="">âŒ æª¢æ¸¬å¤±æ•—</option>';
                hintElement.textContent = 'æ¨¡å‹æª¢æ¸¬å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¼¸å…¥æ¨¡å‹åç¨±';
            } finally {
                modelSelect.disabled = false;
            }
        }
        
        // Handle provider change - toggle API key fields and auto-detect models
        async function onJudgeProviderChange() {
            const provider = document.getElementById('judge-model-provider').value;
            
            // Toggle API Key fields
            document.getElementById('judge-openai-key-group').style.display = 'none';
            document.getElementById('judge-gemini-key-group').style.display = 'none';
            document.getElementById('judge-ollama-url-group').style.display = 'none';
            
            if (provider === 'openai') {
                document.getElementById('judge-openai-key-group').style.display = 'block';
            } else if (provider === 'gemini') {
                document.getElementById('judge-gemini-key-group').style.display = 'block';
            } else if (provider === 'ollama') {
                document.getElementById('judge-ollama-url-group').style.display = 'block';
            }
            
            // Auto-detect models
            await autoDetectJudgeModels();
        }
        
        // Auto-detect available models for selected provider
        async function autoDetectJudgeModels(useEnvKeys = false) {
            const provider = document.getElementById('judge-model-provider').value;
            const modelSelect = document.getElementById('judge-model-name');
            const hintElement = document.getElementById('judge-model-hint');
            
            // Show loading state
            modelSelect.innerHTML = '<option value="">ğŸ” æ­£åœ¨æª¢æ¸¬å¯ç”¨æ¨¡å‹...</option>';
            modelSelect.disabled = true;
            
            try {
                // If useEnvKeys is true, send null to use .env keys
                // Otherwise, use custom keys from input fields
                const requestData = {
                    openai_api_key: useEnvKeys ? null : (document.getElementById('judge-openai-api-key').value || null),
                    gemini_api_key: useEnvKeys ? null : (document.getElementById('judge-gemini-api-key').value || null),
                    ollama_base_url: useEnvKeys ? null : (document.getElementById('judge-ollama-base-url').value || null)
                };
                
                const response = await fetch('/api/v1/evaluation/judge-models/check-custom', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                // Clear options
                modelSelect.innerHTML = '';
                
                // Populate models based on provider
                let models = [];
                let hasError = false;
                
                if (provider === 'openai' && result.openai && result.openai.length > 0) {
                    if (result.openai[0].startsWith('Error:')) {
                        hasError = true;
                        modelSelect.innerHTML = `<option value="">âŒ ${result.openai[0]}</option>`;
                        hintElement.textContent = 'è«‹æª¢æŸ¥ API Key æˆ–ç¶²çµ¡é€£æ¥';
                        hintElement.style.color = '#d32f2f';
                    } else {
                        models = result.openai;
                        hintElement.textContent = 'å·²æª¢æ¸¬åˆ°å¯ç”¨æ¨¡å‹';
                        hintElement.style.color = '';
                    }
                } else if (provider === 'gemini' && result.gemini && result.gemini.length > 0) {
                    if (result.gemini[0].startsWith('Error:')) {
                        hasError = true;
                        modelSelect.innerHTML = `<option value="">âŒ ${result.gemini[0]}</option>`;
                        hintElement.textContent = 'è«‹æª¢æŸ¥ API Key æˆ–ç¶²çµ¡é€£æ¥';
                        hintElement.style.color = '#d32f2f';
                    } else {
                        models = result.gemini;
                        hintElement.textContent = 'Gemini Pro é©åˆå¤§å¤šæ•¸è©•ä¼°ä»»å‹™';
                        hintElement.style.color = '';
                    }
                } else if (provider === 'ollama' && result.ollama && result.ollama.length > 0) {
                    if (result.ollama[0].startsWith('Error:')) {
                        hasError = true;
                        modelSelect.innerHTML = `<option value="">âŒ ${result.ollama[0]}</option>`;
                        hintElement.textContent = 'è«‹ç¢ºèª Ollama æœå‹™æ­£åœ¨é‹è¡Œ';
                        hintElement.style.color = '#d32f2f';
                    } else {
                        models = result.ollama;
                        hintElement.textContent = 'æœ¬åœ°æ¨¡å‹ï¼Œç„¡éœ€ API Key';
                        hintElement.style.color = '';
                    }
                }
                
                // Add models to select
                if (!hasError && models.length > 0) {
                    models.forEach((model, index) => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        modelSelect.appendChild(option);
                    });
                    
                    // Set default selection - prefer gpt-4o-mini for OpenAI
                    if (provider === 'openai' && models.includes('gpt-4o-mini')) {
                        modelSelect.value = 'gpt-4o-mini';
                    } else {
                        modelSelect.value = models[0];
                    }
                } else if (!hasError) {
                    modelSelect.innerHTML = '<option value="">âš ï¸ æœªæª¢æ¸¬åˆ°å¯ç”¨æ¨¡å‹</option>';
                    hintElement.textContent = 'è«‹è¼¸å…¥ API Key å¾Œé‡æ–°é¸æ“‡æä¾›å•†';
                    hintElement.style.color = '#ff9800';
                }
                
            } catch (error) {
                console.error('Error detecting models:', error);
                modelSelect.innerHTML = '<option value="">âŒ æª¢æ¸¬å¤±æ•—</option>';
                hintElement.textContent = `éŒ¯èª¤: ${error.message}`;
                hintElement.style.color = '#d32f2f';
            } finally {
                modelSelect.disabled = false;
            }
        }
        
        // Legacy function for backward compatibility
        function toggleJudgeApiKeyFields() {
            onJudgeProviderChange();
        }
        
        
        // Handle evaluation form submission
        document.getElementById('evaluation-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const btn = document.getElementById('start-evaluation-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> è©•ä¼°ä¸­...';
            
            // Show progress area
            const progressDiv = document.getElementById('evaluation-progress');
            const progressLog = document.getElementById('progress-log');
            progressDiv.style.display = 'block';
            progressLog.innerHTML = '';
            
            // Add log message helper
            function addLog(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString('zh-TW');
                const color = type === 'error' ? '#d32f2f' : type === 'success' ? '#388e3c' : '#1976d2';
                progressLog.innerHTML += `<div style="color: ${color}; margin-bottom: 5px;">[${timestamp}] ${message}</div>`;
                progressLog.scrollTop = progressLog.scrollHeight;
            }
            
            // Progress update helper
            function updateEvalProgress(percent, text = '') {
                const bar = document.getElementById('eval-progress-bar');
                const percentText = document.getElementById('eval-progress-percent');
                if (bar && percentText) {
                    bar.style.width = percent + '%';
                    bar.textContent = text || (percent + '%');
                    percentText.textContent = percent + '%';
                }
            }
            
            try {
                updateEvalProgress(5, 'åˆå§‹åŒ–...');
                // Collect selected metrics
                const metrics = [];
                // Core metrics
                if (document.getElementById('metric-answer-accuracy')?.checked) metrics.push('answer_accuracy');
                if (document.getElementById('metric-factual-correctness')?.checked) metrics.push('factual_correctness');
                if (document.getElementById('metric-context-precision')?.checked) metrics.push('context_precision');
                if (document.getElementById('metric-context-recall')?.checked) metrics.push('context_recall');
                if (document.getElementById('metric-answer-correctness')?.checked) metrics.push('answer_correctness');
                // Advanced metrics
                if (document.getElementById('metric-faithfulness')?.checked) metrics.push('faithfulness');
                if (document.getElementById('metric-answer-relevancy')?.checked) metrics.push('answer_relevancy');
                if (document.getElementById('metric-response-relevancy')?.checked) metrics.push('response_relevancy');
                
                if (metrics.length === 0) {
                    throw new Error('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹è©•ä¼°æŒ‡æ¨™');
                }
                
                updateEvalProgress(10, 'æº–å‚™ä¸­...');
                
                // Determine testset path
                let testsetPath;
                const testsetSource = document.getElementById('testset-source').value;
                
                if (testsetSource === 'custom') {
                    testsetPath = document.getElementById('custom-testset-path').value;
                    if (!testsetPath) {
                        throw new Error('è«‹è¼¸å…¥æˆ–é¸æ“‡æ¸¬è©¦é›†æª”æ¡ˆ');
                    }
                } else {
                    // Use workflow testset
                    testsetPath = workflowState.rag_testset_path;
                    
                    if (!testsetPath) {
                        throw new Error('æ‰¾ä¸åˆ°æ¸¬è©¦é›†ï¼Œè«‹å…ˆç”Ÿæˆæ¸¬è©¦é›†æˆ–é¸æ“‡è‡ªå®šç¾©æ¸¬è©¦é›†');
                    }
                }
                
                console.log('Using testset:', testsetPath);
                console.log('Workflow state:', workflowState);
                
                updateEvalProgress(15, 'è¼‰å…¥æ¸¬è©¦é›†...');
                addLog('ğŸ“‹ æ­£åœ¨è¼‰å…¥æ¸¬è©¦é›†...');
                addLog(`ğŸ“„ æ¸¬è©¦é›†è·¯å¾‘: ${testsetPath}`);
                
                const formData = {
                    testset_path: testsetPath,
                    target_api_url: document.getElementById('target-api-url').value,
                    target_api_method: document.getElementById('target-api-method').value,
                    target_api_key_header: document.getElementById('target-api-key-header').value || null,
                    target_api_key_value: document.getElementById('target-api-key-value').value || null,
                    target_api_question_field: document.getElementById('target-api-question-field').value,
                    target_api_response_field: document.getElementById('target-api-response-field').value,
                    judge_model_provider: document.getElementById('judge-model-provider').value,
                    judge_model_name: document.getElementById('judge-model-name').value,
                    // Custom API Keys for Judge LLM
                    judge_openai_api_key: document.getElementById('judge-openai-api-key').value || null,
                    judge_gemini_api_key: document.getElementById('judge-gemini-api-key').value || null,
                    judge_ollama_base_url: document.getElementById('judge-ollama-base-url').value || null,
                    metrics: metrics,
                    output_folder: workflowState.output_folder,
                    scenario_name: workflowState.scenario_name
                };
                
                updateEvalProgress(5, 'åˆå§‹åŒ–...');
                addLog('ğŸš€ é–‹å§‹è©•ä¼°æµç¨‹...');
                addLog(`ğŸ“Š é¸æ“‡çš„è©•ä¼°æŒ‡æ¨™: ${metrics.join(', ')}`);
                addLog('â° æ³¨æ„ï¼šRAGAS è©•ä¼°å¯èƒ½éœ€è¦è¼ƒé•·æ™‚é–“ï¼Œè«‹è€å¿ƒç­‰å¾…...', 'info');
                
                // Start evaluation (non-blocking)
                const evaluationPromise = fetch('/api/v1/evaluation/workflow/run-evaluation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                // Poll for progress updates
                let sessionId = null;
                let lastProgress = 0;
                let lastMessage = '';
                const progressInterval = setInterval(async () => {
                    try {
                        // Get progress from backend
                        const statusResponse = await fetch('/api/v1/evaluation/progress/current');
                        if (statusResponse.ok) {
                            const progressData = await statusResponse.json();
                            
                            console.log('Progress data:', progressData);
                            
                            if (progressData.status !== 'not_found' && progressData.status !== 'idle' && progressData.total > 0) {
                                // Use actual percentage from backend (don't cap at 95%)
                                const percentage = Math.min(progressData.percentage, 98);
                                updateEvalProgress(percentage, progressData.message || 'è©•ä¼°ä¸­...');
                                
                                // Add log for any message change or significant progress
                                if (progressData.message !== lastMessage) {
                                    addLog(`${progressData.message} (${percentage.toFixed(1)}%)`);
                                    lastMessage = progressData.message;
                                    lastProgress = Math.floor(percentage);
                                } else if (Math.floor(percentage) >= lastProgress + 10) {
                                    addLog(`â³ é€²åº¦æ›´æ–°: ${percentage.toFixed(1)}%`);
                                    lastProgress = Math.floor(percentage);
                                }
                            }
                        }
                    } catch (err) {
                        console.log('Progress poll error:', err);
                    }
                }, 1500);  // Poll every 1.5 seconds for more responsive updates
                
                // Wait for evaluation to complete
                const response = await evaluationPromise;
                
                clearInterval(progressInterval);
                updateEvalProgress(90, 'è™•ç†çµæœ...');
                
                const result = await response.json();
                
                if (result.success) {
                    updateEvalProgress(100, 'âœ… å®Œæˆ');
                    addLog('âœ… è©•ä¼°å®Œæˆï¼', 'success');
                    
                    // Show result
                    const resultBox = document.getElementById('evaluation-result');
                    resultBox.style.display = 'block';
                    
                    // Calculate F1 Score if both Precision and Recall are available
                    let f1Score = null;
                    const precision = result.scores['context_precision'];
                    const recall = result.scores['context_recall'];
                    
                    if (precision !== undefined && recall !== undefined && precision > 0 && recall > 0) {
                        f1Score = 2 * (precision * recall) / (precision + recall);
                        result.scores['f1_score'] = f1Score;
                    }
                    
                    // Generate metrics table
                    let metricsTable = '<table style="width: 100%; border-collapse: collapse; margin-top: 20px;"><thead><tr style="background: #667eea; color: white;"><th style="padding: 12px; text-align: left;">è©•ä¼°æŒ‡æ¨™</th><th style="padding: 12px; text-align: right;">å¾—åˆ†</th></tr></thead><tbody>';
                    
                    for (const [metric, score] of Object.entries(result.scores)) {
                        const percentage = (score * 100).toFixed(2);
                        const barWidth = percentage;
                        
                        // Add special styling for F1 score
                        const isF1 = metric === 'f1_score';
                        const rowStyle = isF1 ? 'border-bottom: 2px solid #667eea; background: #f0f4ff;' : 'border-bottom: 1px solid #ddd;';
                        const metricName = isF1 ? 'ğŸ“Š F1 Score (Precision & Recall ç¶œåˆ)' : metric;
                        
                        metricsTable += `
                            <tr style="${rowStyle}">
                                <td style="padding: 12px; ${isF1 ? 'font-weight: bold;' : ''}">${metricName}</td>
                                <td style="padding: 12px; text-align: right;">
                                    <div style="display: flex; align-items: center; justify-content: flex-end; gap: 10px;">
                                        <div style="flex: 1; max-width: 200px; height: 20px; background: #e0e0e0; border-radius: 10px; overflow: hidden;">
                                            <div style="width: ${barWidth}%; height: 100%; background: ${isF1 ? 'linear-gradient(90deg, #4caf50, #8bc34a)' : 'linear-gradient(90deg, #667eea, #764ba2)'}; transition: width 0.3s;"></div>
                                        </div>
                                        <strong style="${isF1 ? 'color: #4caf50;' : ''}">${percentage}%</strong>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }
                    metricsTable += '</tbody></table>';
                    
                    // Add F1 explanation if calculated
                    let f1Explanation = '';
                    if (f1Score !== null) {
                        f1Explanation = `
                            <div style="margin-top: 15px; padding: 12px; background: #f0f4ff; border-left: 4px solid #667eea; border-radius: 4px;">
                                <strong>ğŸ“Š F1 åˆ†æ•¸èªªæ˜ï¼š</strong><br>
                                F1 = 2 Ã— (Precision Ã— Recall) / (Precision + Recall)<br>
                                = 2 Ã— (${(precision * 100).toFixed(2)}% Ã— ${(recall * 100).toFixed(2)}%) / (${(precision * 100).toFixed(2)}% + ${(recall * 100).toFixed(2)}%)<br>
                                = <strong>${(f1Score * 100).toFixed(2)}%</strong>
                            </div>
                        `;
                    }
                    
                    // Generate comprehensive performance report
                    const performanceReport = generatePerformanceReport(result.scores, result.total_tests, testsetPath);
                    
                    resultBox.innerHTML = `
                        <div class="alert alert-success">
                            âœ… è©•ä¼°å®Œæˆï¼
                        </div>
                        
                        <!-- åŸºæœ¬è³‡è¨Š -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="margin-top: 0; color: #495057;">ğŸ“Š è©•ä¼°æ‘˜è¦</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div><strong>æ¸¬è©¦é›†ï¼š</strong>${testsetPath}</div>
                                <div><strong>ç¸½æ¸¬è©¦æ•¸ï¼š</strong>${result.total_tests}</div>
                                <div><strong>è©•ä¼°æ™‚é–“ï¼š</strong>${result.evaluation_time || 'N/A'}</div>
                                <div><strong>çµæœæª”æ¡ˆï¼š</strong>${result.result_file}</div>
                            </div>
                        </div>
                        
                        <!-- æŒ‡æ¨™å¾—åˆ† -->
                        <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <h3 style="margin-top: 0; color: #495057;">ğŸ“ˆ æŒ‡æ¨™å¾—åˆ†</h3>
                            ${performanceReport.metricsChart}
                        </div>
                        
                        <!-- æ•ˆèƒ½åˆ†æ -->
                        <div style="background: #fff3e0; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="margin-top: 0; color: #e65100;">ğŸ” æ•ˆèƒ½åˆ†æ</h3>
                            ${performanceReport.analysis}
                        </div>
                        
                        <!-- æ”¹é€²å»ºè­° -->
                        <div style="background: #e8f5e8; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="margin-top: 0; color: #2e7d32;">ğŸ’¡ æ”¹é€²å»ºè­°</h3>
                            ${performanceReport.improvements}
                        </div>
                        
                        <!-- æ“ä½œæŒ‰éˆ• -->
                        <div class="button-group" style="margin-top: 30px; text-align: center;">
                            <button type="button" class="btn btn-primary" onclick="downloadEvaluationResult('${result.result_file}')">
                                ğŸ“¥ ä¸‹è¼‰è©•ä¼°å ±å‘Š
                            </button>
                            <button type="button" class="btn btn-success" onclick="downloadPerformanceReport()">
                                ğŸ“Š ä¸‹è¼‰æ•ˆèƒ½å ±å‘Š
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="location.reload()">
                                ğŸ”„ é–‹å§‹æ–°è©•ä¼°
                            </button>
                        </div>
                    `;
                } else {
                    addLog(`âŒ è©•ä¼°å¤±æ•—: ${result.error}`, 'error');
                    throw new Error(result.error || 'è©•ä¼°å¤±æ•—');
                }
            } catch (error) {
                addLog(`âŒ éŒ¯èª¤: ${error.message}`, 'error');
                const resultBox = document.getElementById('evaluation-result');
                resultBox.style.display = 'block';
                resultBox.innerHTML = `
                    <div class="alert alert-error">
                        âŒ éŒ¯èª¤ï¼š${error.message}
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.textContent = 'é–‹å§‹è©•ä¼°';
            }
        });
        
        // Download evaluation result
        function downloadEvaluationResult(filePath) {
            window.open(`/api/v1/evaluation/download?file_path=${encodeURIComponent(filePath)}`, '_blank');
        }
        
        // Toggle testset input
        function toggleTestsetInput() {
            const source = document.getElementById('testset-source').value;
            const customInput = document.getElementById('custom-testset-input');
            customInput.style.display = source === 'custom' ? 'block' : 'none';
        }
        
        // Normalize testset path
        function normalizeTestsetPath() {
            const input = document.getElementById('custom-testset-path');
            if (!input.value) return;
            
            const originalPath = input.value;
            const convertedPath = convertToContainerPath(originalPath);
            
            if (originalPath !== convertedPath) {
                input.value = convertedPath;
                showPathConversionNotification(originalPath, convertedPath);
            }
        }
        
        // Handle testset file selection
        function handleTestsetFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                alert(`å·²é¸æ“‡æª”æ¡ˆï¼š${file.name}`);
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize check existing button state
            updateCheckExistingButton();
            // Load output folders on page load
            loadOutputFolders();
            // Auto-detect models for default provider (OpenAI) using .env keys
            setTimeout(() => {
                autoDetectJudgeModels(true);  // true = use .env keys
                autoDetectPersonaModels();     // Auto-detect persona models
                autoDetectRAGModels();          // Auto-detect RAG models
                
                // Show OpenAI API Key group by default for all stages
                document.getElementById('persona-openai-key-group').style.display = 'block';
                document.getElementById('rag-openai-key-group').style.display = 'block';
                document.getElementById('judge-openai-key-group').style.display = 'block';
            }, 500);
        });
    </script>
</body>
</html>

